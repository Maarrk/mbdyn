% $Header$
% MBDyn (C) is a multibody analysis code.
% http://www.mbdyn.org
%
% Copyright (C) 1996-2010
%
% Pierangelo Masarati  <masarati@aero.polimi.it>
%
% Dipartimento di Ingegneria Aerospaziale - Politecnico di Milano
% via La Masa, 34 - 20156 Milano, Italy
% http://www.aero.polimi.it
%
% Changing this copyright notice is forbidden.
%
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation (version 2 of the License).
% 
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

\chapter{NetCDF Output Format}
\label{sec:NETCDF}

\emph{NetCDF support has been initially contributed by Patrick Rix.}

NetCDF is a format to efficiently store and retrieve data to and from
a database on file in a portable, platform-independent manner.
Further details can be found at
\begin{quote}
\htmladdnormallink{\texttt{http://www.unidata.ucar.edu/software/netcdf/}}{http://www.unidata.ucar.edu/software/netcdf/}
\end{quote}
and in \cite{NETCDF-UM}.
The link reported above also describes some of the common tools
that can be used to read and manipulate the contents of the database.

The output in NetCDF format consists in a single binary file
written by the NetCDF library and intended to be read by tools
exploiting the library itself.
This document does not describe the details of NetCDF low-level format,
since this is not intended to be accessed directly by MBDyn users.
Interested readers can consult the specific documentation \cite{NETCDF-UM}.

The output in NetCDF format is a work-in-progress, so it may be sujected
to changes during the development of MBDyn.
This chapter is intended to document its current status,
so it may be incomplete, and occasionally outdated as well.



\section{NetCDF Output}

Following the convention of NetCDF data, each datum is defined
by a variable, whose name indicates the type of datum and the entity
that generated it, organized in a tree-like fashion.

For example, the vector containing the three components 
of the position of the \kw{structural} node labeled \nt{label} is
%\begin{verbatim}
\begin{Verbatim}[commandchars=\\\{\}]
    \kw{node.struct.}\bnt{label}\kw{.X}
\end{Verbatim}
%\end{verbatim}
Each variable usually has few attributes:
\begin{itemize}
\item a \kw{description} is usually given;
\item the \kw{units} are specified, unless variables are non-dimensional;
\item the \kw{type} is specified, if relevant;
it contains the name of the C/C++ structure the data was taken from.
\end{itemize}

Each level contains some datum that is intended to make the contents
of the database as self-explanatory as possible.
For example, the level \kw{node} contains an array whose values
are the strings indicating the node types available;
each level \kw{node.}\bnt{type} contains the labels of the available nodes
for that type, and so on.



\subsection{Base Level}
Currently, the following basic levels are available:
\begin{itemize}
\item \kw{run}, for general simulation-related data;
\item \kw{node}, for nodes;
\item \kw{elem}, for elements.
\end{itemize}



\subsection{Run Level}
There is no variable \kw{run}, with the name of the run level.
This level contains general, simulation-related data:
\begin{itemize}
\item \kw{run.step}, the step number;
\item \kw{time} (previously \kw{run.time}), the value of the time;
\item \kw{run.timestep}, the value of the timestep.
\end{itemize}
Note: the \kw{run.time} variable has been renamed \kw{time}
because many NetCDF manipulation tools automatically recognize
this name as the ordering variable for the rest of the data.



\subsection{Node Level}
There is no variable \kw{node}, with the name of the node level.
This level contains as many sublevels as the node types
that are present in the model.
Each node type consists in a variable that contains an array
with the labels (integers) of the nodes defined for that type.
A variable named \kw{node.}\texttt{\bnt{type}.\bnt{label}} may be present
(it is, for example, for \kw{structural nodes}); however, useful data is usually
contained in specific variables, whose names describe the contents.

Currently supported node types are:
\begin{itemize}
\item Structural nodes, indicated as \kw{struct}.
\end{itemize}



\subsubsection{Structural Node}
\label{sec:NetCDF:Node:Structural Node}
The following variables are defined.
\begin{itemize}
\item \kw{node.struct.}\bnt{label} is actually empty;
it contains the type of the structural node in the \kw{type} attribute;

\item \kw{node.struct.}\bnt{label}\kw{.X} contains the position of the node,
in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.R} contains the orientation matrix of the node,
in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.Phi} contains the orientation vector
describing the orientation of the node, in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.E} contains the Euler angles
describing the orientation of the node, in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.XP} contains the velocity
of the node, in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.Omega} contains the angular velocity
of the node, in the appropriate reference frame.
\end{itemize}
Note that only one of \kw{R}, \kw{Phi}, or \kw{E} are present,
depending on the requested description of the orientation of the node
(see
\hyperref{\kw{structural node}}{\kw{structural node}, Section~}{}{sec:NODE:STRUCTURAL},
and
\hyperref{\kw{default orientation}}{\kw{default orientation}, Section~}{}{sec:CONTROLDATA:DEFAULTORIENTATION}).

The \kw{dynamic} and \kw{modal} node types, if requested, can output
extra variables.
\begin{itemize}
\item \kw{node.struct.}\bnt{label}\kw{.XPP} contains the acceleration of the node,
in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.OmegaP} contains the angular acceleration
of the node, in the appropriate reference frame.
\end{itemize}

If requested, the inertia associated to \kw{dynamic} nodes is output
within the namespace of the node, although actually handled
by the corresponding \kw{automatic structural} element.
As a consequence, extra variables can appear in the output
of \kw{dynamic} nodes.
\begin{itemize}
\item \kw{node.struct.}\bnt{label}\kw{.B} contains the momentum of the inertia
associated to the node, in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.G} contains the momenta moment of the inertia
associated to the node, in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.BP} contains the derivative of the momentum
of the inertia associated to the node, in the appropriate reference frame;

\item \kw{node.struct.}\bnt{label}\kw{.GP} contains the derivative of momenta moment
of the inertia associated to the node, in the appropriate reference frame.
\end{itemize}


\subsection{Element Level}
There is no variable \kw{elem}, with the name of the element level.
This level contains as many sublevels as the element types
that are present in the model.
Each element type consists in a variable that contains an array
with the labels (integers) of the elements defined for that type.
A variable named \kw{elem.}\texttt{\bnt{type}.\bnt{label}} may be present; however,
useful data is usually contained in specific variables,
whose names describe the contents.

Currently supported element types are:
\begin{itemize}
\item Automatic structural elements, indicated as \kw{autostruct}.
\item Beam elements, indicated as \kw{beam2} and \kw{beam3}
for 2- and 3-node beam elements, respectively.
\end{itemize}


\subsubsection{Aerodynamic Elements}
\label{sec:NetCDF:Elem:Aerodynamic}
\emph{NetCDF output of aerodynamic elements has been sponsored
by REpower Systems AG.}

The aerodynamic elements allow to define a broad set of variables.
Values are output at the integration points.
Each element allows to define $n$ integration points.
The \kw{aerodynamic body} outputs at $n$ points.
The \kw{aerodynamic beam2} outputs at $2 \cdot n$ points.
The \kw{aerodynamic beam3} outputs at $3 \cdot n$ points.

\paragraph{Output.}
\begin{itemize}
\item \kw{elem.aerodynamic.}\bnt{label}\kw{.X\_}\bnt{i} contains the location
of the integration point \nt{i}, in the global reference frame;

\item \kw{elem.aerodynamic.}\bnt{label}\kw{.R\_}\bnt{i} contains the orientation matrix
of the airfoil at the integration point \nt{i}, in the global reference frame;

\item \kw{elem.aerodynamic.}\bnt{label}\kw{.Phi\_}\bnt{i} contains the rotation vector
that describes the orientation of the airfoil at the integration point \nt{i},
in the global reference frame;

\item \kw{elem.aerodynamic.}\bnt{label}\kw{.E\_}\bnt{i} contains the set of Euler angles
that describes the orientation of the airfoil at the integration point \nt{i},
in the global reference frame.
The sequence of the angles is detailed in the variable's description.
It can be 123 (the default), 313 or 321;

\item \kw{elem.aerodynamic.}\bnt{label}\kw{.V\_}\bnt{i} contains the velocity
of the integration point \nt{i}, in the global reference frame;

\item \kw{elem.aerodynamic.}\bnt{label}\kw{.Omega\_}\bnt{i} contains the angular velocity
of the integration point \nt{i}, in the global reference frame;

\item \kw{elem.aerodynamic.}\bnt{label}\kw{.F\_}\bnt{i} contains the force
at the integration point \nt{i}, in the absolute reference frame;

\item \kw{elem.aerodynamic.}\bnt{label}\kw{.M\_}\bnt{i} contains the moment
at the integration point \nt{i}, in the absolute reference frame,
referred to the location of the integration point.
\end{itemize}

Note: variables \kw{R\_}\bnt{i}, \kw{Phi\_}\bnt{i} and \kw{E\_}\bnt{i}
are mutually exclusive.

Note: by default, only variables \kw{elem.aerodynamic.}\bnt{label}\kw{.F\_}\bnt{i}
and \kw{elem.aerodynamic.}\bnt{label}\kw{.M\_}\bnt{i} are output.
See Section~\ref{sec:EL:AERO:BODY-BEAM23} for indications
about how to customize aerodynamic element output in NetCDF format.


\subsubsection{Automatic Structural}
\label{sec:NetCDF:Elem:Automatic Structural}
No variables are explicitly defined for the automatic structural
element; on the contrary, their specific data, if requested,
is appended to the corresponding dynamic structural node.


\subsubsection{Beam}
\label{sec:NetCDF:Elem:Beam}

The beam elements allow to define a broad set of variables.

\paragraph{Two-Node Beam Element.}
The two-node beam element allows to define the variables
\begin{itemize}
\item \kw{elem.beam.}\bnt{label}\kw{.X} contains the location
of the evaluation point, in the global reference frame;

\item \kw{elem.beam.}\bnt{label}\kw{.R} contains the orientation matrix
of the beam section at the evaluation point, in the global reference frame;

\item \kw{elem.beam.}\bnt{label}\kw{.Phi} contains the rotation vector
that describes the orientation of the beam section at the evaluation point,
in the global reference frame;

\item \kw{elem.beam.}\bnt{label}\kw{.E} contains the set of Euler angles
that describes the orientation of the beam section at the evaluation point,
in the global reference frame.
The sequence of the angles is detailed in the variable's description.
It can be 123 (the default), 313 or 321;

\item \kw{elem.beam.}\bnt{label}\kw{.F} contains the internal force
at the evaluation point, in the reference frame of the beam section;

\item \kw{elem.beam.}\bnt{label}\kw{.M} contains the internal moment
at the evaluation point, in the reference frame of the beam section;

\item \kw{elem.beam.}\bnt{label}\kw{.mu} contains the linear strain
at the evaluation point, in the reference frame of the beam section;

\item \kw{elem.beam.}\bnt{label}\kw{.k} contains the angular strain
at the evaluation point, in the reference frame of the beam section;

\item \kw{elem.beam.}\bnt{label}\kw{.muP} contains the linear strain rate
at the evaluation point, in the reference frame of the beam section;

\item \kw{elem.beam.}\bnt{label}\kw{.kP} contains the angular strain rate
at the evaluation point, in the reference frame of the beam section.
\end{itemize}

Note: variables \kw{R}, \kw{Phi} and \kw{E} are mutually exclusive.

Note: variables \kw{muP} and \kw{kP}
are only available for viscoelastic beam elements.

Note: by default, only variables \kw{F}
and \kw{M} are output.
See Section~\ref{sec:EL:BEAM:BEAM3} for indications
about how to customize beam element output in NetCDF format.

\paragraph{Three-Node Beam Element.}
The three-node beam element allows to define the same set of variables
of the two-node one, postfixed with either \kw{\_I} or \kw{\_II}
to indicate the first (between nodes 1 and 2)
or the second (between nodes 2 and 3)
evaluation point.






\section{Accessing the Database}
The database can be accessed using any of the tools listed at the web site
\begin{quote}
\htmladdnormallink{\texttt{http://www.unidata.ucar.edu/software/netcdf/software.html}}{http://www.unidata.ucar.edu/software/netcdf/software.html}
\end{quote}
(yes, including MBDyn itself\ldots)



\subsection{Octave}
The \texttt{octcdf} package, available from
\begin{quote}
\htmladdnormallink{\texttt{http://ocgmod1.marine.usf.edu/}}{http://ocgmod1.marine.usf.edu/},
\end{quote}
provides a clean interface to using NetCDF databases from within
the popular math environment Octave.
Results from MBDyn can be easily handled once the data structure is known.

To access the database, a handler needs to be obtained by calling
\begin{verbatim}
    octave:1> nc = netcdf('mbdyn_output.nc', 'r');
\end{verbatim}
Variable descriptions are accessed as
\begin{verbatim}
    octave:2> nc{'node.struct.1000.X'}
\end{verbatim}
Their values are accessed as
\begin{verbatim}
    octave:3> nc{'node.struct.1000.X'}(10, 3)
\end{verbatim}
So, for example, the $z$ component of the position of node 1000 can be plot with 
\begin{verbatim}
    octave:4> plot(nc{'run.time'}(:), nc{'node.struct.1000.X'}(:,3))
\end{verbatim}

