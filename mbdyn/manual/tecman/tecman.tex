% MBDyn (C) is a multibody analysis code.
% http://www.mbdyn.org
%
% Copyright (C) 1996-2006
%
% Pierangelo Masarati  <masarati@aero.polimi.it>
%
% Dipartimento di Ingegneria Aerospaziale - Politecnico di Milano
% via La Masa, 34 - 20156 Milano, Italy
% http://www.aero.polimi.it
%
% Changing this copyright notice is forbidden.
%
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation (version 2 of the License).
% 
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

\documentclass[10pt,dvips,fleqn]{report}

%\usepackage[pdftex]{graphicx}
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}
\usepackage{graphicx}
\usepackage{psfrag}
\usepackage{amsmath}
\usepackage{amsfonts}
%\usepackage[dvips,breaklinks=true,colorlinks=false]{hyperref}
\usepackage{html}

\input{stdmacro}
%poor man's bold symbol
\newcommand{\T}[1]{\boldsymbol{#1}}

\begin{document}

\begin{latexonly}
\title{\bf MBDyn Technical Manual \\
Version
\input{../build/version}
}
\author{Pierangelo Masarati \vspace{5mm}\\
    \sc Dipartimento di Ingegneria Aerospaziale \\
    \sc Politecnico di Milano}
\date{\today}
\maketitle
\end{latexonly}

\begin{htmlonly}
\begin{center}
\textbf{\LARGE MBDyn Technical Manual}

\emph{\large Pierangelo Masarati}

\textsc{Dipartimento di Ingegneria Aerospaziale \\ Politecnico di Milano}

\today
\end{center}
\end{htmlonly}




\tableofcontents
\newpage

\chapter{Introduction}
This document describes details about the formulation MBDyn:
Multi-Body Dynamics relies on.

\chapter{Parsing}
In MBDyn there are different levels of parsing.
Input file parsing suffers from a scattered and occasionally outdated design.
The need to preserver backwards compatibility with existing models
restrains from entirely redesign it, although selected improvements
occur over time.

MBDyn provides support for the implementation of new functionalities,
and to parse their input.
Parsing is delegated to a dedicated object, the MBDynParser, which
inherits from the HighParser, a higher-level parsing object 
with bits of MBDyn's syntax built-in in a somewhat modular way.
It exploits the functionalities of the LowParser, a lower-level
parsing object that deals with tokenizing an input stream
based on the expected tokens.
Whenever appropriate (e.g.\ whenever a number is expected),
control is delegated to the MathParser, which allows to parse and evaluate
sequences of mathematical expressions, including variable declaration
and definition.
Variables are saved in a table as soon as they appear, and can be
used by subsequent expressions when the mathematical parser is called again.

The traditional approach to data parsing consists in defining a table
of keywords that are looked up and, based on the corresponding key code,
by executing the appropriate code in a switch-case block.

The code is being gradually moved to a newer approach based on sets
of associative arrays that map keywords to the functional objects
that are used to parse the related items.

Although no significant improvement results in parsing of existing 
data types, this approach allows to register new data types run-time,
e.g.\ from a run-time loaded module, thus easing the extension
and the customization of the code.


\section{HighParser}
\subsection{Traditional Usage}
The \texttt{HighParser} class and its descendants use a \texttt{KeyTable}
object containing a list of legal keywords to return a valid keyword index
when \texttt{HighParser::GetWord()}, and significantly 
\texttt{HighParser::GetDescription()} are invoked.
The \texttt{KeyTable} can be changed during parsing.
\texttt{KeyTable} is a class.
Its constructor takes a pointer to an array of strings and a reference 
to the \texttt{HighParser} object.
The last string in the array must be null.
The \texttt{KeyTable} class constructor keeps track 
of previous \texttt{KeyTable} objects in the \texttt{HighParser}, 
and restores them upon destruction.

The suggested usage inside a stacked call sequence of parsing functions is
\begin{verbatim}
Part *
read_part(HighParser& HP)
{
    /* prepare names */
    enum KeyWord { KEYWORD1, KEYWORD2, KEYWORD_LAST };
    char *key_table_array[] = { "keyword1", "keyword2", 0 };
    /* build KeyTable class */
    KeyTable k(HP, key_table_array);
    Part *returned_object = 0;
    /* parse input */
    do {
        switch (KeyWord(HP.GetWord())) {
        default:
            /* do something... */
            break;
        case KEYWORD1:
            /* ...and build returned_object  */
            return returned_object;
        }
    } while (true);
}

void
read_all(HighParser& HP)
{
    /* prepare names */
    enum KeyWord { KEY1, KEY2, PART, KEY_LAST };
    char *keytable[] = { "key1", "key2", "part", 0 };
    /* build KeyTable class */
    KeyTable k(HP, keytable);
    /* do something */
    Part *part = 0;
    do {
        switch (KeyWord(HP.GetWord())) {
        default:
            /* do something... */
            break;
        case PART:
            /* read part */
            Part *part = read_part(HP);
            break;
        }
    } while (true);
}

\end{verbatim}
Here the \texttt{KeyTable} set by function \texttt{read\_all()} 
is automatically restored after the call to \texttt{read\_part()}; 
\texttt{read\_part()} temporarily changes the \texttt{KeyTable}
used by the parser.

\subsection{Table-Driven Usage}
The table-driven usage is based on defining a functional object 
that is able to parse a data type:
\begin{verbatim}
    class Datum {
    public:
        virtual ~Datum(void) {};
    };

    struct DatumRead {
        virtual ~DatumRead(void) {};
        virtual Datum *Read(MBDynParser &HP) const = 0;
    };
\end{verbatim}
and a container for its descendants:
\begin{verbatim}
    typedef std::string KeyType;
    typedef std::map<KeyType, DatumRead *> DatumMapType;
    DatumMapType DatumMap;
\end{verbatim}
Then, a functional object for each specific datum type is derived from
\texttt{DatumRead} \ldots
\begin{verbatim}
    class MyDatum : public Datum {
        // ...
    public:
        Datum(int);
        // ...
    }

    struct MyDatumRead : public DatumRead {
        Datum *Read(MBDynParser &HP) const {
            return new MyDatum(HP.GetInt());
        };
    };
\end{verbatim}
\ldots and stored exactly once into the associative container by means
of a dedicated helper:
\begin{verbatim}
    bool
    SetDatumRead(KeyType key, DatumRead *rf)
    {
        return DatumMap.insert(DatumMapType::value_type(key, rf)).second;
    }

    // somewhere early in the code ...
    SetDatumRead("mydatum", new MyDatumRead);

    // note: somewhere else later, in the code, place
    for (DatumMapType::iterator i = DatumMap.begin();
        i != DatumMap.end();
        i++)
    {
        delete i->second;
    }
\end{verbatim}
The parsing function is something like
\begin{verbatim}
    Datum *
    ReadDatum(MBDynParser &HP)
    {
        KeyType key(HP.GetStringWithDelims());
        if (key.c_str() == 0) {
            // error ...
            return 0;
        }
        DatumMapType::iterator i = DatumMap.find(key);
        if (i == DatumMap.end()) {
            // error ...
            return 0;
        }
        return i->second->Read(HP);
    }
\end{verbatim}
Only the \texttt{MyDatum} portions need be added for each new datum type;
they can be declared, defined and registered anywhere in the code,
including in run-time loaded modules.

Currently, drives, constitutive laws and scalar functions are handled
according to this scheme; examples are provided
in \texttt{modules/module-drive/},
\texttt{modules/module-constlaw/}
and
\texttt{modules/module-scalarfunc/}.
More types will be reworked accordingly.



\section{LowParser}
... 

\section{MathParser}
...

\chapter{Solvers}
...
\section{Matrix classes}

\section{Sparse matrices}

\section{Linear solvers}
LinearSolver classes wraps linear solvers\\
SolutionManagers classes deals with the solution of linear systems.
They own a pointer to a LinearSolver, where they allocate
the underlying linear solver.
SolutionManager::MatrInitialize() is called
when the structure of the underlying spares matrix changes.
SolutionManager::MatrReset(), is called to delete a factorization.
It usually calls LinearSolver::Reset(). The matrix has to be explicitly
zeroed before a Jacobian matrix assembly.

\section{Non linear solvers}
...
\section{Parallel solver}
\subsection{Partitioning}
\texttt{iTotVertices} is equal to the sum of nodes and elements. 
It is made in this way because we want the partitioner 
to generate a twofold subdivision:
\begin{itemize}
\item a subdivision related to elements; 
this subdivision is done in order to share the computational 
load during the assembly phase;
\item a subdivision related to nodes, 
which is necessary for the solving phase with the substructuring method.
\end{itemize}
Of course this two partitions must be connected, 
so we build created a graph which is made of nodes and elements as vertex. 
The connection between vertices are only between nodes and elements. 
There is no node to node or element to element connection.

\texttt{pVertexWgts} 
contains what we call the computational weight of each entity, 
so nodes have weight null while elements has a weight related to 
the dimension of the submatrix of the Jacobian matrix assembled
by each one of them.

\texttt{pCommWgts} contains the communication weights 
(see metis documentation) which are a measure of the quantity 
of data which needs to be sent if the i-th vertex is part 
of an interface between different partitions. 
This means that nodes have a \texttt{CommWgts} equal to the number 
of dofs while elements have a weight equal to eventual internal dofs of it.


\chapter{Integration}

\begin{itemize}

\item[differential variable:] a variable is declared differential
in \texttt{SimulationEntity::GetDofType()} 
by returning \texttt{DofOrder::DIFFERENTIAL}.
The increment of the value of a differential variable is equal 
to $\Delta x=\texttt{dCoef}\Delta \dot{x}$.
When writing the Jacobian matrix, this must be considered;
as a consequence, for an equation $f=0$ (the residual is $-f$)
the linearization is 
$f_{/\dot{x}}+f_{/x}*\texttt{dCoef})*\Delta \dot{x}=-f$, 
as $\texttt{dCoef}*\Delta \dot{x}=\Delta x$.

\item[algebraic variable:] a variable is declared algebraic
in \texttt{SimulationEntity::GetDofType()}
by returning \texttt{DofOrder::ALGEBRAIC}.
The increment of the value of an algebraic variable is the increment 
of the variable.

\item[differential equation:] an equation is declared differential
in \texttt{SimulationEntity::GetEqType()}
by returning \texttt{DofOrder::DIFFERENTIAL}.
An equation $f=0$ must be declared differential if $f_{/\dot{x}}$ is not null.
The residual is $-f$, and its linearization is:
$\plbr{f_{/\dot{x}}+f_{/x}*\texttt{dCoef}}*\Delta \dot{x}=-f$.

\item[algebraic equation:] an equation is declared algebraic
in \texttt{SimulationEntity::GetEqType()}
by returning \texttt{DofOrder::ALGEBRAIC}.
An equation $f=0$ can be declared algebraic iff $f_{/\dot{x}}$ 
is structurally null (e.g.\ regardless of the values the state may assume) 
and $x$ is not algebraic.
If an equation $f\plbr{x,t}=0$ is declared differential,
the residual is $-f$, and its linearization is:
$f_{/x}*\texttt{dCoef}*\Delta \dot{x}=-f$.
If the equation can be declared algebraic, it can be divided by $\texttt{dCoef}$:
$f/\texttt{dCoef}=0$, with residual $-f/\texttt{dCoef}$,
and linearization $f_{/x}*\Delta \dot{x} = -f/\texttt{dCoef}$.
This helps scaling the equations.
Clearly, this has no sense if $x$ is algebraic,
or if $f_{/\dot{x}} \neq 0$.

\end{itemize}

\section{Nodal rotation}
The rotational gdl unknown during \texttt{AssRes()} and \texttt{AssJac()}
are the increment of (Gibbs-Rodriguez) rotation parameters
with respect to the reference configuration.
Of course the increment of the parameter is
$\Delta \T g=\texttt{dCoef}\Delta \dot{\T g}$.
The increment of angular velocity is 
$\Delta \T \omega = \T G\Delta \dot{\T g}+ \Delta \T G \dot{\T g}-
\T \omega_{ref}\times \T G \Delta \T g$,
where $\T G(\T g)$ is the tensor relating $\T g_\delta$ to $\delta \T g$,
and $\T \omega_{ref}$ is the nodal reference angular velocity (Wref).
We assume $\T G = \T I$ and $\Delta \T G = \T 0$,
so that $\Delta \T \omega = \Delta \dot{\T g}-\T \omega_{ref}\times\Delta \T g$
and so $\Delta \T \omega = \Delta \dot{\T g}-
\T \omega_{ref}\times\Delta \dot{\T g} * \texttt{dCoef}$.


\chapter{Solution Phases}
\section{Initial Assembly}
This phase only involves some of the structural elements.
It is intended to ensure that the initial configuration and velocity 
complies with the constraint equations.
It is not performed if the \texttt{control data} block contains 
the statement \texttt{skip initial joint assembly}.

To allow non-compliant system analysis, the initial configuration 
and velocity can be changed by this phase.
To this purpose, the nodal positions, orientations, velocities
and angular velocities are grounded by dummy springs, acting 
as penalty functions.
The springs can be set on a node basis, and separately 
for configuration and velocity, to allow to selectively enforce 
the initial configuration.

The problem can be stated as follows:
\begin{align}
	\T{k} \T{x} + \T{\Phi}_{/\T{x}}^T \T{\lambda}_{\T{\Phi}} + \T{A}^T \T{\lambda}_{\T{A}}
		& = \T{k} \T{x}_0 + \T{F} \\
	\T{c} \T{v} + \T{\Phi}_{/\T{x}}^T \T{\mu} & = \T{c} \T{v}_0 \\
	\T{\Phi}\plbr{\T{x}, t} & = \T{0} \label{eq:in-ass:holonomic} \\
	\T{A}\plbr{\T{x}, t} \T{v} + \T{B}\plbr{\T{x}, t} & = \T{0} \label{eq:in-ass:non-holonomic} \\
	\T{\Phi}_{/\T{x}} v + \T{\Phi}_{/t} & = \T{0}
\end{align}
where Equation~(\ref{eq:in-ass:holonomic}) and (\ref{eq:in-ass:non-holonomic})
respectively contain the holonomic and non holonomic constraint equations.
The solution of this problem leads to the direct determination
of an initial configuration and velocity that complies 
with the constraints.

Unfortunately, this requires the implementation of more constraints
than required by the regular solution phases, namely the time derivative
of the algebraic constraints that depend only on the configuration.
A new procedure is being considered, which requires only the use 
of the constraint equation $\Phi$ and its Jacobian matrix $\Phi_{/x}$.

The problem that is solved with the new procedure is (FIXME):
\begin{align}
	\T{k} \T{x} + \T{\Phi}_{/\T{x}}^T \T{\lambda}_{\T{\Phi}} + \T{A}^T \T{\lambda}_{\T{A}} 
		& = \T{k} \T{x}_0 + \T{F} \\
	\T{c} \T{v} + \T{A}^T \T{\lambda}_{A} & = \T{c} \T{v}_0 \\
	\T{\Phi}\plbr{\T{x}, t} & = \T{0} \\
	\T{A}\plbr{\T{x}, t} \T{v} + \T{B}\plbr{\T{x}, t} & = \T{0}
\end{align}
so that only the configuration is required to comply 
with the constraint equations, and the same constraint 
Jacobian matrix and residual of the regular steps are required;
then, after convergence, the following equation is considered:
\begin{equation}
	\T{\Phi}_{/\T{x}} \T{v} + \T{\Phi}_{/t} = 0
\end{equation}
which uses the Jacobian matrix of the constraint equations; 
only the derivative of the time-dependent constraints is required.

The number of rows of matrix $\T{\Phi}_{/\T{x}}$ is equal to the number 
of degrees of freedom that are constrained, so typically the matrix 
must be underdetermined.
It can be decomposed as
\begin{equation}
	\T{\Phi}_{/\T{x}}^T = \T{Q} \T{R}
		= \sqbr{\matr{cc}{\T{Q}_1 & \T{Q}_2}}\sqbr{\cvvect{\T{R}_1 \\ \T{0}}}
\end{equation}
so
\begin{equation}
	\T{Q}_1^T \T{v} + \T{R}_1^{-T} \T{\Phi}_{/t} = 0
	\label{eq:in-ass:test}
\end{equation}
becomes a compatibility test for the initial velocities.
There are two possible choices:
\begin{enumerate}
\item the initial configuration assessment fails if the given 
initial velocities, after the correction occurring during the position 
and orientation assessment and correction phase, do not pass 
test~(\ref{eq:in-ass:test});
\item the initial velocities $\T{v}$ are corrected into $\T{v}_c$ 
by projecting them in the space that is compatible with the constraints, 
e.g.:
\begin{equation}
	\T{v}_c = \T{v} - \T{Q}_1 \plbr{\T{Q}_1^T \T{v} + \T{R}_1^{-T}\T{\Phi}_{/t}}
\end{equation}
The initial assembly procedure can be repeated until 
test~(\ref{eq:in-ass:test}) passes.
\end{enumerate}
A consistent implementation of this approach is not available yet;
it requires the availability of the time derivatives 
of the constraint equations, which is an open issue since it is not
well understood what is the physical meaning of knowing 
the time derivatives of a constraint.
Implementation issues are still open as well.



\section{Initial Derivatives}
The so-called ``derivatives'' phase can be thought as computing
the initial value of the highest order derivatives at $t=t_0$
before any iteration starts.
For simplicity, think of an explicit Ordinary Differential Equation
(ODE) problem like
\begin{displaymath}
  \dot{y} = f(y, t)
\end{displaymath}
with the initial value of $t(0) = t_0$ and $y(0) = y_0$; 
then, the computation of $\dot{y}(0)$ is trivial.  
Now, the actual problem is Differential Algebraic (DAE) and implicit, 
i.e. something like
\begin{displaymath}
  F(\dot{y}, y, t) = 0
\end{displaymath}
(actually, it's a bit more complicated, since it's index 3), 
and we still need to compute $\dot{y}(0)$ 
(and the algebraic variables as well, 
which in the above representation are hidden in the $\dot{y}$).
During the regular solution phase (i.e. the Newton iteration) 
we solve a problem of the form
\begin{displaymath}
  F/_{\dot{y}} \Delta \dot{y} + F_{/y} \Delta y = - F
\end{displaymath}
and, according to the integration formula that we're using,
\begin{displaymath}
  \Delta y = \texttt{dCoef} * \Delta \dot{y}
\end{displaymath}
where \texttt{dCoef} is essentially the time step times some number that is specific to the integration formula; it's 1/2 for Crank-Nicholson, it's 2/3 for BDF and so on.
So the real iteration is
\begin{displaymath}
  ( F_{/\dot{y}} + \texttt{dCoef} F_{/y} ) \Delta \dot{y} = - F
\end{displaymath}

To avoid the need to implement a dedicated routine to compute 
the initial value of $\dot{y}$, we iterate over the above reported problem, 
ideally with a time step of $0$, which means that $F_{/y}$ is not considered.  
However, since the problem is differential algebraic, 
matrix $F_{/\dot{y}}$ is structurally singular, so the time step 
must be different from $0$, but small enough to let the correction
\begin{displaymath}
  \Delta y = \texttt{dCoef} * \Delta \dot{y}
\end{displaymath}
be negligible with respect to $\Delta \dot{y}$.  
To conclude, the ``derivatives coefficient'' defined in the input file 
is this ``\texttt{dCoef}'', 
which can be interpreted as the time step of a ``fake'' 
initial step that is used to compute the initial value of 
the highest order derivatives.  
It should be as small as possible, but too small makes 
the problem ill-conditioned (and $0$ makes it structurally singular).  
The default value is usually fine 
(it is rarely needed to set one, unless something 
really strange is going on).\\

\noindent
If the initial derivatives phase requires
more than one iteration  
this may mean that he 
the system is impulsively loaded  with inappropriate 
initial values of states; 
In this case, it is possible to increase the number of iterations, e.g.:
\begin{verbatim}
  derivatives coefficient: 1e-9;
  derivatives tolerance: 1e-6;
  derivatives max iterations: 10; 
\end{verbatim}
\section{Dummy Steps}
\section{Regular Steps}

\chapter{Data Structure}
\section{ExpandableRowVector}
\texttt{ExpandableRowVector} is a class that can be used to
simplify the computation of complex Jacobian matrices.
An \texttt{ExpandableRowVector} is a vector with a given dimension,
and is designed in order to carry the partial derivatives
of a scalar quantity, say $y$, with respect to problem variables.

\noindent
Each element $v_i$ of the \texttt{ExpandableRowVector} $v$ 
is supposed to be set to the partial derivative
of $y$: $v_i = y_{/k_i}$, i.e. \texttt{v.Set($y_{/k_i}$,i)}.
If $k_i$ is a problem variable then you should set also
the index of the variable, \texttt{v.Set($y_{/k_i}$,i,ip)}
of \texttt{v.SetIdx($i$,ip)}. Otherwise, you can
\emph{link} the partial derivatives to another \texttt{ExpandableRowVector}
giving the partial derivatives of $k$ (say $w$): \texttt{v.Set(i,\&w)}.

\noindent
After having built $v$ it is possible to assemble it 
to a particular equation. For example,
\begin{verbatim}
    v.Add(FullSubMatrixHandler& WM,
        const integer eq,
        const doublereal c = 1.) const
\end{verbatim}
is computed in such a way that
\begin{verbatim}
    WM(eq,:) += c*v
\end{verbatim}
with every linked \texttt{ExpandableRowVector} taken in account.

\chapter{Constraints}

\section{Algebraic Constraints}
Consider a holonomic constraint equation of the form
\begin{equation*}
	\T{\Phi}\plbr{\T{q}, t} = 0 
\end{equation*}
Its time derivative and perturbation yields
\begin{eqnarray*}
	\delta\frac{\llk{d}}{\llk{d}t}\plbr{\T{\mu}^T\T{\Phi}} & = &
		\delta\dot{\T{\mu}}^T \T{\Phi}
		+ \delta\T{\Phi}^T \dot{\T{\mu}}
		+ \delta\T{\mu}^T \dot{\T{\Phi}}
		+ \delta\dot{\T{\Phi}}^T \T{\mu} \\
	& = & \delta\dot{\T{\mu}}^T \T{\Phi}
		+ \delta\T{q}^T \T{\Phi}_{/\T{q}}^T \dot{\T{\mu}}
		+ \delta\T{\mu}^T\plbr{
			\T{\Phi}_{/\T{q}} \dot{\T{q}}
			+ \T{\Phi}_{/t}
		} \\
	& & \mbox{} + \plbr{
			\delta\dot{\T{q}}^T \T{\Phi}_{/\T{q}}^T
			+ \delta\T{q}^T \plbr{
				\T{\Phi}_{/\T{q}} \dot{\T{q}}
				+ \T{\Phi}_{/t}
			}_{/\T{q}}^T
		} \T{\mu} \\
	& = & \delta\dot{\T{q}}^T \T{\Phi}_{/\T{q}}^T \T{\mu} \\
	& & \mbox{} + \delta\T{q}^T \plbr{
		\plbr{
			\T{\Phi}_{/\T{q}} \dot{\T{q}}
			+ \T{\Phi}_{/t}
		}_{/\T{q}}^T \T{\mu}
		+ \T{\Phi}_{/\T{q}}^T \dot{\T{\mu}}
	} \\
	& & \mbox{} + \delta\dot{\T{\mu}}^T \T{\Phi} \\
	& & \mbox{} + \delta\T{\mu}^T \plbr{
		\T{\Phi}_{/\T{q}} \dot{\T{q}}
		+ \T{\Phi}_{/t}
	}
\end{eqnarray*}
Its linearization yields
\begin{eqnarray*}
	\Delta\plbr{\delta\frac{\llk{d}}{\llk{d}t}\plbr{\T{\mu}^T\T{\Phi}}}
	& = & \delta\dot{\T{q}}^T \plbr{
		\T{\Phi}_{/\T{q}}^T \Delta\T{\mu}
		+ \plbr{\T{\Phi}_{/\T{q}}^T \T{\mu}}_{/\T{q}} \Delta\T{q}
	} \\
	& & \mbox{} + \delta\T{q}^T \lplbr{
		\plbr{
			\T{\Phi}_{/\T{q}} \dot{\T{q}}
			+ \T{\Phi}_{/t}
		}_{/\T{q}}^T \Delta \T{\mu}
		+ \T{\Phi}_{/\T{q}} \Delta\dot{\T{\mu}}
		+ \plbr{\T{\Phi}_{/\T{q}} \Delta\dot{\T{q}}}_{/\T{q}}^T \T{\mu}
	} \\
	& & \mbox{\hspace{12mm}} + \rplbr{
		\plbr{
			\plbr{
				\T{\Phi}_{/\T{q}} \dot{\T{q}}
				+ \T{\Phi}_{/t}
			}_{/\T{q}}^T \T{\mu}
			+ \T{\Phi}_{/\T{q}}^T \dot{\T{\mu}}
		}_{/\T{q}} \Delta\T{q}
	} \\
	& & \mbox{} + \delta\dot{\T{\mu}}^T \T{\Phi}_{/\T{q}} \Delta\T{q} \\
	& & \mbox{} + \delta\T{\mu}^T \plbr{
		\T{\Phi}_{/\T{q}} \Delta\dot{\T{q}}
		+ \plbr{
			\T{\Phi}_{/\T{q}} \dot{\T{q}}
			+ \T{\Phi}_{/t}
		}_{/\T{q}} \Delta\T{q}
	}
\end{eqnarray*}
An unconstrained problem of the form
\begin{eqnarray*}
	\T{M} \dot{\T{q}} - \T{p} & = & \T{0} \\
	\dot{\T{p}} & = & \T{F}\plbr{\T{q}, \dot{\T{q}}, t}
\end{eqnarray*}
becomes
\begin{eqnarray*}
	\T{M} \dot{\T{q}} - \T{p} + \T{\Phi}_{/\T{q}}^T \T{\mu} & = & \T{0} \\
	\dot{\T{p}} + \plbr{
		\T{\Phi}_{/\T{q}} \dot{\T{q}}
		+ \T{\Phi}_{/t}
	}_{/\T{q}}^T \T{\mu}
	+ \T{\Phi}_{/\T{q}}^T \dot{\T{\mu}} & = & \T{F}\plbr{\T{q}, \dot{\T{q}}, t} \\
	\T{\Phi} & = & \T{0} \\
	\T{\Phi}_{/\T{q}} \dot{\T{q}} + \T{\Phi}_{/t} & = & \T{0}
\end{eqnarray*}
Actually, $\dot{\T{\mu}}$ is independent of $\T{\mu}$;
$\T{\mu}$ by definition is zero if the exact solution is considered.
So $\dot{\T{\mu}}$ is redefined as $\dot{\T{\mu}}=\T{\lambda}$:
\begin{eqnarray*}
	\T{M} \dot{\T{q}} - \T{p} + \T{\Phi}_{/\T{q}}^T \T{\mu} & = & \T{0} \\
	\dot{\T{p}} + \plbr{
		\T{\Phi}_{/\T{q}} \dot{\T{q}}
		+ \T{\Phi}_{/t}
	}_{/\T{q}}^T \T{\mu} + \T{\Phi}_{/\T{q}}^T \T{\lambda}
		& = & \T{F}\plbr{\T{q}, \dot{\T{q}}, t} \\
	\T{\Phi} & = & \T{0} \\
	\T{\Phi}_{/\T{q}} \dot{\T{q}} + \T{\Phi}_{/t} & = & \T{0}
\end{eqnarray*}
If $\T{\mu}=0$ then a conventional DAE of index 3 results, i.e.
\begin{eqnarray*}
	\T{M} \dot{\T{q}} - \T{p} & = & \T{0} \\
	\dot{\T{p}} + \T{\Phi}_{/\T{q}}^T \T{\lambda}
		& = & \T{F}\plbr{\T{q}, \dot{\T{q}}, t} \\
	\T{\Phi} & = & \T{0}
\end{eqnarray*}
while the previous form is known as stabilized index 2 form.
The latter is typically used throughout MBDyn, while the former is used 
in the initial assembly and, occasionally, in specific constraints.

\subsection{Distance Joint}

\subsubsection{Distance Joint Without Offsets}
Definitions
\begin{displaymath}
	u = \frac{1}{d}\plbr{x_2 - x_1}
\end{displaymath}
Limitations
\begin{displaymath}
	d > 0
\end{displaymath}
Constraint Equation
\begin{displaymath}
	d \sqrt{u^T u} = d
\end{displaymath}
Forces
\begin{eqnarray*}
	F_1 & = & \alpha u \\
	F_2 & = & -\alpha u
\end{eqnarray*}
Linearization
\begin{displaymath}
	\sqbr{\matr{ccc}{
		\frac{\alpha}{d}I & -\frac{\alpha}{d}I & -u \\
		-\frac{\alpha}{d}I & \frac{\alpha}{d}I & u \\
		-u^T & u^T & 0
	}}\cubr{\cvvect{
		\delta{x_1} \\
		\delta{x_2} \\
		\delta{\alpha}
	}} = \cubr{\cvvect{
		\alpha u \\
		- \alpha u \\
		d\plbr{1 - \sqrt{u^T u}}
	}}
\end{displaymath}
Constraint Equation Derivative
\begin{displaymath}
	d u^T \dot{u} = 0
\end{displaymath}
Force Derivatives
\begin{eqnarray*}
	\dot{F}_1 & = & \alpha \dot{u} + \dot{\alpha} u \\
	\dot{F}_2 & = & -\alpha \dot{u} - \dot{\alpha} u
\end{eqnarray*}
Linearization
\begin{displaymath}
        \sqbr{\matr{cccccc}{
		\frac{\dot{\alpha}}{d}I & \frac{\alpha}{d}I &
			-\frac{\dot{\alpha}}{d}I & -\frac{\alpha}{d}I &
			-\dot{u} & -u \\
		-\frac{\dot{\alpha}}{d}I & -\frac{\alpha}{d}I &
			\frac{\dot{\alpha}}{d}I & \frac{\alpha}{d}I &
			\dot{u} & u \\
		-\dot{u}^T & -u^T & \dot{u}^T & u^T & 0 & 0
	}}\cubr{\cvvect{
		\delta{x_1} \\
		\delta{\dot{x}_1} \\
		\delta{x_2} \\
		\delta{\dot{x}_2} \\
		\delta{\alpha} \\
		\delta{\dot{\alpha}}
	}} = \cubr{\cvvect{
		\alpha \dot{u} + \dot{\alpha} u \\
		-\alpha \dot{u} - \dot{\alpha} u \\
		d u^T \dot{u}
	}}
\end{displaymath}




\subsubsection{Distance Joint With Offsets}
Definitions:
\begin{displaymath}
	u = \frac{1}{d}\plbr{x_2 + f_2 - x_1 - f_1}
\end{displaymath}
Limitations:
\begin{displaymath}
	d > 0
\end{displaymath}
Constraint equation 
\begin{displaymath}
	d \sqrt{u^T u} = d
\end{displaymath}
Forces:
\begin{eqnarray*}
	F_1 & = & \alpha u \\
	M_1 & = & \alpha f_1 \times u \\
	F_2 & = & -\alpha u \\
	M_2 & = & -\alpha f_2 \times u
\end{eqnarray*}
Linearization:
\begin{displaymath}
	\sqbr{\matr{ccccc}{
		\frac{\alpha}{d}I & -\frac{\alpha}{d}f_1\times{} &
			-\frac{\alpha}{d}I & \frac{\alpha}{d}f_2\times{} & -u \\
		\frac{\alpha}{d}f_1\times{} & 
			-\frac{\alpha}{d}\plbr{f_1 + u}\times{f_1\times{}} &
			-\frac{\alpha}{d}f_1\times{} & 
			\frac{\alpha}{d}f_1\times{f_2\times{}} & 
			-f_1\times{u} \\
		-\frac{\alpha}{d}I & \frac{\alpha}{d}f_1\times{} &
			\frac{\alpha}{d}I & -\frac{\alpha}{d}f_2\times{} & u \\
		-\frac{\alpha}{d}f_2\times{} &
			\frac{\alpha}{d}f_2\times{f_1\times{}} &
			\frac{\alpha}{d}f_2\times{} &
			- \frac{\alpha}{d}\plbr{f_2 - u}\times{f_2\times{}} &
			f_2\times{u} \\
		-u^T & - \plbr{f_1\times{u}}^T & 
			u^T & \plbr{f_2\times{u}}^T & 0
	}}\cubr{\cvvect{
		\delta{x_1} \\
		\delta{g_1} \\
		\delta{x_2} \\
		\delta{g_2} \\
		\delta{\alpha}
	}}
\end{displaymath}
\begin{displaymath}
	\mbox{\hspace{100mm}} = \cubr{\cvvect{
		\alpha u \\
		\alpha f_1\times{u} \\
		-\alpha u \\
		-\alpha f_2\times{u} \\
		d\plbr{1 - \sqrt{u^T u}}
	}}
\end{displaymath}
Constraint Equation Derivative
\begin{displaymath}
	d u^T\dot{u} = 0
\end{displaymath}
Forces:
\begin{eqnarray*}
	\dot{F}_1 & = &  \alpha \dot{u} + \dot{\alpha} u \\
	\dot{M}_1 & = & \alpha \plbr{\omega_1\times{f_1}} \times u 
		+ \alpha f_1 \times \dot{u}
		+ \dot{\alpha} f_1 \times u \\
	\dot{F}_2 & = & -\alpha \dot{u} - \dot{\alpha} u \\
	\dot{M}_2 & = & -\alpha \plbr{\omega_2 \times{f_2}} \times u
		- \alpha f_2 \times \dot{u}
		- \dot{\alpha} f_2 \times u
\end{eqnarray*}
Linearization:





\subsection{Revolute hinge (PlaneHingeJoint)}
Joint data
\begin{displaymath}
\T d_1, \T d_2, \T R_{h1}, \T R_{h2}
\end{displaymath}
where:\\
$\T d_1$, $\T d_2$: offset of nodes 1,2 in node reference;\\
$\T R_{h1}$, $\T R_{h2}$: joint relative orientation wrt. nodes 1,2 (FIXME).\\

\noindent
Constraint equations (normalized by \texttt{dCoef})
\begin{eqnarray*}
	(\T x_1+\T R_1\cdot \T d_1) - (\T x_2+\T R_1\cdot \T d_2)& = & 0 \\
	(\T R_1\cdot \T R_{h1})[3]\cdot (\T R_2\cdot \T R_{h2})[2] & = & 0 \\
	(\T R_1\cdot \T R_{h1})[3]\cdot (\T R_2\cdot \T R_{h2})[1] & = & 0 \\
\end{eqnarray*}
where:\\
$\T x_1$, $\T x_2$: positions of nodes 1,2;\\
$\T R_{1}$, $\T R_{2}$: orientation of nodes 1, 2.\\

\noindent
Residual vector:
\begin{eqnarray*}
	\mathrm{node1\ momentum}:\ 1-3& -= & \T F\\
	\mathrm{node1\ angular\ momentum}:\ 4-6& -= & 
		(\T R_1\cdot \T d_1) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2]\\
	\mathrm{node2\ momentum}:\ 7-9& += & \T F\\
	\mathrm{node2\ angular\ momentum}:\ 10-12& += & 
		(\T R_2\cdot \T d_2) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2]\\
	\mathrm{constraint}:\ 13-15& = &  ((\T x_1+\T R_1\cdot \T d_1) - 
			(\T x_2+\T R_1\cdot \T d_2))/\texttt{dCoef}\\
	\mathrm{constraint}:\ 16& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[2])/\texttt{dCoef}\\
	\mathrm{constraint}:\ 17& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[1])/\texttt{dCoef}\\
\end{eqnarray*}
where:\\
$\T F$: constraint reaction force;\\
$\T M$: constraint moment reaction (third component null).\\

\noindent
Friction:
\begin{itemize}
\item add third component of constraint moment $\T M$
\item add a constraint equation; this could be one of the following:
	\begin{itemize}
	\item direct definition of $\T M[3]$ in function of relative velocity,
		friction coefficient and $\T F$
	\item impose null relative velocity
	\end{itemize}
\item optionally add internal states dynamic $z$ (for friction)
\end{itemize}
\subsubsection{add third component of constraint moment $\T M$}
Residual vector:
\begin{eqnarray*}
	\mathrm{node1\ momentum}:\ 1-3& -= & \T F\\
	\mathrm{node1\ angular\ momentum}:\ 4-6& -= & 
		(\T R_1\cdot \T d_1) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]*\T M[3]\\
	\mathrm{node2\ momentum}:\ 7-9& += & \T F\\
	\mathrm{node2\ angular\ momentum}:\ 10-12& += & 
		(\T R_2\cdot \T d_2) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]*\T M[3]\\
	\mathrm{constraint}:\ 13-15& = &  ((\T x_1+\T R_1\cdot \T d_1) - 
			(\T x_2+\T R_1\cdot \T d_2))/\texttt{dCoef}\\
	\mathrm{constraint}:\ 16& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[2])/\texttt{dCoef}\\
	\mathrm{constraint}:\ 17& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[1])/\texttt{dCoef}\\
	\mathrm{friction:}\ 18& = &  \T M[3] -f(\T F, v, 
			\mathrm{friction\ coef})\\
		& = &  (\mathrm{rel\ velocity})[3]\\
	\mathrm{(optional)\ friction\ states:}\ 19...& = &  \dot{z} - g(z,v)
\end{eqnarray*}
where $v$ is the relative velocity
$v = r * (\T \omega_{1}-\T \omega_{2})\cdot(\T R_1\cdot \T R_{h1})[3]$.
The constraint is based on positions. This means that during integration 
$(\T \omega_{1}-\T \omega_{2})$ will NOT have exactly the
direction $(\T R_1\cdot \T R_{h1})[3]$. We choose to disregard this error.
The friction moment should be along $(\T R_1\cdot \T R_{h1})[3]$.\\
$r$ is the joint radius.\\
CHECK THIS!!!\\
Explicit form of friction moment contribution 
(FIXME: remove vector $(\T R_1\cdot \T R_{h1})[3]$ and write scalar equation???):\\
$f(\T F, \mathrm{rel\ velocity})$:
$\T M[3] = \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * (\T R_1\cdot \T R_{h1})[3] * 
	||\T F|| * f_{\mathrm{c}}(v,z,\dot{z})$,\\
with $\T R_{h1}$ constant.\\
Variation of friction moment contribution:
\begin{eqnarray*}
\delta (\T M[3] (\T R_1\cdot \T R_{h1})[3])
	&=& \T M[3] * (\T R_{\delta 1} \times \T R_1)[3]+\\
	&& (\T R_1\cdot \T R_{h1})[3]) * \delta \T M[3]\\
	&=& \T M[3] * \T R_1^T \cdot (\T R_{\delta 1} \times )[3]+\\
	&& (\T R_1\cdot \T R_{h1})[3]) * \delta \T M[3]
\end{eqnarray*}
Variation of friction moment contribution component:
\begin{eqnarray*}
\delta \T M[3] &=& \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * 
		f_{\mathrm{c}}(v,z,\dot{z}) *
		\frac{\displaystyle\T F}{\displaystyle||\T F||} 
		\cdot \delta \T F+\\
	&& \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * (\T R_1\cdot \T R_{h1})[3] * 
		||\T F|| *
		\frac{\displaystyle \partial f_{\mathrm{c}}}
			{\displaystyle \partial v} * \delta v+\\
	&&	||\T F|| * f_{\mathrm{c}}(v,z,\dot{z}) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
			{\displaystyle \partial ||\T F||} 
			\frac{\displaystyle \partial ||\T F||}{\displaystyle\partial\T F}
			\cdot \delta \T F+\\
	&&	||\T F|| * f_{\mathrm{c}}(v,z,\dot{z}) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
			{\displaystyle \partial f_{\mathrm{c}}(v,z,\dot{z})} *
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial v} * \delta v\\
	&=& \left (\begin{array}{l}
		\mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * 
			f_{\mathrm{c}}(v,z,\dot{z})
			\frac{\displaystyle\T F}{\displaystyle||\T F||}\\
		||\T F|| * f_{\mathrm{c}}(v,z,\dot{z}) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
			{\displaystyle \partial ||\T F||}
		\end{array} 
		\right )\cdot \delta \T F+\\
	&& \left ( \begin{array}{l}
		\mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * ||\T F||\\
		||\T F|| * f_{\mathrm{c}}(v,z,\dot{z}) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
			{\displaystyle \partial f_{\mathrm{c}}(v,z,\dot{z})}
		\end{array} \right ) *
		\left\{\begin{array}{l}
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial v} * \delta v\\
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial z} * \delta z\\
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial \dot{z}} * \delta \dot{z}\\			
		\end{array}\right\}
\end{eqnarray*}
where
\begin{itemize}
\item
$v=r * (\T \omega_{1}-\T \omega_{2})\cdot(\T R_1\cdot \T R_{h1})[3]$
so that
\begin{eqnarray*}
\delta v &=& d * (\T R_1\cdot \T R_{h1})[3] \cdot (\delta \T \omega_{1}- \delta \T \omega_{2}) +\\
	&& d * (\T \omega_{1}-\T \omega_{2})\cdot (\T R_{\delta 1} \times \T R_1 \cdot \T R_{h1})[3]\\
	&=& d * (\T R_1\cdot \T R_{h1})[3] \cdot (\delta \T \omega_{1}- \delta \T \omega_{2}) +\\
	&& d * (\T \omega_{1}-\T \omega_{2})\cdot \T R_{h1}^T \cdot \T R_1^T \cdot (\T R_{\delta 1} \times )[3]
\end{eqnarray*}
\item
$
\mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))=
r * 
C_\alpha(
	\alpha(\mathrm{constants},
		f_{\mathrm{c}}(v,z,\dot{z}),
		||\T F||,
		f_{\mathrm{c}}(v,z,\dot{z})
	)
) 
\frac{\displaystyle 1}{\displaystyle \sqrt{1+f_{\mathrm{c}}^2(v,z,\dot{z})}}
$
\item
$
\alpha(\mathrm{constants},
	f_{\mathrm{c}}(v,z,\dot{z}),
	||\T F||,
	f_{\mathrm{c}}(v,z,\dot{z})
) =
\sin^{-1}\left(
	\sqrt{
		\frac{\displaystyle 2*31*||\T F||}
			{\displaystyle E*b*\sqrt{1+f_{\mathrm{c}}^2(v,z,\dot{z})}}
		\frac{\displaystyle r'/r}
			{\displaystyle r'-r}
	}
\right)
$
\item for very low joint loads (angle of contact $\alpha< 20^{\mathrm{o}}$,
i.e. about less that 1\% of the joint allowable load)
we can safely assume $C_\alpha\approx 1$
so that\\ 
$
\mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))\approx
r * 
\frac{\displaystyle 1}{\displaystyle \sqrt{1+f_{\mathrm{c}}^2(v,z,\dot{z})}}
$,\\

$
\frac{\displaystyle\partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
	{\displaystyle \partial ||\T F||} = \T 0
$\\
and\\
$
\frac{\displaystyle\partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
	{\displaystyle\partial \mathrm{f_{\mathrm{c}}(v,z,\dot{z})}} =
	-r * (1+f_{\mathrm{c}}^2(v,z,\dot{z}))^{-3/2}*f_{\mathrm{c}}(v,z,\dot{z})
$
\end{itemize}




\subsection{Drive Hinge}
This joint forces two nodes to assume a relative orientation
given by a rotation vector $\T{\theta}$, whose direction with respect
to node 1 represents the rotation axis, and whose amplitude represents 
the magnitude of the rotation.

\noindent
Definitions:
\begin{eqnarray*}
	\T{R}_{rel} & = & \T{R}_1^T \T{R}_2 \\
	\T{\theta} & = & \llk{ax}\plbr{\llk{exp}^{-1}\plbr{\T{R}_{rel}}}
\end{eqnarray*}
Limitations:
\begin{displaymath}
	\nrbr{\T{\theta}} < \pi
\end{displaymath}
Constraint equation 
\begin{displaymath}
	\T{\theta} - \T{\theta}_0 = \T{0}
\end{displaymath}
Couples:
\begin{eqnarray*}
	\T{M}_1 & = & -\T{R}_1 \T{\alpha} \\
	\T{M}_2 & = & \T{R}_1 \T{\alpha}
\end{eqnarray*}
Linearization:
\begin{displaymath}
	\sqbr{\matr{ccc}{
		\plbr{\T{R}_1 \T{\alpha}}\times{} & 0 & -\T{R}_1 \\
		-\plbr{\T{R}_1 \T{\alpha}}\times{} & 0 & \T{R}_1 \\
		-\T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T &
			\T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T & 0
	}}\cubr{\cvvect{
		\delta\T{g}_1 \\
		\delta\T{g}_2 \\
		\delta\T{\alpha} \\
	}} = \cubr{\cvvect{
		\T{R}_1 \T{\alpha} \\
		-\T{R}_1 \T{\alpha} \\
		\T{\theta}_0 - \T{\theta}
	}}
\end{displaymath}
The linearization of the reaction moments contribution 
to the moment equilibrium equations of the nodes is straightforward.
The linearization of the constraint equation is a bit more complicated.
According to the definition of $\T{\theta}$, its linearization
yields
\begin{eqnarray*}
	\delta\T{\theta}
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} 
			\llk{ax}\plbr{\delta\T{R}_{rel} \T{R}_{rel}^T} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} \llk{ax}\plbr{
			\delta\T{R}_1^T \T{R}_1
			+ \T{R}_1^T \delta\T{R}_2 \T{R}_2^T \T{R}_1
		} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} \llk{ax}\plbr{
			\T{R}_1^T \T{\theta}_{1\delta}\times{}^T \T{R}_1
			+ \T{R}_1^T \T{\theta}_{2\delta}\times{} \T{R}_1
		} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} \llk{ax}\plbr{
			- \T{R}_1^T \T{\theta}_{1\delta}\times{} \T{R}_1
			+ \T{R}_1^T \T{\theta}_{2\delta}\times{} \T{R}_1
		} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1}
			\llk{ax} \plbr{
				\T{R}_1^T \plbr{
					\T{\theta}_{2\delta}
					- \T{\theta}_{1\delta}
				}\times \T{R}_1
			} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T \plbr{
			\T{\theta}_{2\delta} - \T{\theta}_{1\delta}
		}
\end{eqnarray*}
according to the updated-updated simplifications,
$\T{\theta}_{i\delta}\cong\delta\T{g}_i$, thus resulting in
\begin{equation}
	\T{\theta}_{\delta} = \T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T \plbr{
		\delta\T{g}_2 - \delta\T{g}_1
	}
	\label{eq:DRIVE-HINGE-theta-delta}
\end{equation}
note that $\T{\Gamma}\plbr{\T{\theta}}^{-1}$ does not simplify to $\T{I}$
because $\T{\theta}$ in general is a finite rotation.

%	\delta\T{\theta} = \T{\theta}_0 - \T{\theta}




\subsubsection{Future Development}
The desired relative orientation can be expressed by means of a vector 
$\T{\theta}_0$; the corresponding orientation matrix is
\begin{displaymath}
	\T{R}_0 = \exp\plbr{\T{\theta}_0}
\end{displaymath}
this operation can always be performed with no ambiguity.
The equality
\begin{displaymath}
	\T{\theta} - \T{\theta}_0 = \T{0}
\end{displaymath}
is equivalent to
\begin{displaymath}
	\llk{ax}\plbr{\exp^{-1}\plbr{\T{R}_{rel} \T{R}_0^T}} = \T{0}
\end{displaymath}

\noindent
In general, the difference between the desired rotation
$\T{\theta}_0$ and the current relative orientation between
nodes 1 and 2,
\begin{displaymath}
	\T{\theta} = \llk{ax}\plbr{\exp^{-1}\plbr{
		\T{R}_{1h}^T \T{R}_1^T \T{R}_2 \T{R}_{2h}
	}}
\end{displaymath}
through the previous redefinition can be expressed as
\begin{displaymath}
	\T{\theta}^{\delta} = \llk{ax}\plbr{\exp^{-1}\plbr{
		\T{R}_{1h}^T \T{R}_1^T \T{R}_2 \T{R}_{2h} \T{R}_0^T
	}}
\end{displaymath}
and is equivalent to
\begin{displaymath}
	\T{\theta}^{\delta} = \T{\theta} - \T{\theta}_0
\end{displaymath}
when $\T{\theta}^{\delta}=\T{0}$.
Each component of $\T{\theta}^{\delta}$ can be selectively set
to zero to enforce a constraint on that degree of freedom.
The axis about which the constraint is applied can be arbitrarily 
defined by appropriately setting the constant relative orientation
matrix of each node, $\T{R}_{1h}$ and $\T{R}_{2h}$.
An arbitrary amplitude of the rotation about that axis can be imposed
by means of the components of the imposed vector $\T{\theta}_0$.

\noindent
If any component of $\T{\theta}^{\delta}$ are left free, they are
simply ignored, and the resulting constraint equations are dropped.
Otherwise, they can be used to apply moments based on the 
relative orientation of the nodes, e.g.\ rotational springs or 
dampers.
In this case, the singularity problem comes back: the norm
of the relative orientation must not exceed $\pi$, i.e.\
$\shbr{\T{\theta}^{\delta}}<\pi$.
Note that the relative orientation is computed with respect to 
$\T{\theta}_0$, so an anelastic (or imposed) rotation can be easily
applied to the spring, resulting in an imposed rotation with stiffness.

\noindent
The linearization of the constraint equations is relatively 
straightforward. 
We need to compute the perturbation of $\T{\theta}^{\delta}$, i.e.,
after defining
\begin{displaymath}
	\T{R}^{\delta} = \T{R}_{1h}^T \T{R}_1^T \T{R}_2 \T{R}_{2h} \T{R}_0^T
\end{displaymath}
we obtain
\begin{eqnarray*}
	\T{\theta}^{\delta}_{\delta}
	& = & \llk{ax}\plbr{\delta\T{R}^{\delta} \T{R}^{\delta T}} \\
	& = & \llk{ax}\plbr{\T{R}_{1h}^T \T{R}_1^T
		\plbr{\T{\theta}_{2\delta} - \T{\theta}_{1\delta}}\times{}
		\T{R}_1 \T{R}_{1h}} \\
	& = & \bar{\T{R}}^T\plbr{\T{\theta}_{2\delta} - \T{\theta}_{1\delta}}
\end{eqnarray*}
where $\bar{\T{R}}=\T{R}_1 \T{R}_{1h}$.
Note that, since the constraint equations are defined by setting 
to zero any components of the vector $\T{\theta}^{\delta}$, the
related Jacobian matrix contribution is obtained by selecting 
the corresponding columns of matrix $\bar{\T{R}}$.

\noindent
The relative angular velocity is defined, in analogy with 
the differentiation of $\T{\theta}^{\delta}$, as
\begin{displaymath}
	\T{\omega}^{\delta} = \bar{\T{R}}^T\plbr{\T{\omega}_2 - \T{\omega}_1}
\end{displaymath}
whose differentiation yields
\begin{eqnarray*}
	\delta\T{\omega}^{\delta}
	& = & \bar{\T{R}}^T \plbr{
		\delta\T{\omega}_2
		- \delta\T{\omega}_1
		+ \plbr{\T{\omega}_2 - \T{\omega}_1}\times
			\T{\theta}_{1\delta}
	} \\
	& \cong & \bar{\T{R}}^T \plbr{
		\delta\dot{\T{g}}_2
		- \delta\dot{\T{g}}_1
		- \T{\omega}_2\times\plbr{\delta\T{g}_2 - \delta\T{g}_1}
	}
\end{eqnarray*}
where the simplifications of the updated-updated approach 
have been considered, as indicated by the $\cong$ operator.

\noindent
The couples applied by the constraint equations are
\begin{eqnarray*}
	\T{C}_1 & = & \bar{\T{R}} \T{\alpha} \\
	\T{C}_2 & = & - \bar{\T{R}} \T{\alpha}
\end{eqnarray*}
where $\T{\alpha}$ are the reaction unknowns, which correspond 
to the physical moments in the relative reference frame.
The matrix $\bar{\T{R}}$ reduces to the subset of its columns 
that are related to the actual constrains; any relative orientation 
component that is left free results in no reaction couple.

\noindent
If rotational springs or dampers are defined, the corresponding
couples have the same form, i.e.\
\begin{eqnarray*}
	\T{C}_1 & = & \bar{\T{R}} \T{\beta} \\
	\T{C}_2 & = & - \bar{\T{R}} \T{\beta}
\end{eqnarray*}
now $\T{\beta}=\T{\beta}\plbr{\T{\theta}^{\delta},\T{\omega}^{\delta}}$ 
is a relative orientation dependent couple, and no constraint equation
is related to it.

The linearization of the couples is straightforward; with respect
to the kinematic constraints:
\begin{eqnarray*}
	\delta\T{C}_1 & = &
	\plbr{\bar{\T{R}} \T{\alpha}}\times\T{\theta}_{1\delta}
	+ \bar{\T{R}} \delta\T{\alpha} \\
	\delta\T{C}_2 & = &
	- \plbr{\bar{\T{R}} \T{\alpha}}\times\T{\theta}_{1\delta}
	- \bar{\T{R}} \delta\T{\alpha}
\end{eqnarray*}
and with respect to the spring and damper constraints:
\begin{eqnarray*}
	\delta\T{C}_1 & = &
	\plbr{\bar{\T{R}} \T{\beta}}\times\T{\theta}_{1\delta}
	+ \bar{\T{R}}\T{\beta}_{/\T{\theta}} \T{\theta}^{\delta}_{\delta}
	+ \bar{\T{R}}\T{\beta}_{/\T{\omega}} \delta\T{\omega}^{\delta} \\
	\delta\T{C}_2 & = &
	- \plbr{\bar{\T{R}} \T{\beta}}\times\T{\theta}_{1\delta}
	- \bar{\T{R}}\T{\beta}_{/\T{\theta}} \T{\theta}^{\delta}_{\delta}
	- \bar{\T{R}}\T{\beta}_{/\T{\omega}} \delta\T{\omega}^{\delta}
\end{eqnarray*}

\noindent
The Jacobian matrix and the residual that results from the linearization
of the constraint equations and of the couples, considering
the simplifications related to the updated-updated approach,
are summarized below:
\begin{displaymath}
	\sqbr{\matr{ccc}{
	\plbr{\bar{\T{R}}\T{\alpha}}\times{} & & - \bar{\T{R}} \\
	- \plbr{\bar{\T{R}}\T{\alpha}}\times{} & & \bar{\T{R}} \\
	- \bar{\T{R}} & \bar{\T{R}} & 0
	% FIXME: ??? - \bar{\T{R}}^T & \bar{\T{R}}^T & 0
	}}\cubr{\cvvect{
		\delta\T{g}_1 \\
		\delta\T{g}_2 \\
		\delta\T{\alpha} \\
	}}
\end{displaymath}
\begin{displaymath}
	\mbox{} + \sqbr{\matr{cc}{
	\plbr{\bar{\T{R}}\T{\beta}}\times{} 
		+ \bar{\T{R}}\T{\beta}_{/\T{\theta}}\bar{\T{R}}^T &
		- \bar{\T{R}}\T{\beta}_{/\T{\theta}}\bar{\T{R}}^T \\
	- \plbr{\bar{\T{R}}\T{\beta}}\times{}
		- \bar{\T{R}}\T{\beta}_{/\T{\theta}}\bar{\T{R}}^T &
		\bar{\T{R}}\T{\beta}_{/\T{\theta}}\bar{\T{R}}^T \\
	0 & 0 
	}}\cubr{\cvvect{
		\delta\T{g}_1 \\
		\delta\T{g}_2 \\
	}}
\end{displaymath}
\begin{displaymath}
 	\mbox{} + \sqbr{\matr{cccc}{
		- \bar{\T{R}}\T{\beta}_{/\T{\omega}}\bar{\T{R}}^T\T{\omega}_2\times{} &
		\bar{\T{R}}\T{\beta}_{/\T{\omega}}\bar{\T{R}}^T &
		\bar{\T{R}}\T{\beta}_{/\T{\omega}}\bar{\T{R}}^T\T{\omega}_2\times{} &
		- \bar{\T{R}}\T{\beta}_{/\T{\omega}}\bar{\T{R}}^T \\
		\bar{\T{R}}\T{\beta}_{/\T{\omega}}\bar{\T{R}}^T\T{\omega}_2\times{} &
		- \bar{\T{R}}\T{\beta}_{/\T{\omega}}\bar{\T{R}}^T &
		- \bar{\T{R}}\T{\beta}_{/\T{\omega}}\bar{\T{R}}^T\T{\omega}_2\times{} &
		\bar{\T{R}}\T{\beta}_{/\T{\omega}}\bar{\T{R}}^T \\
	0 & 0 & 0 & 0
	}}\cubr{\cvvect{
		\delta\T{g}_1 \\
		\delta\T{\dot{g}}_1 \\
		\delta\T{g}_2 \\
		\delta\T{\dot{g}}_2 \\
	}}
\end{displaymath}
\begin{displaymath}
 	\mbox{} = \cubr{\cvvect{
		\bar{\T{R}} \T{\alpha} + \bar{\T{R}} \T{\beta} \\
		- \bar{\T{R}} \T{\alpha} - \bar{\T{R}} \T{\beta} \\
		- \T{\theta}^{\delta}
	}}
\end{displaymath}


\subsubsection{Summary}
\begin{itemize}
\item each component of the relative orientation can be subjected
to separate conditions;
\item the reference relative orientation goes in matrix $\T{R}_0$
by means of a vector $\T{\theta}_0$ which can be time dependent;
there is no limitation on the amplitude of that rotation;
\item a perfect constraint results from setting to zero the error
on the relative orientation of that component;
\item a deformable constraint results from freeing the error
on the relative component, and adding a constitutive law
based on that error and possibly on its derivative;
in this case, the norm of the amplitude of the error is limited
to $\pi$;
\item friction can be added as well on those components
that are left free (or constrained by springs);
\item an interesting option is to leave all the constraint equations
always in place, and activate/deactivate them based on some trigger.
\end{itemize}





\subsection{Drive Displacement}
This joint constrains the relative position of a point optionally offset 
from node $b$ with respect to a point optionally offset from node $a$, 
so that their relative position matches a value that is imposed in node $a$ 
reference frame; the imposed vector may depend on time and other states
during the simulation:
\begin{equation}
	\T{\Phi} = \T{x}_b + \T{f}_b - \T{x}_a - \T{f}_a - \T{v} = \T{0}
\end{equation}
or, based on the initial assumptions,
\begin{equation}
	\T{\Phi} = \T{x}_b + \T{f}_b - \T{x}_a
		- \T{R}_a\plbr{\tilde{\T{f}}_a + \tilde{\T{v}}} = \T{0}
\end{equation}
The perturbation of the constraint equation yields
\begin{equation}
	\delta\T{\Phi} = 
		\delta\T{x}_b
		- \T{f}_b\times\T{\theta}_{b\delta}
		- \delta\T{x}_a
		+ \T{d}\times\T{\theta}_{a\delta}
\end{equation}
where $\T{d}=\T{R}_a\plbr{\tilde{\T{f}}_a + \tilde{\T{v}}}$.
The contributions of the constraint to the equilibrium equations is
\begin{equation}
	\cubr{\cvvect{
		\T{F}_a \\
		\T{C}_a \\
		\T{F}_b \\
		\T{C}_b
	}} = \cubr{\cvvect{
		- \T{\lambda} \\
		- \T{d}\times\T{\lambda} \\
		\T{\lambda} \\
		\T{f}_b\times\T{\lambda}
	}}
\end{equation}
where $\T{\lambda}$ is the reaction force in the global reference frame.

The contribution of forces and moments and of the constraint equation 
to the jacobian matrix is
\begin{equation}
	\sqbr{\matr{ccccc}{
		\T{0} & \T{0} & \T{0} & \T{0} & - \T{I} \\
		\T{0} & - \T{\lambda}\times\T{d}\times{} & \T{0} & \T{0} & - \T{d}\times{}\\
		\T{0} & \T{0} & \T{0} & \T{0} & \T{I} \\
		\T{0} & \T{0} & \T{0} & \T{\lambda}\times\T{f}_b\times{} & \T{f}_b\times{} \\
		- \T{I} & \T{d}\times{} & \T{I} & - \T{f}_b\times{} & \T{0}
	}}\cubr{\cvvect{
		\delta\T{x}_a \\
		\T{\theta}_{a\delta} \\
		\delta\T{x}_b \\
		\T{\theta}_{b\delta} \\
		\delta\T{\lambda}
	}}
\end{equation}

\subsubsection{``Pinned'' version (TODO)}
A variant is the joint that imposes the absolute position $\T{v}$ of a point
optionally connected to a node by a rigid offset $\T{f}$:
\begin{equation}
		\T{\Phi} = \T{x} + \T{f} - \T{v} = \T{0}
\end{equation}
The perturbation of the constraint equation yields
\begin{equation}
	\delta\T{\Phi} = 
	\delta\T{x} - \T{f}\times \T{\theta}_{\delta}
\end{equation}
The contributions of the constraint to the equilibrium equations is
\begin{equation}
	\cubr{\cvvect{
		\T{F} \\
		\T{C}
	}} = \cubr{\cvvect{
		\T{\lambda} \\
		\T{f}\times \T{\lambda}
	}}
\end{equation}
where $\T{\lambda}$ is the reaction force in the absolute reference frame.

The contribution of forces and moments and of the constraint equation 
to the jacobian matrix is
\begin{equation*}
	\sqbr{\matr{ccc}{
		\T{0} &
			\T{0} &
			\T{I} \\
		\T{0} &
			\T{\lambda}\times\T{f}\times{} &
			\T{f}\times \\
		\T{I} &
			- \T{f}\times{} &
			\T{0}
	}}\cubr{\cvvect{
		\delta\T{x} \\
		\T{\theta}_{\delta} \\
		\delta\T{\lambda}
	}}
\end{equation*}










\subsection{Gimbal}
This element implements an ideal gimbal joint.
A gimbal is a joint that allows the rotation between two nodes
about two orthogonal axes.
The angular velocity about the remaining axis is preserved regardless
of the relative angle between the two nodes.
It is essentially equivalent to two Cardano joints (universal joints)
each of which accounts for half of the relative orientation.

The relative orientation is made of three steps, described by
\begin{eqnarray*}
	\T{R}_{rel}
	& = & \T{R}_a^T \T{R}_b \\
	& = & \llk{exp}\plbr{\vartheta \T{e}_2 \times{}}
		\llk{exp}\plbr{\varphi \T{e}_1 \times{}}
		\llk{exp}\plbr{\vartheta \T{e}_2 \times{}}
\end{eqnarray*}

\noindent
Definitions:
\begin{eqnarray}
	\llk{exp}\plbr{\vartheta \T{e}_2 \times{}} & = &
		\T{I} + \sin\vartheta \T{e}_2\times{}
			+ \plbr{1 - \cos\vartheta}\T{e}_2\times\T{e}_2\times{}
		\label{eq:GIMBAL-EXP-THETA} \\
	\llk{exp}\plbr{\varphi \T{e}_1 \times{}} & = &
		\T{I} + \sin\varphi \T{e}_1\times{}
			+ \plbr{1 - \cos\varphi}\T{e}_1\times\T{e}_1\times{}
		\label{eq:GIMBAL-EXP-PHI}
\end{eqnarray}
where $\T{e}_i$ is the unit vector in the $i$-th direction.

\noindent
Constraint equation
\begin{equation}
	\llk{ax}\plbr{\llk{exp}^{-1}\plbr{\T{R}_{rel}}}
	- \llk{ax}\plbr{\llk{exp}^{-1}\plbr{
		\llk{exp}\plbr{\T{e}_2 \vartheta \times{}}
		\llk{exp}\plbr{\T{e}_1 \varphi \times{}}
		\llk{exp}\plbr{\T{e}_2 \vartheta \times{}}
	}} = \T{0}.
	\label{eq:GIMBAL-CONSTRAINT}
\end{equation}
Lagrange multipliers approach:
\begin{eqnarray*}
	0 & = & \delta\plbr{\T{\lambda}^T\plbr{
	\llk{ax}\plbr{\llk{exp}^{-1}\plbr{\T{R}_{rel}}}
	- \llk{ax}\plbr{\llk{exp}^{-1}\plbr{
		\llk{exp}\plbr{\T{e}_2 \vartheta \times{}}
		\llk{exp}\plbr{\T{e}_1 \varphi \times{}}
		\llk{exp}\plbr{\T{e}_2 \vartheta \times{}}
	}}
	}} \\
	& = & \delta\T{\lambda}^T \plbr{
	\llk{ax}\plbr{\llk{exp}^{-1}\plbr{\T{R}_{rel}}}
	- \llk{ax}\plbr{\llk{exp}^{-1}\plbr{
		\llk{exp}\plbr{\T{e}_2 \vartheta \times{}}
		\llk{exp}\plbr{\T{e}_1 \varphi \times{}}
		\llk{exp}\plbr{\T{e}_2 \vartheta \times{}}
	}}
	} \\
	& & \mbox{} + \delta\T{g}_b^T \T{R}_a \T{\lambda}
	- \delta\T{g}_a^T \T{R}_a \T{\lambda} \\
	& & \mbox{} + \delta\vartheta \T{e}_2^T \plbr{
		\T{I} + \llk{exp}\plbr{\varphi \T{e}_1 \times{}}^T
			\llk{exp}\plbr{\vartheta \T{e}_2 \times{}}^T
	} \T{\lambda} \\
	& & \mbox{} + \delta\varphi \T{e}_1^T \plbr{
		\llk{exp}\plbr{\vartheta \T{e}_2 \times{}}^T
	} \T{\lambda}
\end{eqnarray*}
The equations in $\delta\vartheta $ and $\delta\varphi$ can be simplified
by exploiting Equations~(\ref{eq:GIMBAL-EXP-THETA}, \ref{eq:GIMBAL-EXP-PHI}):
\begin{eqnarray*}
	\T{e}_2^T \plbr{
		\T{I} + \llk{exp}\plbr{\varphi \T{e}_1 \times{}}^T
			\llk{exp}\plbr{\vartheta \T{e}_2 \times{}}^T
	} & = & \plbr{
		\sin\vartheta \sin\varphi \T{e}_1
		+ \plbr{1 + \cos\varphi} \T{e}_2 
		+ \cos\vartheta\sin\varphi \T{e}_3
	}^T \\
	\T{e}_1^T \plbr{
		\llk{exp}\plbr{\vartheta \T{e}_2 \times{}}^T
	} & = & \plbr{
		\cos\vartheta \T{e}_1 - \sin\vartheta \T{e}_3
	}^T 
\end{eqnarray*}
Linearization: by defining
\begin{eqnarray*}
	\T{w}_{\vartheta} & = & 
		\sin\vartheta \sin\varphi \T{e}_1
		+ \plbr{1 + \cos\varphi} \T{e}_2 
		+ \cos\vartheta\sin\varphi \T{e}_3 \\
	\T{w}_{\varphi} & = & 
		\cos\vartheta \T{e}_1 - \sin\vartheta \T{e}_3
\end{eqnarray*}
the linearization becomes
\begin{equation*}
	\sqbr{\matr{ccccc}{
		-\plbr{\T{R}_a \T{\lambda}}\times{} & \T{0} & \T{R}_a & \T{0} & \T{0} \\
		\plbr{\T{R}_a \T{\lambda}}\times{} & \T{0} & -\T{R}_a & \T{0} & \T{0} \\
			\T{R}_a^T & -\T{R}_a^T & 0 & \T{w}_{\vartheta} & \T{w}_{\varphi} \\
		\T{0} & \T{0} & \T{w}_{\vartheta}^T &
			\sin\varphi\T{w}_{\varphi}^T \T{\lambda} &
			\plbr{\cvvect{
				\cos\varphi\sin\vartheta\T{e}_1 \\
				- \sin\varphi\T{e}_2 \\
				+ \cos\varphi\cos\vartheta\T{e}_3
			}}^T\T{\lambda} \\
		\T{0} & \T{0} & \T{w}_{\varphi}^T &
			-\plbr{\sin\vartheta\T{e}_1 + \cos\vartheta\T{e}_3}^T \T{\lambda} & 0
	}} \cubr{\cvvect{
		\delta\T{g}_a \\
		\delta\T{g}_b \\
		\delta\T{\lambda} \\
		\delta\vartheta \\
		\delta\varphi
	}}
\end{equation*}
\begin{equation*}
	\mbox{} = \cubr{\cvvect{
		-\T{R}_a \T{\lambda} \\
		\T{R}_a \T{\lambda} \\
		\mathrm{Eq.~(\ref{eq:GIMBAL-CONSTRAINT})} \\
		-\T{w}_{\vartheta}^T \T{\lambda} \\
		-\T{w}_{\varphi}^T \T{\lambda}
	}}
\end{equation*}






\subsection{Screw Joint (TODO)}
The screw joint is a combination of:
\begin{itemize}
\item an inline joint, that constrains one point to move along 
a line attached to another point:
\begin{align*}
	\T{e}_{1hx}^T\plbr{\T{x}_2 + \T{f}_2 - \T{x}_1 - \T{f}_1} &= 0 \\
	\T{e}_{1hy}^T\plbr{\T{x}_2 + \T{f}_2 - \T{x}_1 - \T{f}_1} &= 0
\end{align*}
where $\T{e}_{1hi}$ is the orientation of axis $i$ in the reference
of the joint with respect to node 1, i.e.\ the $i$-th column of matrix
$\T{R}_1 \tilde{\T{R}}_{1h}$
\begin{equation*}
	\T{e}_{jhi} = \plbr{\T{R}_j \tilde{\T{R}}_{jh}}\sqbr{i}
\end{equation*}
$\T{x}_j$ is the position of node $j$
and $\T{f}_j$ is the offset of the joint with respect node $j$,
both in the absolute coordinate system; the offset is constant
with respect to the reference frame of the joint,
so $\T{f}_j=\T{R}_j\tilde{\T{f}}_j$.

\item a revolute rotation joint, that constrains the relative
orientation of two nodes to be a rotation about an axis that
is fixed with respect to the two bodies:
\begin{align*}
	\T{e}_{2hx}^T \T{e}_{1hz} = 0 \\
	\T{e}_{2hy}^T \T{e}_{1hz} = 0
\end{align*}

\item a linear relationship between the relative rotation
about the common axis and the relative position along the common axis:
\begin{equation}
	\label{eq:SCREW-constraint}
	\frac{p}{2 \pi} \theta - \T{e}_{1hz}^T\plbr{\T{x}_2 + \T{f}_2 - \T{x}_1 - \T{f}_1} = 0
\end{equation}
where $p$ represents the distance between the nodes 
along axis $\T{e}_{1hz}$ corresponding to one revolution 
about the same axis.
\end{itemize}




The rotation $\theta$ is formulated as
\begin{equation*}
	\theta = \T{e}_{1hz}^T \llk{ax}\plbr{\llk{exp}^{-1}\plbr{\T{R}_1^T \T{R}_2}}
\end{equation*}
To overcome the limitation $\shbr{\theta}<\pi/2$, an incremental
approach is used; since the revolute constraint guarantees that
the rotation will always occur with respect to axis $z$ of node 1,
$\T{e}_{1hz}$
\begin{equation}
	\label{eq:SCREW-constraint-incremental}
	\theta = \theta_{\llk{ref}}
		+ \T{e}_{1hz}^T \llk{ax}\plbr{\llk{exp}^{-1}\plbr{\plbr{\T{R}_1^T \T{R}_{1\llk{ref}}}^T \plbr{\T{R}_2^T \T{R}_{2\llk{ref}}}}}
\end{equation}
The orientation at the previous time step is assumed as reference,
under the assumption that the change in orientation during a time step 
remains limited.

The virtual perturbation of Equation~(\ref{eq:SCREW-constraint-incremental})
yields
\begin{equation*}
	\delta\theta = \T{e}_{1hz}^T\plbr{\T{\theta}_{2\delta} - \T{\theta}_{1\delta}}
\end{equation*}
so the virtual perturbation of Equation~(\ref{eq:SCREW-constraint})
\begin{align*}
	\frac{p}{2 \pi} \T{e}_{1hz}^T\plbr{\T{\theta}_{2\delta} - \T{\theta}_{1\delta}}
	- \plbr{\T{e}_{1hz} \times \plbr{\T{x}_2 + \T{f}_2 - \T{x}_1}}^T \T{\theta}_{1\delta} & \\
	- \T{e}_{1hz}^T\plbr{\delta\T{x}_2 - \T{f}_2 \times \T{\theta}_{2\delta} - \delta\T{x}_1} &= 0
\end{align*}
yields the contribution of the constraint to the forces and moments
acting on the constrained nodes:
\begin{align*}
	\T{F}_1 &= \T{e}_{1hz} \lambda \\
	\T{C}_1 &= \plbr{
		\plbr{\T{x}_2 + \T{f}_2 - \T{x}_1} \times \T{e}_{1hz} 
		- \cfrac{p}{2 \pi} \T{e}_{1hz}
	} \lambda \\
	\T{F}_2 &= - \T{e}_{1hz} \lambda \\
	\T{C}_2 &= - \plbr{
		\T{f}_2 \times \T{e}_{1hz}
		- \cfrac{p}{2 \pi} \T{e}_{1hz}
	} \lambda
\end{align*}
where $\lambda$ is the Lagrange multiplier that here assumes the meaning
of reaction force along the screw axis.

\paragraph{Physics}
In other words, node 1 is the screw and node 2 is the bolt;
neglecting the offset, the force along the screw axis is related
to the couple about the same axis by the relationship
\begin{equation*}
	C = - \frac{p}{2\pi} F
\end{equation*}
which results from a power balance
\begin{equation*}
	C \omega_r + F v_r = 0
\end{equation*}
in terms of relative linear ($v_r$) and angular ($\omega_r$) velocity,
with the kinematic relationship
\begin{equation*} 
	v_r = \frac{p}{2\pi} \omega_r
\end{equation*}

A foreseen improvement consists in adding friction based on empirical
formulas for screws.







\section{Deformable Constraints}
Definitions
\begin{eqnarray*}
	\T{f}_1 & = & \T{R}_1 \tilde{\T{f}}_1 \\
	\T{f}_2 & = & \T{R}_2 \tilde{\T{f}}_2 \\
	\T{R}_{1h} & = & \T{R}_1 \tilde{\T{R}}_{1h} \\
	\T{R}_{2h} & = & \T{R}_2 \tilde{\T{R}}_{2h}
\end{eqnarray*}
where $\T{R}_i$ is the current orientation of node $i$, 
$\tilde{\T{R}}_{ih}$ is a constant re-orientation of the joint
with respect to node $i$, so $\T{R}_{ih}$ is the orientation
of the joint with respect to the global frame;
$\tilde{\T{f}}_i$ is the offset of the joint with respect to
node $i$ in the node reference frame, so $\T{f}_i$ is the offset 
of the joint with respect to node $i$ in the global frame, and
$\T{x}_i+\T{f}_i$ is the position of the joint with respect 
to the global frame.

\subsection{Rod With Offsets}
Distance vector between pin points
\begin{equation}
	\T{v} = \T{x}_2 + \T{f}_2 - \T{x}_1 - \T{f}_1
\end{equation}
scalar distance
\begin{equation}
	l = \sqrt{\T{v}^T \T{v}}
\end{equation}
strain
\begin{equation}
	\varepsilon = \frac{l}{l_0} - 1
\end{equation}
strain rate
\begin{equation}
	\dot{\varepsilon} = \frac{\dot{l}}{l_0}
\end{equation}
where
\begin{align}
	\dot{l} &= \frac{1}{l} \T{v}^T \dot{\T{v}} \\
	\dot{\T{v}} &= \dot{\T{x}}_2 + \T{\omega}_2 \times \T{f}_2
		- \dot{\T{x}}_1 - \T{\omega}_1 \times \T{f}_1
\end{align}
scalar force
\begin{equation}
	f = f\plbr{\varepsilon, \dot{\varepsilon}}
\end{equation}
force vector
\begin{equation}
	\T{F} = \frac{\T{v}}{l} f
\end{equation}
nodal forces and moments
\begin{align}
	\T{F}_1 &= -\T{F} \\
	\T{M}_1 &= -\T{f}_1 \times \T{F} \\
	\T{F}_2 &= \T{F} \\
	\T{M}_2 &= \T{f}_2 \times \T{F}
\end{align}
equation linearization
\begin{align}
	\delta\T{F}_1 &= -\delta\T{F} \\
	\delta\T{M}_1 &= -\T{f}_1 \times \delta\T{F} - \T{F}\times\T{f}_1\times \T{\theta}_{1\delta} \\
	\delta\T{F}_2 &= \delta\T{F} \\
	\delta\T{M}_2 &= \T{f}_2 \times \delta\T{F} + \T{F}\times\T{f}_2\times \T{\theta}_{2\delta}
\end{align}
force linearization
\begin{equation}
	\delta\T{F} = \frac{f}{l}\plbr{\T{I} - \frac{\T{v}\T{v}^T}{l^2}} \delta\T{v} + \frac{\T{v}}{l} \delta{f}
\end{equation}
scalar force linearization
\begin{equation}
	\delta{f} = \frac{\partial{f}}{\partial\varepsilon} \delta\varepsilon
	+ \frac{\partial{f}}{\partial\dot{\varepsilon}} \delta\dot{\varepsilon}
\end{equation}
strain linearization
\begin{equation}
	\delta\varepsilon = \frac{1}{l_0}\delta{l}
\end{equation}
where
\begin{align}
	\delta{l} &= \frac{1}{l}\T{v}^T \delta\T{v} \\
	\delta\T{v} &= \delta\T{x}_2 - \T{f}_2 \times \T{\theta}_{2\delta}
		- \delta\T{x}_1 + \T{f}_1 \times \T{\theta}_{1\delta}
\end{align}
strain rate linearization
\begin{equation}
	\delta\dot{\varepsilon} = \frac{1}{l_0} \delta\dot{l}
\end{equation}
where
\begin{align}
	\delta\dot{l} &= \frac{\T{v}^T}{l} \delta\dot{\T{v}}
		+ \frac{\dot{\T{v}}^T}{l}\plbr{\T{I} - \frac{\T{v}\T{v}^T}{l^2}} \delta\T{v} \\
	\delta\dot{\T{v}} &= \delta\dot{\T{x}}_2
		- \T{f}_2 \times \delta\T{\omega}_2 - \T{\omega}_2 \times \T{f}_2 \times \T{\theta}_{2\delta}
		\nonumber \\
		& \mbox{} - \delta\dot{\T{x}}_1
		+ \T{f}_1 \times \delta\T{\omega}_1 + \T{\omega}_1 \times \T{f}_1 \times \T{\theta}_{1\delta}
\end{align}
to summarize:
\begin{equation}
	\delta\T{F} = \T{K}_{\T{v}} \delta\T{v} + \T{K}_{\dot{\T{v}}} \delta\dot{\T{v}}
\end{equation}
with
\begin{align}
	\T{K}_{\T{v}} &= \frac{f}{l} \T{I}
		+ \plbr{
			\frac{1}{l^2 l_0} \frac{\partial{f}}{\partial\varepsilon}
			- \frac{\dot{\varepsilon}}{l^3} \frac{\partial{f}}{\partial\dot{\varepsilon}}
			- \frac{f}{l^3}
		}\T{v}\T{v}^T
		+ \frac{1}{l^2 l_0} \frac{\partial{f}}{\partial\dot{\varepsilon}} \T{v}\dot{\T{v}}^T \\
	\T{K}_{\dot{\T{v}}} &= \frac{1}{l^2 l_0} \frac{\partial{f}}{\partial\dot{\varepsilon}} \T{v}\T{v}^T
\end{align}
according to the updated-updated approach,
\begin{align}
	\T{\theta}_{i\delta} &\cong \delta\T{g}_i \\
	\delta\T{\omega}_i &\cong \delta\dot{\T{g}}_i - \T{\omega}\times\delta\T{g}_i
\end{align}
recalling that
\begin{equation}
	\delta{z} = c \delta\dot{z}
\end{equation}
the linearization of the force becomes
\begin{align}
	\delta\T{F} &= \plbr{c\T{K}_{\T{v}} + \T{K}_{\dot{\T{v}}}} \delta\dot{\T{x}}_2
		\nonumber \\
		& + \plbr{
			- \plbr{c\T{K}_{\T{v}} + \T{K}_{\dot{\T{v}}}} \T{f}_2\times{}
			+ c \T{K}_{\dot{\T{v}}} \plbr{\T{f}_2 \times \T{\omega}_2}\times{}
		} \delta\dot{\T{g}}_2
		\nonumber \\
		& - \plbr{c\T{K}_{\T{v}} + \T{K}_{\dot{\T{v}}}} \delta\dot{\T{x}}_1
		\nonumber \\
		& - \plbr{
			- \plbr{c\T{K}_{\T{v}} + \T{K}_{\dot{\T{v}}}} \T{f}_1\times{}
			+ c \T{K}_{\dot{\T{v}}} \plbr{\T{f}_1 \times \T{\omega}_1}\times{}
		} \delta\dot{\T{g}}_1
\end{align}

















\subsection{Deformable Hinge}
The deformable hinge applies an internal moment to two nodes that may depend
on their relative orientation and angular velocity through a 3D constitutive law.

\noindent
The relative orientation is computed in analogy with the Drive Hinge joint
\begin{equation*}
	\T{\theta} =
	\llk{ax}\plbr{\llk{exp}^{-1}\plbr{\T{R}_{1h}^T \T{R}_{2h}}}
\end{equation*}
Since the relative orientation $\T{R}_{1h}^T \T{R}_{2h}$ is a rotation 
about an axis parallel to $\T{\theta}$,
$\T{R}_{1h}^T \T{R}_{2h}\T{\theta}=\T{\theta}$.
The same applies for any relative orientation tensor built from a rotation
vector parallel to $\T{\theta}$; in detail, the rotation
$\tilde{\T{\theta}}=\T{\theta}/2$
will be used to define an intermediate reference frame for the joint,
whose orientation with respect to node 1 is
\begin{eqnarray*}
	\tilde{\T{R}} & = & \llk{exp}\plbr{\frac{1}{2}\llk{exp}^{-1}\plbr{\T{R}_{1h}^T \T{R}_{2h}}} \\
		& = & \llk{exp}\plbr{\tilde{\T{\theta}}\times{}}
\end{eqnarray*}
The orientation of the intermediate reference frame with respect 
to node 2 is $\tilde{\T{R}}^T$.
The orientation of the intermediate frame with respect
to the global frame is
\begin{eqnarray*}
	\hat{\T{R}} & = & \T{R}_1 \tilde{\T{R}} \\
	& = & \T{R}_2 \tilde{\T{R}}^T
\end{eqnarray*}
The derivative of $\tilde{\T{R}}$ is
\begin{equation*}
	\dot{\tilde{\T{R}}} = \frac{1}{2}\plbr{\T{\omega}_2 - \T{\omega}_1}\times\tilde{\T{R}}
\end{equation*}
and the derivative of $\hat{\T{R}}$ is
\begin{equation*}
	\dot{\hat{\T{R}}} = \frac{1}{2}\plbr{\T{\omega}_1 + \T{\omega}_2}\times\hat{\T{R}}
\end{equation*}
The perturbation of $\tilde{\T{R}}$ is
\begin{equation*}
	\delta\tilde{\T{R}} = \tilde{\T{\theta}}_{\delta}\times\tilde{\T{R}}
\end{equation*}
where
\begin{eqnarray*}
	\tilde{\T{\theta}}_{\delta} & = & \frac{1}{2}\T{\Gamma}\plbr{\tilde{\T{\theta}}}
		\T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T\plbr{\T{\theta}_{2\delta} - \T{\theta}_{1\delta}} \\
	& \cong & \frac{1}{2}\T{\Gamma}\plbr{\tilde{\T{\theta}}}
		\T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T\plbr{\delta\T{g}_2 - \delta\T{g}_1}
\end{eqnarray*}
The perturbation of $\dot{\tilde{\T{R}}}$ is
\begin{eqnarray*}
	\delta\dot{\tilde{\T{R}}}
	& = & \frac{1}{2}\plbr{\delta\T{\omega}_2 - \delta\T{\omega}_1}\times\tilde{\T{R}}
	+ \frac{1}{2}\plbr{\T{\omega}_2 - \T{\omega}_1}\times\delta\tilde{\T{R}} \\
	& \cong & \frac{1}{2}\plbr{
		\delta\dot{\T{g}}_2 - \T{\omega}_2\times\delta\T{g}_2
		- \delta\dot{\T{g}}_1 + \T{\omega}_1\times\delta\T{g}_1
	}\times\tilde{\T{R}}
	+ \frac{1}{2}\plbr{\T{\omega}_2 - \T{\omega}_1}\times\delta\tilde{\T{R}}
\end{eqnarray*}
The perturbation of $\dot{\hat{\T{R}}}$ is
\begin{eqnarray*}
	\delta\dot{\hat{\T{R}}}
	& = & \frac{1}{2}\plbr{\delta\T{\omega}_2 + \delta\T{\omega}_1}\times\hat{\T{R}}
	+ \frac{1}{2}\plbr{\T{\omega}_2 + \T{\omega}_1}\times\delta\hat{\T{R}} \\
	& \cong & \frac{1}{2}\plbr{
		\delta\dot{\T{g}}_2 - \T{\omega}_2\times\delta\T{g}_2
		+ \delta\dot{\T{g}}_1 - \T{\omega}_1\times\delta\T{g}_1
	}\times\hat{\T{R}}
	+ \frac{1}{2}\plbr{\T{\omega}_2 + \T{\omega}_1}\times\delta\hat{\T{R}}
\end{eqnarray*}
The relative angular velocity is
\begin{equation*}
	\T{\omega} = \hat{\T{R}}^T \plbr{\T{\omega}_2 - \T{\omega}_1}
\end{equation*}
The linearization of the angular velocity yields
\begin{equation*}
	\delta\T{\omega} \cong \T{R}_{1h}^T \plbr{
		\delta\dot{\T{g}}_2
		- \delta\dot{\T{g}}_1
		- \T{\omega}_2 \times \delta\T{g}_2
		+ \T{\omega}_2 \times \delta\T{g}_1
	}
\end{equation*}
The moment is
\begin{equation*}
	\T{M}_i = \plbr{ -1 }^{\plbr{i-1}} \T{R}_{1h} \tilde{\T{M}}\plbr{\T{\theta}, \T{\omega}}
\end{equation*}
Its linearization yields
\begin{equation*}
	\delta\T{M}_i \cong \plbr{ -1 }^{\plbr{i-1}} \T{R}_{1h} \plbr{
		\tilde{\T{M}}_{/\T{\theta}} \T{\theta}_{\delta}
		+ \tilde{\T{M}}_{/\T{\omega}} \delta\T{\omega}
	} - \T{M}_i \times \delta\T{g}_1
\end{equation*}
The complete linearized problem is
\begin{eqnarray*}
	\sqbr{\matr{cc}{
		\T{M}_{/\T{\omega}} & - \T{M}_{/\T{\omega}} \\
		- \T{M}_{/\T{\omega}} & \T{M}_{/\T{\omega}}
	}}\cubr{\cvvect{
		\delta\dot{\T{g}}_1 \\
		\delta\dot{\T{g}}_2
	}} & & \\
	\mbox{} + \sqbr{\matr{cc}{
		\T{M}_{/\T{\theta}} - \T{M}_{/\T{\omega}} \T{\omega}_2\times{} + \T{M}\times{} & 
			- \T{M}_{/\T{\theta}} + \T{M}_{/\T{\omega}} \T{\omega}_2\times{} \\
		- \T{M}_{/\T{\theta}} + \T{M}_{/\T{\omega}} \T{\omega}_2\times{} - \T{M}\times{} & 
			\T{M}_{/\T{\theta}} - \T{M}_{/\T{\omega}} \T{\omega}_2\times{}
	}}\cubr{\cvvect{
		\delta\T{g}_1 \\
		\delta\T{g}_2
	}} & = & \cubr{\cvvect{
		\T{M} \\
		- \T{M}
	}}
\end{eqnarray*}
where
\begin{eqnarray*}
	\T{M}_{/\T{\omega}} & = & \T{R}_{1h} \tilde{\T{M}}_{/\T{\omega}} \T{R}_{1h}^T \\
	\T{M}_{/\T{\theta}} & = & \T{R}_{1h} \tilde{\T{M}}_{/\T{\theta}} \T{R}_{1h}^T
\end{eqnarray*}







\subsection{Deformable Displacement Joint}
The deformable hinge applies an internal force to two nodes at a specified 
point that may be offset from the nodes; the force may depend on the relative
position and velocity of the nodes at the point of application
through a 3D constitutive law.

\noindent
The relative position is expressed in a reference frame attached to node 1:
\begin{equation*}
	\tilde{\T{d}} = \T{R}_{1h}^T\plbr{
		\T{x}_2 + \T{f}_2 - \T{x}_1 - \T{f}_1
	}
\end{equation*}
The relative velocity is
\begin{eqnarray*}
	\dot{\tilde{\T{d}}} & = & \T{R}_{1h}^T\plbr{
		\dot{\T{x}}_2 + \T{\omega}_2\times\T{f}_2
		- \dot{\T{x}}_1 - \T{\omega}_1\times\T{f}_1
	} + \tilde{\T{d}}\times\T{R}_{1h}^T \T{\omega}_1 \\
	& = & \T{R}_{1h}^T\plbr{
		\dot{\T{x}}_2 - \dot{\T{x}}_1
		+ \T{\omega}_2\times\T{f}_2
		- \T{\omega}_1\times\plbr{\T{x}_2 + \T{f}_2 - \T{x}_1}
	}
\end{eqnarray*}
The linearization of the distance yields
\begin{eqnarray*}
	\delta{\tilde{\T{d}}} & \cong & \T{R}_{1h}^T\plbr{
		\delta{\T{x}}_2 - \T{f}_2\times\delta\T{g}_2
		- \delta{\T{x}}_1 + \T{f}_1\times\delta\T{g}_1
	} + \tilde{\T{d}}\times\T{R}_{1h}^T \delta\T{g}_1 \\
	& \cong & \T{R}_{1h}^T\plbr{
		\delta{\T{x}}_2 - \delta{\T{x}}_1
		- \T{f}_2\times\delta\T{g}_2
		+ \plbr{\T{x}_2 + \T{f}_2 - \T{x}_1}\times\delta\T{g}_1
	} \\
	& = & \T{R}_{1h}^T\plbr{
		\delta{\T{x}}_2
		- \delta{\T{x}}_1
		- \T{f}_2\times\delta\T{g}_2
		+ \T{d}_1\times\delta\T{g}_1
	}
\end{eqnarray*}
while the linearization of the relative velocity yields
\begin{eqnarray*}
	\delta\dot{\tilde{\T{d}}} & \cong & \T{R}_{1h}^T\lplbr{
		\delta\dot{\T{x}}_2
		- \delta\dot{\T{x}}_1
		- \T{f}_2\times\delta\dot{\T{g}}_2
		+ \plbr{\T{x}_2 + \T{f}_2 - \T{x}_1}\times\delta\dot{\T{g}}_1
	} \\
	& & \mbox{} - \T{\omega}_1 \times \delta\T{x}_2
		+ \T{\omega}_1 \times \delta\T{x}_1 \\
	& & \mbox{} - \plbr{
			\plbr{\T{\omega}_2 \times \T{f}_2}\times{}
			- \T{\omega}_1 \times \T{f}_2 \times{}
		} \delta\T{g}_2 \\
	& & \rplbr{
		+ \plbr{
			\plbr{
				\dot{\T{x}}_2
				+ \T{\omega}_2 \times  \T{f}_2
				- \dot{\T{x}}_1
			} \times{}
			- \T{\omega}_1 \times \plbr{
				\T{x}_2 + \T{f}_2 - \T{x}_1
			}\times{}
		} \delta\T{g}_1
	} \\
	& = & \T{R}_{1h}^T\lplbr{
		\delta\dot{\T{x}}_2
		- \delta\dot{\T{x}}_1
		- \T{f}_2\times\delta\dot{\T{g}}_2
		+ \T{d}_1\times\delta\dot{\T{g}}_1
	} \\
	& & \mbox{} - \T{\omega}_1 \times \delta\T{x}_2
		+ \T{\omega}_1 \times \delta\T{x}_1 \\
	& & \mbox{} 
		- \plbr{
			\plbr{\T{\omega}_2 \times \T{f}_2}\times{}
			- \T{\omega}_1 \times \T{f}_2 \times{}
		} \delta\T{g}_2 \\
	& & \rplbr{
		+ \plbr{
			\dot{\T{d}}_1\times{}
			- \T{\omega}_1\times\T{d}_1\times{}
		} \delta\T{g}_1
	}
\end{eqnarray*}
where
\begin{eqnarray*}
	\T{d}_1 & = & \T{x}_2 + \T{f}_2 - \T{x}_1 \\
	\dot{\T{d}}_1 & = & \dot{\T{x}}_2 + \T{\omega}_2 \times \T{f}_2 - \dot{\T{x}}_1
\end{eqnarray*}
The force and the moment are
\begin{eqnarray*}
	\T{F}_i & = & \plbr{ -1 }^i \T{R}_{1h} \tilde{\T{F}}\plbr{\tilde{\T{d}}, \dot{\tilde{\T{d}}}} \\
	\T{M}_i & = & \T{f}_i \times \T{F}_i
\end{eqnarray*}
Their linearization yields
\begin{eqnarray*}
	\delta\T{F}_i & = & \plbr{ -1 }^i \T{R}_{1h} \plbr{
		\tilde{\T{F}}_{/\tilde{\T{d}}} \delta{\tilde{\T{d}}}
		+ \tilde{\T{F}}_{/\dot{\tilde{\T{d}}}} \delta\dot{\tilde{\T{d}}}
	} - \T{F}_i \times \delta\T{g}_1 \\
	\delta\T{M}_i & = & \T{f}_i \times \delta\T{F}_i + \T{F}_i \times \T{f}_i \times \delta\T{g}_i
\end{eqnarray*}
The complete linearized problem is
\begin{eqnarray*}
	\sqbr{\matr{cccc}{
		\T{F}_{/\dot{\tilde{\T{d}}}} & -\T{F}_{/\dot{\tilde{\T{d}}}} \T{d}_1\times{} &
			- \T{F}_{/\dot{\tilde{\T{d}}}} & \T{F}_{/\dot{\tilde{\T{d}}}} \T{f}_2\times{} \\
		\T{f}_1 \times \T{F}_{/\dot{\tilde{\T{d}}}} &
			- \T{f}_1 \times \T{F}_{/\dot{\tilde{\T{d}}}} \T{d}_1\times{} &
			- \T{f}_1 \times \T{F}_{/\dot{\tilde{\T{d}}}} &
			\T{f}_1 \times \T{F}_{/\dot{\tilde{\T{d}}}} \T{f}_2\times{} \\
		- \T{F}_{/\dot{\tilde{\T{d}}}} & \T{F}_{/\dot{\tilde{\T{d}}}} \T{d}_1\times{} &
			\T{F}_{/\dot{\tilde{\T{d}}}} & - \T{F}_{/\dot{\tilde{\T{d}}}} \T{f}_2\times{} \\
		- \T{f}_2 \times \T{F}_{/\dot{\tilde{\T{d}}}} &
			\T{f}_2 \times \T{F}_{/\dot{\tilde{\T{d}}}} \T{d}_1\times{} &
			\T{f}_2 \times \T{F}_{/\dot{\tilde{\T{d}}}} &
			- \T{f}_2 \times \T{F}_{/\dot{\tilde{\T{d}}}} \T{f}_2\times{}
	}} \cubr{\cvvect{
		\delta\dot{\T{x}}_1 \\
		\delta\dot{\T{g}}_1 \\
		\delta\dot{\T{x}}_2 \\
		\delta\dot{\T{g}}_2
	}} & & \\
	\mbox{} + \sqbr{\cvvect{
		\T{F}_{/\tilde{\T{d}}} - \T{F}_{/\dot{\tilde{\T{d}}}} \T{\omega}_1 \times{} \\
		\T{f}_1 \times \plbr{\T{F}_{/\tilde{\T{d}}} - \T{F}_{/\dot{\tilde{\T{d}}}} \T{\omega}_1 \times{}} \\
		- \T{F}_{/\tilde{\T{d}}} + \T{F}_{/\dot{\tilde{\T{d}}}} \T{\omega}_1 \times{} \\
		- \T{f}_2 \times \plbr{\T{F}_{/\tilde{\T{d}}} - \T{F}_{/\dot{\tilde{\T{d}}}} \T{\omega}_1 \times{}}
	}} \delta\T{x}_1 + \sqbr{\cvvect{
		- \T{F}_{/\tilde{\T{d}}} + \T{F}_{/\dot{\tilde{\T{d}}}} \T{\omega}_1 \times{} \\
		- \T{f}_1 \times \plbr{\T{F}_{/\tilde{\T{d}}} - \T{F}_{/\dot{\tilde{\T{d}}}} \T{\omega}_1 \times{}} \\
		\T{F}_{/\tilde{\T{d}}} - \T{F}_{/\dot{\tilde{\T{d}}}} \T{\omega}_1 \times{} \\
		\T{f}_2 \times \plbr{\T{F}_{/\tilde{\T{d}}} - \T{F}_{/\dot{\tilde{\T{d}}}} \T{\omega}_1 \times{}}
	}} \delta\T{x}_2 & & \\
	\mbox{} + \sqbr{\cvvect{
		- \T{F}_{/\tilde{\T{d}}} \T{d}_1 \times{}
		- \T{F}_{/\dot{\tilde{\T{d}}}} \plbr{
			\dot{\T{d}}_1 \times{} - \T{\omega}_1 \times \T{d}_1\times{}
		} + \T{F}\times \\
		- \T{f}_1 \times \plbr{\T{F}_{/\tilde{\T{d}}} \T{d}_1 \times{}
			+ \T{F}_{/\dot{\tilde{\T{d}}}} \plbr{
				\dot{\T{d}}_1 \times{} - \T{\omega}_1 \times \T{d}_1\times{}
			}
		} + \plbr{\T{f}_1 \times \T{F}}\times{} \\
		\T{F}_{/\tilde{\T{d}}} \T{d}_1 \times{}
		+ \T{F}_{/\dot{\tilde{\T{d}}}} \plbr{
			\dot{\T{d}}_1 \times{} - \T{\omega}_1 \times \T{d}_1\times{}
		} - \T{F}\times \\
		\T{f}_2 \times \plbr{\T{F}_{/\tilde{\T{d}}} \T{d}_1 \times{}
			+ \T{F}_{/\dot{\tilde{\T{d}}}} \plbr{
				\dot{\T{d}}_1 \times{} - \T{\omega}_1 \times \T{d}_1\times{}
			} - \T{F}\times
		}
	}} \delta\T{g}_1 \\
	\mbox{} + \sqbr{\cvvect{
		\T{F}_{/\tilde{\T{d}}} \T{f}_2 \times{}
		+ \T{F}_{/\dot{\tilde{\T{d}}}} \plbr{
			\plbr{\T{\omega}_2 \times \T{f}_2}\times{}
			- \T{\omega}_1 \times \T{f}_2\times{}
		} \\
		\T{f}_1 \times \plbr{\T{F}_{/\tilde{\T{d}}} \T{f}_2 \times{}
			+ \T{F}_{/\dot{\tilde{\T{d}}}} \plbr{
				\plbr{\T{\omega}_2 \times \T{f}_2}\times{}
				- \T{\omega}_1 \times \T{f}_2\times{}
			}
		} \\
		- \T{F}_{/\tilde{\T{d}}} \T{f}_2 \times{}
		- \T{F}_{/\dot{\tilde{\T{d}}}} \plbr{
			\plbr{\T{\omega}_2 \times \T{f}_2}\times{}
			- \T{\omega}_1 \times \T{f}_2\times{}
		} \\
		- \T{f}_2 \times \plbr{\T{F}_{/\tilde{\T{d}}} \T{f}_2 \times{}
			+ \T{F}_{/\dot{\tilde{\T{d}}}} \plbr{
				\plbr{\T{\omega}_2 \times \T{f}_2}\times{}
				- \T{\omega}_1 \times \T{f}_2\times{}
			}
		} + \T{F} \times \T{f}_2 \times{}
	}} \delta\T{g}_2
	& = & \\
	\cubr{\cvvect{
		\T{F} \\
		\T{f}_1 \times \T{F} \\
		- \T{F} \\
		- \T{f}_2 \times \T{F}
	}} & &
\end{eqnarray*}
where 
\begin{eqnarray*}
	\T{F}_{/\tilde{\dot{\T{d}}}} & = & \T{R}_{1h} \tilde{\T{F}}_{/\tilde{\dot{\T{d}}}} \T{R}_{1h}^T \\
	\T{F}_{/\tilde{\T{d}}} & = & \T{R}_{1h} \tilde{\T{F}}_{/\tilde{\T{d}}} \T{R}_{1h}^T
\end{eqnarray*}



\subsection{Deformable Joint}
The deformable joint applies an internal force and an internal moment
to two nodes at a specified point that may be offset from the nodes;
the force and the moment may depend on the relative position and velocity
at the point of application and on the relative orientation and angular 
velocity of the nodes through a 6D constitutive law.

Although it may appear as a combination of the Deformable Hinge
and the Deformable Displacement Joint, and despite some commonality
of code, it is a bit more general because the internal force
and moment may depend on the relative displacement and orientation,
i.e.\ the displacements and the orientations are coupled.
However, if a simple linear diagonal constitutive law is used,
the same result with a bit less overhead is obtained by using
a combination of a deformable hinge and a deformable displacement joint.

\noindent
The complete linearized problem is
\begin{eqnarray*}
	\sqbr{\matr{cc}{
		\T{F}_{/\tilde{\T{d}}} & - \T{F}_{/\tilde{\T{d}}} \\
		\T{M}_{/\tilde{\T{d}}} + \T{f}_1 \times \T{F}_{/\tilde{\T{d}}} &
			-\plbr{\T{M}_{/\tilde{\T{d}}} + \T{f}_1 \times \T{F}_{/\tilde{\T{d}}}} \\
		- \T{F}_{/\tilde{\T{d}}} & \T{F}_{/\tilde{\T{d}}} \\
		- \plbr{\T{M}_{/\tilde{\T{d}}} + \T{f}_2 \times \T{F}_{/\tilde{\T{d}}}} &
			\T{M}_{/\tilde{\T{d}}} + \T{f}_2 \times \T{F}_{/\tilde{\T{d}}}
	}}\cubr{\cvvect{
		\delta\T{x}_1 \\
		\delta\T{x}_2 \\
	}} \\
	\mbox{} + \sqbr{\cvvect{
		\T{F}_{/\T{\theta}} - \T{F}_{/\tilde{\T{d}}} \T{d}_1\times{} + \T{F}\times{} \\
		\T{M}_{/\T{\theta}} - \T{M}_{/\tilde{\T{d}}} \T{d}_1\times{} 
			+ \T{f}_1\times\T{F}_{/\T{\theta}}
			- \T{f}_1\times\T{F}_{/\tilde{\T{d}}} \T{d}_1\times{}
			+ \plbr{\T{f}_1\times\T{F}}\times{} + \T{M}\times{} \\
		- \plbr{\T{F}_{/\T{\theta}} - \T{F}_{/\tilde{\T{d}}} \T{d}_1\times{} + \T{F}\times{}} \\
		- \plbr{\T{M}_{/\T{\theta}} - \T{M}_{/\tilde{\T{d}}} \T{d}_1\times{}
			+ \T{f}_2\times\T{F}_{/\T{\theta}}
			- \T{f}_2\times\T{F}_{/\tilde{\T{d}}} \T{d}_1\times{}
			+ \T{f}_2\times\T{F}\times{} + \T{M}\times{}}
	}}\delta\T{g}_1 \\
	\mbox{} + \sqbr{\cvvect{
		- \plbr{\T{F}_{/\T{\theta}} - \T{F}_{/\tilde{\T{d}}} \T{f}_2\times{}} \\
		- \plbr{\T{M}_{/\T{\theta}} - \T{M}_{/\tilde{\T{d}}} \T{f}_2\times{}
			+ \T{f}_1\times\T{F}_{/\T{\theta}}
			- \T{f}_1\times\T{F}_{/\tilde{\T{d}}} \T{f}_2\times{}} \\
		\T{F}_{/\T{\theta}} - \T{F}_{/\tilde{\T{d}}} \T{f}_2\times{} \\
		\T{M}_{/\T{\theta}} - \T{M}_{/\tilde{\T{d}}} \T{f}_2\times{}
			+ \T{f}_2\times\T{F}_{/\T{\theta}}
			- \T{f}_2\times\T{F}_{/\tilde{\T{d}}} \T{f}_2\times{}
			+ \T{F}\times\T{f}_2\times{}
	}}\delta\T{g}_2
	& = & \\
	\cubr{\cvvect{
		\T{F} \\
		\T{f}_1 \times \T{F} + \T{M} \\
		- \T{F} \\
		- \T{f}_2 \times \T{F} - \T{M}
	}} & &
\end{eqnarray*}
where 
\begin{eqnarray*}
	\T{F}_{/\tilde{\T{d}}} & = & \T{R}_{1h} \tilde{\T{F}}_{/\tilde{\T{d}}} \T{R}_{1h}^T \\
	\T{F}_{/\T{\theta}} & = & \T{R}_{1h} \tilde{\T{F}}_{/\T{\theta}} \T{R}_{1h}^T \\
	\T{M}_{/\tilde{\T{d}}} & = & \T{R}_{1h} \tilde{\T{M}}_{/\tilde{\T{d}}} \T{R}_{1h}^T \\
	\T{M}_{/\T{\theta}} & = & \T{R}_{1h} \tilde{\T{M}}_{/\T{\theta}} \T{R}_{1h}^T \\
	\T{d}_1 & = & \T{x}_2 + \T{f}_2 - \T{x}_1
\end{eqnarray*}


\section{Modal Element}
\input{tecman-modal}


\chapter{Hydraulic Library}
\section{Hydraulic Fluids}
\section{Hydraulic Nodes}

\section{Hydraulic Elements}

\subsection{Accumulator}
The accumulator defines two internal states $x$ and $v$ that represent 
the position and the velocity of the cap that, in a conventional
gas device, separates the fluid and the gas.
However, both the gravity effect and a linear spring effect
can be considered as well, and any combination of reaction forces
can be modeled by setting the appropriate parameters:
$g$ for a gravity device, $p_{g0}$ for a gas device, 
and $k$ for a linear spring device.
\begin{eqnarray*}
	0 & = & q \\
	m \dot{v} + k x & = & 
		- m g
		+ A p \plbr{p - p_g}
		- f_0 
		- \frac{1}{2} \rho A c_e \plbr{\frac{A}{A_p}}^2 \shbr{v} v \\
	& & \mbox{} - \step\plbr{x_{\llk{min}} - x}
		\plbr{c_1 \plbr{x - x_{\llk{min}}} + c_2 v + c_3 \dot{v}} \\
	& & \mbox{} - \step\plbr{x - x_{\llk{max}}}
		\plbr{c_1 \plbr{x - x_{\llk{max}}} + c_2 v + c_3 \dot{v}} \\
	\dot{x} & = & v
\end{eqnarray*}
where $p_g=p_{g0}\plbr{\frac{l}{l - x}}^{\gamma}$ and $q=\rho A v$.

\subsection{Actuator}
The hydraulic actuator element couples the hydraulic library 
with the structural library.
It connects the displacement of two structural nodes to the flow
through two hydraulic nodes, and the pressure at two hydraulic nodes
to the forces applied at two structural nodes.
In the spirit of the multibody analysis philosophy, this element
provides the essential connection between structural 
and hydraulic nodes; the constraints between the structural nodes, 
and other flow elements, e.g.\ leakages between the chambers, 
must be added by the user.

\subsection{Definitions}
In the following, $\plbr{\cdot}_{s1}$ and $\plbr{\cdot}_{s2}$
refer to structural nodes 1 and 2, 
and $\plbr{\cdot}_{h1}$ and $\plbr{\cdot}_{h2}$
refer to hydraulic nodes 1 and 2.
The structural node labeled as 1 is assumed as the cylinder,
and its orientation determines the axis of the actuator.
The relative orientation of the actuator is defined by the unit vector
$\T{\tilde{v}}$, and the absolute orientation is $\T{R}_{s1} \T{\tilde{v}}$.
It is assumed that appropriate kinematic constraints allow only 
a relative displacement of the structural nodes along 
the axis $\T{\tilde{v}}$, and the only relative rotation, 
if any, is about the axis itself.
This can be obtained by combining an inline joint with 
a revolute rotation or a prismatic joint.

\subsection{Equations}
\begin{eqnarray*}
	0 & = & -\T{F} \\
	0 & = & -\T{f}_{s1}\times\T{F} \\
	0 & = & \T{F} \\
	0 & = & \T{f}_{s2}\times\T{F} \\
	0 & = & q_{h1} \\
	0 & = & q_{h2} \\
	p_{h1} & = & P_{h1} \\
	p_{h2} & = & P_{h2}
\end{eqnarray*}
The first four equations apply the force resulting from the hydraulic 
pressure to the structural nodes; the fifth and the sixth apply 
the flow resulting from the actuator kinematics to the flow balance
equations of the hydraulic nodes.
The last two equations are required to associate two scalar
differential unknowns to the hydraulic node pressures, because 
the flow definitions require the derivative of the pressure, 
while the hydraulic nodes are defined as scalar algebraic.

The force is defined as
\begin{displaymath}
	\T{F} = \plbr{A_{h1} p_{h1} - A_{h2} p_{h2}}
		\plbr{\T{R}_{s1} \T{\tilde{v}}}
\end{displaymath}
The distance between the structural nodes, along the actuator axis, is
\begin{displaymath}
	l = \plbr{\T{R}_{s1} \T{\tilde{v}}}^T \plbr{
		\T{x}_{s2} + \T{f}_{s2} - \T{x}_{s1} - \T{f}_{s1}
	}
\end{displaymath}
The relative velocity of the structural nodes, along the actuator axis, is
\begin{displaymath}
	\dot{l} = \plbr{\T{R}_{s1} \T{\tilde{v}}}^T \plbr{
		\dot{\T{x}}_{s2} - \dot{\T{x}}_{s1} 
		+ \T{\omega}_{s1}\times\plbr{\T{x}_{s2} - \T{x}_{s1}}
		+ \plbr{\T{\omega}_{s2} - \T{\omega}_{s1}}\times\T{f}_{s2}
	}
\end{displaymath}
The flow at the two hydraulic nodes is
\begin{eqnarray*}
	q_{h1} & = & A_{h1} \plbr{
		l \frac{\partial\rho_{h1}}{\partial{p}}\dot{P}_{h1}
		+ \rho_{h1} \dot{d}
	} \\
	q_{h2} & = & A_{h2} \plbr{
		\plbr{L - l} \frac{\partial\rho_{h2}}{\partial{p}}\dot{P}_{h2}
		- \rho_{h2} \dot{d}
	}
\end{eqnarray*}
where $\rho$ is the fluid density (different fluids in the chambers 
are allowed), and $L$ is the total length of the actuator.
In case stroke limitations must be enforced, the kinematic 
constraints must account for them.


\subsection{Dynamic Pipe}
Finite Volume dynamic pipe.

\subsection{Definitions}
The dynamic pipe is formulated according to the finite volume approach.
The pipe is discretized by means of the pressures and the flow 
at the two ends, which are interpolated linearly.
The mass and the momentum balance equations are written by cutting
the pipe in two halves and adding the contribution of each resulting
subvolume to the respective nodal equations.


Consider the mass conservation and the momentum balance equations for a
one-dimensional flow:
\begin{eqnarray}
    \frac{D}{Dt}\plbr{dm} & = & 0 , \label{eq:MASS} \\
    \frac{D}{Dt}\plbr{dQ} & = & df . \label{eq:MOMENTUM}
\end{eqnarray}
When a rigid pipe is considered, the total derivative $D/Dt$ of the test
mass $dm=\rho{Adx}$ of Equation~(\ref{eq:MASS}) yields 
\begin{displaymath} 
    \frac{D}{Dt}\plbr{dm} \ = \ 
    \frac{\partial}{\partial{t}}\plbr{dm}
    + v \frac{\partial}{\partial{x}}\plbr{dm} ,
\end{displaymath}
which results in
\begin{displaymath}
    q_{/x} + A\rho_{/t} \ = \ 0 ,
\end{displaymath}
where $q=\rho{Av}$ is the mass flux.
Consider now the momentum equation~(\ref{eq:MOMENTUM}); the total derivative
of the momentum $dQ=vdm$ yields
\begin{displaymath}
    \frac{D}{Dt}\plbr{dQ} \ = \ \plbr{q_{/t} + \plbr{qv}_{/x}}dx ,
\end{displaymath}
while the pressure gradient and the viscous contributions can be isolated
from the force per unit length on the right hand side:
\begin{displaymath}
    df \ = \ - Adp + f_v dx + df^* ,
\end{displaymath}
so, by neglecting the deformability of the pipe and the extra forces $df^*$
acting on the fluid, the momentum balance equation yields
\begin{displaymath}
    q_{/t} + \plbr{qv + Ap}_{/x} \ = \ f_v ,
\end{displaymath}
which can be reduced to the pressure and flux unknowns simply by recalling
the definition of the flux:
\begin{displaymath}
    q_{/t} + \plbr{\frac{q^2}{\rho{A}} + Ap}_{/x} \ = \ f_v .
\end{displaymath}
A flexible pipe has been considered as well; the formulation is not reported
for simplicity, because such a level of detail is required only for very
specialized problems, and a first approximation can be obtained by altering
the bulk modulus of the fluid.

The pipe is discretized by considering a finite volume approach, based on
the use of constant stepwise ({\em Heavyside}) test functions with arbitrary
trial functions.
In the present case, linear trial functions have been considered both for
the flux and for the pressure:
\begin{eqnarray*}
    q\plbr{x} & = & \sqbr{\matr{cc}{
        \cfrac{1 - \xi}{2} &
        \cfrac{1 + \xi}{2}
    }}\cubr{\cvvect{
        q_1 \\
        q_2
    }} , \\
    p\plbr{x} & = & \sqbr{\matr{cc}{
        \cfrac{1 - \xi}{2} &
        \cfrac{1 + \xi}{2}
    }}\cubr{\cvvect{
        p_1 \\
        p_2
    }} ,
\end{eqnarray*}
with $\xi=\xi\plbr{x}\in\sqbr{-1,1}$ and $d\xi/dx=2/\plbr{b-a}$.
The discrete form of the pipe equations results in
\begin{eqnarray*}
    \lefteqn{
        q\plbr{b} - q\plbr{a} \ = \
        - \intg{a}{b}{\frac{\partial\rho}{\partial{p}}p_{/t}}{dx} ,
    } \hspace{20mm} \\
    \lefteqn{
        \frac{b-a}{2}\plbr{
            q\plbr{b}_{/t} + q\plbr{a}_{/t}
        } + \plbr{
            \frac{q\plbr{b}^2}{\rho\plbr{b} A} + A p\plbr{b}
        }
    } \hspace{40mm} \\
    \mbox{} - \plbr{
        \frac{q\plbr{a}^2}{\rho\plbr{a} A} + A p\plbr{a}
    } & = & \intg{a}{b}{f_v}{dx} ;
\end{eqnarray*}
by dividing the pipe in two portions, and by considering the domains
$\sqbr{-1,0}$ and $\sqbr{0,1}$ for $\xi$ in each portion, the discrete
equations of the finite volume pipe become
\begin{eqnarray*}
    \lefteqn{
    - \frac{1}{2}\plbr{
        q_1 + q_2
    } - \frac{\partial\rho\plbr{-1/2}}{\partial{p}}\frac{L}{8}\plbr{
        3 \dot{p}_1 + \dot{p}_2
    } \ = \ \phi_1 , 
    } \hspace{60mm} \\
    \lefteqn{
    \frac{1}{2}\plbr{
        q_1 + q_2
    } - \frac{\partial\rho\plbr{1/2}}{\partial{p}}\frac{L}{8}\plbr{
        \dot{p}_1 + 3 \dot{p}_2
    } \ = \ \phi_2 , 
    } \hspace{54.5mm} \\
    \lefteqn{
    \frac{L}{8}\plbr{
        3 \dot{q}_1 + \dot{q}_2
    } + % \frac{q\plbr{0}^2}{\rho\plbr{0}A}
    \frac{\plbr{q_1+q_2}^2}{4\rho\plbr{0}A}
    - \frac{q_1^2}{\rho\plbr{-1}A}
    } \hspace{60mm} \\
    \lefteqn{
    \mbox{} + \frac{A}{2}\plbr{
        p_2 - p_1
    } \ = \ \frac{L}{2}\intg{-1}{0}{f_v}{d\xi} , 
    } \hspace{40mm} \\
    \lefteqn{
    \frac{L}{8}\plbr{
        \dot{q}_1 + 3 \dot{q}_2
    } + \frac{q_2^2}{\rho\plbr{1}A}
    - % \frac{q\plbr{0}^2}{\rho\plbr{0}A}
    \frac{\plbr{q_1+q_2}^2}{4\rho\plbr{0}A}
    } \hspace{60mm} \\
    \lefteqn{
    \mbox{} + \frac{A}{2}\plbr{
        p_2 - p_1
    } \ = \ \frac{L}{2}\intg{0}{1}{f_v}{d\xi} ,
    } \hspace{40mm}
\end{eqnarray*}
where $\phi_1$ and $\phi_2$ are the contributions of the two portions of
pipe to the respective nodal flux balance equations.
The integral of the time derivative of the density is numerically computed.
The integral of the viscous forces per unit length is numerically performed
as well, accounting for the flow regime in the pipe as function of the
{\em Reynolds}\ number.
In fact, for the forces per unit length, the dependency on the flux is
considered linear for $0<Re<2000$, and quadratic for $Re>4000$, while a
polynomial fitting of the transition behavior, accounting also for the rate
of the {\em Reynolds}\ number, is modeled for $2000<Re<4000$.

\subsubsection{Equations}
\begin{eqnarray*}
	0 & = & \frac{1}{2}\plbr{q_1 + q_2}
		+ A L \frac{\partial\rho}{\partial{p}}_1 
		\plbr{\frac{3}{8} \dot{P}_1 + \frac{1}{8} \dot{P}_2} \\
	0 & = & -\frac{1}{2}\plbr{q_1 + q_2}
		+ A L \frac{\partial\rho}{\partial{p}}_2 
		\plbr{\frac{1}{8} \dot{P}_1 + \frac{3}{8} \dot{P}_2} \\
	0 & = & - L \plbr{\frac{3}{8} \dot{q}_1 + \frac{1}{8} \dot{q}_2}
		- \plbr{\frac{1}{2}\plbr{q_1 + q_2}}^2 \frac{1}{\rho_m A}
		+ q_1^2 \frac{1}{\rho_1 A}
		- \frac{A}{2}\plbr{p_2 - p_1}
		- f_1 \\
	0 & = & - L \plbr{\frac{1}{8} \dot{q}_1 + \frac{3}{8} \dot{q}_2}
		- q_2^2 \frac{1}{\rho_2 A}
		+ \plbr{\frac{1}{2}\plbr{q_1 + q_2}}^2 \frac{1}{\rho_m A}
		- \frac{A}{2}\plbr{p_2 - p_1}
		- f_2 \\
	p_1 & = & P_1 \\
	p_2 & = & P_2
\end{eqnarray*}



\bibliographystyle{unsrt}
\bibliography{mybib}


\pagebreak
\noindent
Pierangelo Masarati \\
Dipartimento di Ingegneria Aerospaziale, Politecnico di Milano \\
via La Masa 34, 20156 Milano, Italy \\
Tel.: ++39 02 2399 8309 \\
Fax: ++39 02 2399 8334 \\
E-mail: \htmladdnormallink{\texttt{masarati@aero.polimi.it}}{mailto:masarati@aero.polimi.it} \\
Web: \htmladdnormallink{\texttt{http://www.aero.polimi.it/\~{}mbdyn/}}{http://www.aero.polimi.it/~mbdyn/} \\
Web: \htmladdnormallink{\texttt{http://www.aero.polimi.it/\~{}masarati/}}{http://www.aero.polimi.it/~masarati/} \\
Web: \htmladdnormallink{\texttt{http://mbdyn.aero.polimi.it/\~{}masarati/MBDyn-input/manual/index.html}}{http://mbdyn.aero.polimi.it/~masarati/MBDyn-input/manual/index.html}

\end{document}
