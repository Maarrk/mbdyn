% MBDyn (C) is a multibody analysis code.
% http://www.mbdyn.org
%
% Copyright (C) 1996-2003
%
% Pierangelo Masarati  <masarati@aero.polimi.it>
%
% Dipartimento di Ingegneria Aerospaziale - Politecnico di Milano
% via La Masa, 34 - 20156 Milano, Italy
% http://www.aero.polimi.it
%
% Changing this copyright notice is forbidden.
%
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation (version 2 of the License).
% 
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

\documentclass[10pt,dvips]{report}

%\usepackage[pdftex]{graphicx}
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{html}

\input{stdmacro}
%poor man's bold symbol
\newcommand{\T}[1]{\boldsymbol{#1}}

\begin{document}

\begin{latexonly}
\title{\bf MBDyn Technical Manual \\
Version
\input{version}
}
\author{Pierangelo Masarati \vspace{5mm}\\
    \sc Dipartimento di Ingegneria Aerospaziale \\
    \sc Politecnico di Milano}
\date{\today}
\maketitle
\end{latexonly}

\begin{htmlonly}
\begin{center}
\textbf{\LARGE MBDyn Technical Manual}

\emph{\large Pierangelo Masarati}

\textsc{Dipartimento di Ingegneria Aerospaziale \\ Politecnico di Milano}

\today
\end{center}
\end{htmlonly}




\tableofcontents
\newpage

\chapter{Introduction}
This document describes details about the formulation MBDyn:
Multi-Body Dynamics relies on.

\chapter{Parsing}
The parser ... bla... bla.. 

\section{HighParser} ... 
The \texttt{HighParser} class and its descendants use a \texttt{KeyTable}
object containing a list of legal keywords to return a valid keyword index
when \texttt{HighParser::GetWord()}, and significantly 
\texttt{HighParser::GetDescription()} are invoked.
The \texttt{KeyTable} can be changed during parsing.
\texttt{KeyTable} is a class.
Its constructor takes a pointer to an array of strings and a reference 
to the \texttt{HighParser} object.
The last string in the array must be null.
The \texttt{KeyTable} class constructor keeps track 
of previous \texttt{KeyTable} objects in the \texttt{HighParser}, 
and restores them upon destruction.
The suggested usage inside a stacked call sequence of parsing functions is
\begin{verbatim}
Part *
read_part(HighParser& HP)
{
    /* prepare names */
    enum KeyWord { KEYWORD1, KEYWORD2, KEYWORD_LAST };
    char *key_table_array[] = { "keyword1", "keyword2", 0 };
    /* build KeyTable class */
    KeyTable k(HP, key_table_array);
    Part *returned_object = 0;
    /* parse input */
    do {
        switch (KeyWord(HP.GetWord())) {
        default:
            /* do something... */
            break;
        case KEYWORD1:
            /* ...and build returned_object  */
            return returned_object;
        }
    } while (true);
}

void
read_all(HighParser& HP)
{
    /* prepare names */
    enum KeyWord { KEY1, KEY2, PART, KEY_LAST };
    char *keytable[] = { "key1", "key2", "part", 0 };
    /* build KeyTable class */
    KeyTable k(HP, keytable);
    /* do something */
    Part *part = 0;
    do {
        switch (KeyWord(HP.GetWord())) {
        default:
            /* do something... */
            break;
        case PART:
            /* read part */
            Part *part = read_part(HP);
            break;
        }
    } while (true);
}

\end{verbatim}
Here the \texttt{KeyTable} set by function \texttt{read\_all()} 
is automatically restored after the call to \texttt{read\_part()}; 
\texttt{read\_part()} temporarily changes the \texttt{KeyTable}
used by the parser.

\section{LowParser} ... 
\section{MathParser} ...

\chapter{Solvers}
...
\section{Linear solvers}
...
\section{Non linear solvers}
...
\section{Parallel solver}
\subsection{Partitioning}
\texttt{iTotVertices} is equal to the sum of nodes and elements. 
It is made in this way because we want the partitioner 
to generate a twofold subdivision:
\begin{itemize}
\item a subdivision related to elements; 
this subdivision is done in order to share the computational 
load during the assembly phase;
\item a subdivision related to nodes, 
which is necessary for the solving phase with the substructuring method.
\end{itemize}
Of course this two partitions must be connected, 
so we build created a graph which is made of nodes and elements as vertex. 
The connection between vertexes are only between nodes and elements. 
There is no node to node or element to element connection.

\texttt{pVertexWgts} 
contains what we call the computational weight of each entity, 
so nodes have weight null while elements has a weight related to 
the dimension of the submatrix of the Jacobian assembled by each one of them.

\texttt{pCommWgts} contains the communication weights 
(see metis documentation) which are a measure of the quantity 
of data which needs to be sent if the i-th vertex is part 
of an interface between different partitions. 
This means that nodes have a \texttt{CommWgts} equal to the number 
of dofs while elements have a weight equal to eventual internal dofs of it.


\chapter{Integration}

\begin{itemize}

\item[differential variable:] a variable is declared differential
in \texttt{SimulationEntity::GetDofType()} 
by returning \texttt{DofOrder::DIFFERENTIAL}.
The increment of the value of a differential variable is equal 
to $\Delta x=d_{Coef}\Delta \dot{x}$.
When writing the jacobian, this must be considered;
as a consequence, for an equation $f=0$ (the residual is $-f$)
the linearization is 
$f_{/\dot{x}}+f_{/x}*d_{Coef})*\Delta \dot{x}=-f$, 
as $d_{Coef}*\Delta \dot{x}=\Delta x$.

\item[algebraic variable:] a variable is declared algebraic
in \texttt{SimulationEntity::GetDofType()}
by returning \texttt{DofOrder::ALGEBRAIC}.
The increment of the value of an algebraic variable is the increment 
of the variable.

\item[differential equation:] an equation is declared differential
in \texttt{SimulationEntity::GetEqType()}
by returning \texttt{DofOrder::DIFFERENTIAL}.
An equation $f=0$ must be declared differential if $f_{/\dot{x}}$ is not null.
The residual is $-f$, and its linearization is:
$\plbr{f_{/\dot{x}}+f_{/x}*d_{Coef}}*\Delta \dot{x}=-f$.

\item[algebraic equation:] an equation is declared algebraic
in \texttt{SimulationEntity::GetEqType()}
by returning \texttt{DofOrder::ALGEBRAIC}.
An equation $f=0$ can be declared algebraic iff $f_{/\dot{x}}$ 
is structurally null (e.g.\ regardless of the values the state may assume) 
and $x$ is not algebraic.
If an equation $f\plbr{x,t}=0$ is declared differential,
the residual is $-f$, and its linearization is:
$f_{/x}*d_{Coef}*\Delta \dot{x}=-f$.
If the equation can be declared algebraic, it can be divided by $d_{Coef}$:
$f/d_{Coef}=0$, with residual $-f/d_{Coef}$,
and linearization $f_{/x}*\Delta \dot{x} = -f/d_{Coef}$.
This helps scaling the equations.
Clearly, this has no sense if $x$ is algebraic,
or if $f_{/\dot{x}} \neq 0$.

\end{itemize}

\section{Nodal rotation}
The rotational gdl unknown during \texttt{AssRes()} and \texttt{AssJac()}
are the increment of (Gibbs-Rodriguez) rotation parameters
with respect to the reference configuration.
Of course the increment of the parameter is
$\Delta \T g=d_{Coef}\Delta \dot{\T g}$.
The increment of angular velocity is 
$\Delta \T \omega = \T G\Delta \dot{\T g}+ \Delta \T G \dot{\T g}-
\T \omega_{ref}\times \T G \Delta \T g$,
where $\T G(\T g)$ is the tensor relating $\T g_\delta$ to $\delta \T g$,
and $\T \omega_{ref}$ is the nodal referenc angular velocity (Wref).
We assume $\T G = \T I$ and $\Delta \T G = \T 0$,
so that $\Delta \T \omega = \Delta \dot{\T g}-\T \omega_{ref}\times\Delta \T g$
and so $\Delta \T \omega = \Delta \dot{\T g}-
\T \omega_{ref}\times\Delta \dot{\T g} * d_{Coef}$.

\chapter{Data Structure}

\chapter{Constraints}

\section{Algebraic Constraints}

\subsection{Distance Joint}

\subsubsection{Distance Joint Without Offsets}
Definitions
\begin{displaymath}
	u = \frac{1}{d}\plbr{x_2 - x_1}
\end{displaymath}
Limitations
\begin{displaymath}
	d > 0
\end{displaymath}
Constraint Equation
\begin{displaymath}
	d \sqrt{u^T u} = d
\end{displaymath}
Forces
\begin{eqnarray*}
	F_1 & = & \alpha u \\
	F_2 & = & -\alpha u
\end{eqnarray*}
Linearization
\begin{displaymath}
	\sqbr{\matr{ccc}{
		\frac{\alpha}{d}I & -\frac{\alpha}{d}I & -u \\
		-\frac{\alpha}{d}I & \frac{\alpha}{d}I & u \\
		-u^T & u^T & 0
	}}\cubr{\cvvect{
		\Delta{x_1} \\
		\Delta{x_2} \\
		\Delta{\alpha}
	}} = \cubr{\cvvect{
		\alpha u \\
		- \alpha u \\
		d\plbr{1 - \sqrt{u^T u}}
	}}
\end{displaymath}
Constraint Equation Derivative
\begin{displaymath}
	d u^T \dot{u} = 0
\end{displaymath}
Force Derivatives
\begin{eqnarray*}
	\dot{F}_1 & = & \alpha \dot{u} + \dot{\alpha} u \\
	\dot{F}_2 & = & -\alpha \dot{u} - \dot{\alpha} u
\end{eqnarray*}
Linearization
\begin{displaymath}
        \sqbr{\matr{cccccc}{
		\frac{\dot{\alpha}}{d}I & \frac{\alpha}{d}I &
			-\frac{\dot{\alpha}}{d}I & -\frac{\alpha}{d}I &
			-\dot{u} & -u \\
		-\frac{\dot{\alpha}}{d}I & -\frac{\alpha}{d}I &
			\frac{\dot{\alpha}}{d}I & \frac{\alpha}{d}I &
			\dot{u} & u \\
		-\dot{u}^T & -u^T & \dot{u}^T & u^T & 0 & 0
	}}\cubr{\cvvect{
		\Delta{x_1} \\
		\Delta{\dot{x}_1} \\
		\Delta{x_2} \\
		\Delta{\dot{x}_2} \\
		\Delta{\alpha} \\
		\Delta{\dot{\alpha}}
	}} = \cubr{\cvvect{
		\alpha \dot{u} + \dot{\alpha} u \\
		-\alpha \dot{u} - \dot{\alpha} u \\
		d u^T \dot{u}
	}}
\end{displaymath}




\subsubsection{Distance Joint With Offsets}
Definitions:
\begin{displaymath}
	u = \frac{1}{d}\plbr{x_2 + f_2 - x_1 - f_1}
\end{displaymath}
Limitations:
\begin{displaymath}
	d > 0
\end{displaymath}
Constraint equation 
\begin{displaymath}
	d \sqrt{u^T u} = d
\end{displaymath}
Forces:
\begin{eqnarray*}
	F_1 & = & \alpha u \\
	M_1 & = & \alpha f_1 \times u \\
	F_2 & = & -\alpha u \\
	M_2 & = & -\alpha f_2 \times u
\end{eqnarray*}
Linearization:
\begin{displaymath}
	\sqbr{\matr{ccccc}{
		\frac{\alpha}{d}I & -\frac{\alpha}{d}f_1\times{} &
			-\frac{\alpha}{d}I & \frac{\alpha}{d}f_2\times{} & -u \\
		\frac{\alpha}{d}f_1\times{} & 
			-\frac{\alpha}{d}\plbr{f_1 + u}\times{f_1\times{}} &
			-\frac{\alpha}{d}f_1\times{} & 
			\frac{\alpha}{d}f_1\times{f_2\times{}} & 
			-f_1\times{u} \\
		-\frac{\alpha}{d}I & \frac{\alpha}{d}f_1\times{} &
			\frac{\alpha}{d}I & -\frac{\alpha}{d}f_2\times{} & u \\
		-\frac{\alpha}{d}f_2\times{} &
			\frac{\alpha}{d}f_2\times{f_1\times{}} &
			\frac{\alpha}{d}f_2\times{} &
			- \frac{\alpha}{d}\plbr{f_2 - u}\times{f_2\times{}} &
			f_2\times{u} \\
		-u^T & - \plbr{f_1\times{u}}^T & 
			u^T & \plbr{f_2\times{u}}^T & 0
	}}\cubr{\cvvect{
		\Delta{x_1} \\
		\Delta{g_1} \\
		\Delta{x_2} \\
		\Delta{g_2} \\
		\Delta{\alpha}
	}}
\end{displaymath}
\begin{displaymath}
	\mbox{\hspace{100mm}} = \cubr{\cvvect{
		\alpha u \\
		\alpha f_1\times{u} \\
		-\alpha u \\
		-\alpha f_2\times{u} \\
		d\plbr{1 - \sqrt{u^T u}}
	}}
\end{displaymath}
Constraint Equation Derivative
\begin{displaymath}
	d u^T\dot{u} = 0
\end{displaymath}
Forces:
\begin{eqnarray*}
	\dot{F}_1 & = &  \alpha \dot{u} + \dot{\alpha} u \\
	\dot{M}_1 & = & \alpha \plbr{\omega_1\times{f_1}} \times u 
		+ \alpha f_1 \times \dot{u}
		+ \dot{\alpha} f_1 \times u \\
	\dot{F}_2 & = & -\alpha \dot{u} - \dot{\alpha} u \\
	\dot{M}_2 & = & -\alpha \plbr{\omega_2 \times{f_2}} \times u
		- \alpha f_2 \times \dot{u}
		- \dot{\alpha} f_2 \times u
\end{eqnarray*}
Linearization:





\subsection{Revolute hinge (PlaneHingeJoint)}
Joint data
\begin{displaymath}
\T d_1, \T d_2, \T R_{h1}, \T R_{h2}
\end{displaymath}
where:\\
$\T d_1$, $\T d_2$: offset of nodes 1,2 in node reference;\\
$\T R_{h1}$, $\T R_{h2}$: joint relative orientation wrt. nodes 1,2 (FIXME).\\

\noindent
Constraint equations (normalized by dCoef)
\begin{eqnarray*}
	(\T x_1+\T R_1\cdot \T d_1) - (\T x_2+\T R_1\cdot \T d_2)& = & 0 \\
	(\T R_1\cdot \T R_{h1})[3]\cdot (\T R_2\cdot \T R_{h2})[2] & = & 0 \\
	(\T R_1\cdot \T R_{h1})[3]\cdot (\T R_2\cdot \T R_{h2})[1] & = & 0 \\
\end{eqnarray*}
where:\\
$\T x_1$, $\T x_2$: positions of nodes 1,2;\\
$\T R_{1}$, $\T R_{2}$: orientation of nodes 1, 2.\\

\noindent
Residual vector:
\begin{eqnarray*}
	\mathrm{node1\ momentum}:\ 1-3& -= & \T F\\
	\mathrm{node1\ angular\ momentum}:\ 4-6& -= & 
		(\T R_1\cdot \T d_1) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2]\\
	\mathrm{node2\ momentum}:\ 7-9& += & \T F\\
	\mathrm{node2\ angular\ momentum}:\ 10-12& += & 
		(\T R_2\cdot \T d_2) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2]\\
	\mathrm{constraint}:\ 13-15& = &  ((\T x_1+\T R_1\cdot \T d_1) - 
			(\T x_2+\T R_1\cdot \T d_2))/dCoef\\
	\mathrm{constraint}:\ 16& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[2])/dCoef\\
	\mathrm{constraint}:\ 17& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[1])/dCoef\\
\end{eqnarray*}
where:\\
$\T F$: constraint reaction force;\\
$\T M$: constraint moment reaction (third component null).\\

\noindent
Friction:
\begin{itemize}
\item add third component of constraint moment $\T M$
\item add a costraint equation; this could be one of the following:
	\begin{itemize}
	\item direct definition of $\T M[3]$ in function of relative velocity,
		friction coeff and $\T F$
	\item impose null relative velocity
	\end{itemize}
\item optionally add internal states dynamic $z$ (for friction)
\end{itemize}
\subsubsection{add third component of constraint moment $\T M$}
Residual vector:
\begin{eqnarray*}
	\mathrm{node1\ momentum}:\ 1-3& -= & \T F\\
	\mathrm{node1\ angular\ momentum}:\ 4-6& -= & 
		(\T R_1\cdot \T d_1) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]*\T M[3]\\
	\mathrm{node2\ momentum}:\ 7-9& += & \T F\\
	\mathrm{node2\ angular\ momentum}:\ 10-12& += & 
		(\T R_2\cdot \T d_2) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]*\T M[3]\\
	\mathrm{constraint}:\ 13-15& = &  ((\T x_1+\T R_1\cdot \T d_1) - 
			(\T x_2+\T R_1\cdot \T d_2))/dCoef\\
	\mathrm{constraint}:\ 16& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[2])/dCoef\\
	\mathrm{constraint}:\ 17& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[1])/dCoef\\
	\mathrm{friction:}\ 18& = &  \T M[3] -f(\T F, v, 
			\mathrm{friction\ coef})\\
		& = &  (\mathrm{rel\ velocity})[3]\\
	\mathrm{(optional)\ friction\ states:}\ 19...& = &  \dot{z} - g(z,v)
\end{eqnarray*}
where $v$ is the relative velocity
$v = r * (\T \omega_{1}-\T \omega_{2})\cdot(\T R_1\cdot \T R_{h1})[3]$.
The constraint is based on positions. This means that during integration 
$(\T \omega_{1}-\T \omega_{2})$ will NOT have exactly the
direction $(\T R_1\cdot \T R_{h1})[3]$. We choose to disregard this error.
The friction moment should be along $(\T R_1\cdot \T R_{h1})[3]$.\\
$r$ is the joint radius.\\
CHECK THIS!!!\\
Explicit form of friction moment contribution 
(FIXME: remove vector $(\T R_1\cdot \T R_{h1})[3]$ and write scalar equation???):\\
$f(\T F, \mathrm{rel\ velocity})$:
$\T M[3] = \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * (\T R_1\cdot \T R_{h1})[3] * 
	||\T F|| * f_{\mathrm{c}}(v,z,\dot{z})$,\\
with $\T R_{h1}$ constant.\\
Variation of friction moment contribution:
\begin{eqnarray*}
\delta (\T M[3] (\T R_1\cdot \T R_{h1})[3])
	&=& \T M[3] * (\T R_{\delta 1} \times \T R_1)[3]+\\
	&& (\T R_1\cdot \T R_{h1})[3]) * \delta \T M[3]\\
	&=& \T M[3] * \T R_1^T \cdot (\T R_{\delta 1} \times )[3]+\\
	&& (\T R_1\cdot \T R_{h1})[3]) * \delta \T M[3]
\end{eqnarray*}
Variation of friction moment contribution component:
\begin{eqnarray*}
\delta \T M[3] &=& \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * 
		f_{\mathrm{c}}(v,z,\dot{z}) *
		\frac{\displaystyle\T F}{\displaystyle||\T F||} 
		\cdot \delta \T F+\\
	&& \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * (\T R_1\cdot \T R_{h1})[3] * 
		||\T F|| *
		\frac{\displaystyle \partial f_{\mathrm{c}}}
			{\displaystyle \partial v} * \delta v+\\
	&&	||\T F|| * f_{\mathrm{c}}(v,z,\dot{z}) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
			{\displaystyle \partial ||\T F||} 
			\frac{\displaystyle \partial ||\T F||}{\displaystyle\partial\T F}
			\cdot \delta \T F+\\
	&&	||\T F|| * f_{\mathrm{c}}(v,z,\dot{z}) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
			{\displaystyle \partial f_{\mathrm{c}}(v,z,\dot{z})} *
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial v} * \delta v\\
	&=& \left (\begin{array}{l}
		\mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * 
			f_{\mathrm{c}}(v,z,\dot{z})
			\frac{\displaystyle\T F}{\displaystyle||\T F||}\\
		||\T F|| * f_{\mathrm{c}}(v,z,\dot{z}) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
			{\displaystyle \partial ||\T F||}
		\end{array} 
		\right )\cdot \delta \T F+\\
	&& \left ( \begin{array}{l}
		\mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z})) * ||\T F||\\
		||\T F|| * f_{\mathrm{c}}(v,z,\dot{z}) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
			{\displaystyle \partial f_{\mathrm{c}}(v,z,\dot{z})}
		\end{array} \right ) *
		\left\{\begin{array}{l}
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial v} * \delta v\\
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial z} * \delta z\\
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial \dot{z}} * \delta \dot{z}\\			
		\end{array}\right\}
\end{eqnarray*}
dove 
\begin{itemize}
\item
$v=r * (\T \omega_{1}-\T \omega_{2})\cdot(\T R_1\cdot \T R_{h1})[3]$
e quindi
\begin{eqnarray*}
\delta v &=& d * (\T R_1\cdot \T R_{h1})[3] \cdot (\delta \T \omega_{1}- \delta \T \omega_{2}) +\\
	&& d * (\T \omega_{1}-\T \omega_{2})\cdot (\T R_{\delta 1} \times \T R_1 \cdot \T R_{h1})[3]\\
	&=& d * (\T R_1\cdot \T R_{h1})[3] \cdot (\delta \T \omega_{1}- \delta \T \omega_{2}) +\\
	&& d * (\T \omega_{1}-\T \omega_{2})\cdot \T R_{h1}^T \cdot \T R_1^T \cdot (\T R_{\delta 1} \times )[3]
\end{eqnarray*}
\item
$
\mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))=
r * 
C_\alpha(
	\alpha(\mathrm{costants},
		f_{\mathrm{c}}(v,z,\dot{z}),
		||\T F||,
		f_{\mathrm{c}}(v,z,\dot{z})
	)
) 
\frac{\displaystyle 1}{\displaystyle \sqrt{1+f_{\mathrm{c}}^2(v,z,\dot{z})}}
$
\item
$
\alpha(\mathrm{costants},
	f_{\mathrm{c}}(v,z,\dot{z}),
	||\T F||,
	f_{\mathrm{c}}(v,z,\dot{z})
) =
\sin^{-1}\left(
	\sqrt{
		\frac{\displaystyle 2*31*||\T F||}
			{\displaystyle E*b*\sqrt{1+f_{\mathrm{c}}^2(v,z,\dot{z})}}
		\frac{\displaystyle r'/r}
			{\displaystyle r'-r}
	}
\right)
$
\item for very low joint loads (angle of contact $\alpha< 20^{\mathrm{o}}$,
i.e. about less that 1\% of the joint allowable load)
we can safely assume $C_\alpha\approx 1$
so that\\ 
$
\mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))\approx
r * 
\frac{\displaystyle 1}{\displaystyle \sqrt{1+f_{\mathrm{c}}^2(v,z,\dot{z})}}
$,\\

$
\frac{\displaystyle\partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
	{\displaystyle \partial ||\T F||} = \T 0
$\\
and\\
$
\frac{\displaystyle\partial \mathrm{sh\_c}(||\T F||, f_{\mathrm{c}}(v,z,\dot{z}))}
	{\displaystyle\partial \mathrm{f_{\mathrm{c}}(v,z,\dot{z})}} =
	-r * (1+f_{\mathrm{c}}^2(v,z,\dot{z}))^{-3/2}*f_{\mathrm{c}}(v,z,\dot{z})
$
\end{itemize}




\subsection{Drive Hinge}
This joint forces two nodes to assume a relative orientation
given by a rotation vector $\T{\theta}$, whose direction with respect
to node 1 represents the rotation axis, and whose amplitude represents 
the magnitude of the rotation.

\noindent
Definitions:
\begin{eqnarray*}
	\T{R}_{rel} & = & \T{R}_1^T \T{R}_2 \\
	\T{\theta} & = & \T{R}^{-1}\plbr{\T{R}_{rel}}
\end{eqnarray*}
Limitations:
\begin{displaymath}
	\nrbr{\T{\theta}} < \pi
\end{displaymath}
Constraint equation 
\begin{displaymath}
	\T{\theta} - \T{\theta}_0 = \T{0}
\end{displaymath}
Couples:
\begin{eqnarray*}
	\T{M}_1 & = & -\T{R}_1 \T{\alpha} \\
	\T{M}_2 & = & \T{R}_1 \T{\alpha}
\end{eqnarray*}
Linearization:
\begin{displaymath}
	\sqbr{\matr{ccc}{
		\plbr{\T{R}_1 \T{\alpha}}\times{} & 0 & -\T{R}_1 \\
		-\plbr{\T{R}_1 \T{\alpha}}\times{} & 0 & \T{R}_1 \\
		-\T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T &
			\T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T & 0
	}}\cubr{\cvvect{
		\delta\T{g}_1 \\
		\delta\T{g}_2 \\
		\delta\T{\alpha} \\
	}} = \cubr{\cvvect{
		\T{R}_1 \T{\alpha} \\
		-\T{R}_1 \T{\alpha} \\
		\T{\theta}_0 - \T{\theta}
	}}
\end{displaymath}
The linearization of the reaction moments contribution 
to the moment equilibrium equations of the nodes is straightforward.
The linearization of the contraint equation is a bit more complicated.
According to the definition of $\T{\theta}$, its linearization
yields
\begin{eqnarray*}
	\T{\theta}_{\delta}
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} 
			\llk{ax}\plbr{\delta\T{R}_{rel} \T{R}_{rel}^T} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} \llk{ax}\plbr{
			\delta\T{R}_1^T \T{R}_1
			+ \T{R}_1^T \delta\T{R}_2 \T{R}_2^T \T{R}_1
		} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} \llk{ax}\plbr{
			\T{R}_1^T \T{\theta}_{1\delta}\times{}^T \T{R}_1
			+ \T{R}_1^T \T{\theta}_{2\delta}\times{} \T{R}_1
		} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} \llk{ax}\plbr{
			- \T{R}_1^T \T{\theta}_{1\delta}\times{} \T{R}_1
			+ \T{R}_1^T \T{\theta}_{2\delta}\times{} \T{R}_1
		} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1}
			\llk{ax} \plbr{
				\T{R}_1^T \plbr{
					\T{\theta}_{2\delta}
					- \T{\theta}_{1\delta}
				}\times \T{R}_1
			} \\
		& = & \T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T \plbr{
			\T{\theta}_{2\delta} - \T{\theta}_{1\delta}
		}
\end{eqnarray*}
according to the updated-updated simplifications,
$\T{\theta}_{i\delta}\cong\Delta\T{g}_i$, thus resulting in
\begin{displaymath}
	\T{\theta}_{\delta} = \T{\Gamma}\plbr{\T{\theta}}^{-1} \T{R}_1^T \plbr{
		\Delta\T{g}_2 - \Delta\T{g}_1
	}
\end{displaymath}
note that $\T{\Gamma}\plbr{\T{\theta}}^{-1}$ does not simplify to $\T{I}$
because $\T{\theta}$ in general is a finite rotation.

%	\Delta\T{\theta} = \T{\theta}_0 - \T{\theta}








\section{Deformable Constraints}

\subsection{Deformable Hinge}


\chapter{Hydraulic Library}
\section{Hydraulic Fluids}
\section{Hydraulic Nodes}

\section{Hydraulic Elements}

\subsection{Accumulator}
The accumulator defines two internal states $x$ and $v$ that represent 
the position and the velocity of the cap that, in a conventional
gas device, separates the fluid and the gas.
However, both the gravity effect and a linear spring effect
can be considered as well, and any combination of reaction forces
can be modeled by setting the appropriate parameters:
$g$ for a gravity device, $p_{g0}$ for a gas device, 
and $k$ for a linear spring device.
\begin{eqnarray*}
	0 & = & q \\
	m \dot{v} + k x & = & 
		- m g
		+ A p \plbr{p - p_g}
		- f_0 
		- \frac{1}{2} \rho A c_e \plbr{\frac{A}{A_p}}^2 \shbr{v} v \\
	& & \mbox{} - \step\plbr{x_{\llk{min}} - x}
		\plbr{c_1 \plbr{x - x_{\llk{min}}} + c_2 v + c_3 \dot{v}} \\
	& & \mbox{} - \step\plbr{x - x_{\llk{max}}}
		\plbr{c_1 \plbr{x - x_{\llk{max}}} + c_2 v + c_3 \dot{v}} \\
	\dot{x} & = & v
\end{eqnarray*}
where $p_g=p_{g0}\plbr{\frac{l}{l - x}}^{\gamma}$ and $q=\rho A v$.

\subsection{Actuator}
The hydraulic acutator element couples the hydraulic library 
with the structural library.
It connects the displacement of two structural nodes to the flow
through two hydraulic nodes, and the pressure at two hydraulic nodes
to the forces applied at two structural nodes.
In the spirit of the multibody analysis philosophy, this element
provides the essential connection between structural 
and hydraulic nodes; the coinstraints between the structural nodes, 
and other flow elements, e.g.\ leakages between the chambers, 
must be added by the user.

\subsection{Definitions}
In the following, $\plbr{\cdot}_{s1}$ and $\plbr{\cdot}_{s2}$
refer to structural nodes 1 and 2, 
and $\plbr{\cdot}_{h1}$ and $\plbr{\cdot}_{h2}$
refer to hydraulic nodes 1 and 2.
The structural node labeled as 1 is assumed as the cylinder,
and its orientation determines the axis of the actuator.
The relative orientation of the actuator is defined by the unit vector
$\T{\tilde{v}}$, and the absolute orientation is $\T{R}_{s1} \T{\tilde{v}}$.
It is assumed that appropriate kinematic constraints allow only 
a relative displacement of the structural nodes along 
the axis $\T{\tilde{v}}$, and the only relative rotation, 
if any, is about the axis itself.
This can be obtained by combining an inline joint with 
a revolute rotation or a prismatic joint.

\subsection{Equations}
\begin{eqnarray*}
	0 & = & -\T{F} \\
	0 & = & -\T{f}_{s1}\times\T{F} \\
	0 & = & \T{F} \\
	0 & = & \T{f}_{s2}\times\T{F} \\
	0 & = & q_{h1} \\
	0 & = & q_{h2} \\
	p_{h1} & = & P_{h1} \\
	p_{h2} & = & P_{h2}
\end{eqnarray*}
The first four equations apply the force resulting from the hydraulic 
pressure to the structural nodes; the fifth and the sixth apply 
the flow resulting from the actuator kinematics to the flow balance
equations of the hydraulic nodes.
The last two equations are required to associate two scalar
differential unknowns to the hydraulic node pressures, because 
the flow definitions require the derivative of the pressure, 
while the hydraulic nodes are defined as scalar algebraic.

The force is defined as
\begin{displaymath}
	\T{F} = \plbr{A_{h1} p_{h1} - A_{h2} p_{h2}}
		\plbr{\T{R}_{s1} \T{\tilde{v}}}
\end{displaymath}
The distance between the structural nodes, along the actuator axis, is
\begin{displaymath}
	l = \plbr{\T{R}_{s1} \T{\tilde{v}}}^T \plbr{
		\T{x}_{s2} + \T{f}_{s2} - \T{x}_{s1} - \T{f}_{s1}
	}
\end{displaymath}
The relative velocity of the structural nodes, along the actuator axis, is
\begin{displaymath}
	\dot{l} = \plbr{\T{R}_{s1} \T{\tilde{v}}}^T \plbr{
		\dot{\T{x}}_{s2} - \dot{\T{x}}_{s1} 
		+ \T{\omega}_{s1}\times\plbr{\T{x}_{s2} - \T{x}_{s1}}
		+ \plbr{\T{\omega}_{s2} - \T{\omega}_{s1}}\times\T{f}_{s2}
	}
\end{displaymath}
The flow at the two hydraulic nodes is
\begin{eqnarray*}
	q_{h1} & = & A_{h1} \plbr{
		l \frac{\partial\rho_{h1}}{\partial{p}}\dot{P}_{h1}
		+ \rho_{h1} \dot{d}
	} \\
	q_{h2} & = & A_{h2} \plbr{
		\plbr{L - l} \frac{\partial\rho_{h2}}{\partial{p}}\dot{P}_{h2}
		- \rho_{h2} \dot{d}
	}
\end{eqnarray*}
where $\rho$ is the fluid density (different fluids in the chambers 
are allowed), and $L$ is the total length of the actuator.
In case stroke limitations must be enforced, the kinematic 
constraints must account for them.


\subsection{Dynamic Pipe}
Finite Volume dynamic pipe.

\subsection{Definitions}
The dynamic pipe is formulated according to the finite volume approach.
The pipe is discretized by means of the pressures and the flow 
at the two ends, which are interpolated linearly.
The mass and the momentum balance equations are written by cutting
the pipe in two halves and adding the contribution of each resulting
subvolume to the respective nodal equations.


Consider the mass conservation and the momentum balance equations for a
one-dimensional flow:
\begin{eqnarray}
    \frac{D}{Dt}\plbr{dm} & = & 0 , \label{eq:MASS} \\
    \frac{D}{Dt}\plbr{dQ} & = & df . \label{eq:MOMENTUM}
\end{eqnarray}
When a rigid pipe is considered, the total derivative $D/Dt$ of the test
mass $dm=\rho{Adx}$ of Equation~(\ref{eq:MASS}) yields 
\begin{displaymath} 
    \frac{D}{Dt}\plbr{dm} \ = \ 
    \frac{\partial}{\partial{t}}\plbr{dm}
    + v \frac{\partial}{\partial{x}}\plbr{dm} ,
\end{displaymath}
which results in
\begin{displaymath}
    q_{/x} + A\rho_{/t} \ = \ 0 ,
\end{displaymath}
where $q=\rho{Av}$ is the mass flux.
Consider now the momentum equation~(\ref{eq:MOMENTUM}); the total derivative
of the momentum $dQ=vdm$ yields
\begin{displaymath}
    \frac{D}{Dt}\plbr{dQ} \ = \ \plbr{q_{/t} + \plbr{qv}_{/x}}dx ,
\end{displaymath}
while the pressure gradient and the viscous contributions can be isolated
from the force per unit length on the right hand side:
\begin{displaymath}
    df \ = \ - Adp + f_v dx + df^* ,
\end{displaymath}
so, by neglecting the deformability of the pipe and the extra forces $df^*$
acting on the fluid, the momentum balance equation yields
\begin{displaymath}
    q_{/t} + \plbr{qv + Ap}_{/x} \ = \ f_v ,
\end{displaymath}
which can be reduced to the pressure and flux unknowns simply by recalling
the definition of the flux:
\begin{displaymath}
    q_{/t} + \plbr{\frac{q^2}{\rho{A}} + Ap}_{/x} \ = \ f_v .
\end{displaymath}
A flexible pipe has been considered as well; the formulation is not reported
for simplicity, because such a level of detail is required only for very
specialized problems, and a first approximation can be obtained by altering
the bulk modulus of the fluid.

The pipe is discretized by considering a finite volume approach, based on
the use of constant stepwise ({\em Heavyside}) test functions with arbitrary
trial functions.
In the present case, linear trial functions have been considered both for
the flux and for the pressure:
\begin{eqnarray*}
    q\plbr{x} & = & \sqbr{\matr{cc}{
        \cfrac{1 - \xi}{2} &
        \cfrac{1 + \xi}{2}
    }}\cubr{\cvvect{
        q_1 \\
        q_2
    }} , \\
    p\plbr{x} & = & \sqbr{\matr{cc}{
        \cfrac{1 - \xi}{2} &
        \cfrac{1 + \xi}{2}
    }}\cubr{\cvvect{
        p_1 \\
        p_2
    }} ,
\end{eqnarray*}
with $\xi=\xi\plbr{x}\in\sqbr{-1,1}$ and $d\xi/dx=2/\plbr{b-a}$.
The discrete form of the pipe equations results in
\begin{eqnarray*}
    \lefteqn{
        q\plbr{b} - q\plbr{a} \ = \
        - \intg{a}{b}{\frac{\partial\rho}{\partial{p}}p_{/t}}{dx} ,
    } \hspace{20mm} \\
    \lefteqn{
        \frac{b-a}{2}\plbr{
            q\plbr{b}_{/t} + q\plbr{a}_{/t}
        } + \plbr{
            \frac{q\plbr{b}^2}{\rho\plbr{b} A} + A p\plbr{b}
        }
    } \hspace{40mm} \\
    \mbox{} - \plbr{
        \frac{q\plbr{a}^2}{\rho\plbr{a} A} + A p\plbr{a}
    } & = & \intg{a}{b}{f_v}{dx} ;
\end{eqnarray*}
by dividing the pipe in two portions, and by considering the domains
$\sqbr{-1,0}$ and $\sqbr{0,1}$ for $\xi$ in each portion, the discrete
equations of the finite volume pipe become
\begin{eqnarray*}
    \lefteqn{
    - \frac{1}{2}\plbr{
        q_1 + q_2
    } - \frac{\partial\rho\plbr{-1/2}}{\partial{p}}\frac{L}{8}\plbr{
        3 \dot{p}_1 + \dot{p}_2
    } \ = \ \phi_1 , 
    } \hspace{60mm} \\
    \lefteqn{
    \frac{1}{2}\plbr{
        q_1 + q_2
    } - \frac{\partial\rho\plbr{1/2}}{\partial{p}}\frac{L}{8}\plbr{
        \dot{p}_1 + 3 \dot{p}_2
    } \ = \ \phi_2 , 
    } \hspace{54.5mm} \\
    \lefteqn{
    \frac{L}{8}\plbr{
        3 \dot{q}_1 + \dot{q}_2
    } + % \frac{q\plbr{0}^2}{\rho\plbr{0}A}
    \frac{\plbr{q_1+q_2}^2}{4\rho\plbr{0}A}
    - \frac{q_1^2}{\rho\plbr{-1}A}
    } \hspace{60mm} \\
    \lefteqn{
    \mbox{} + \frac{A}{2}\plbr{
        p_2 - p_1
    } \ = \ \frac{L}{2}\intg{-1}{0}{f_v}{d\xi} , 
    } \hspace{40mm} \\
    \lefteqn{
    \frac{L}{8}\plbr{
        \dot{q}_1 + 3 \dot{q}_2
    } + \frac{q_2^2}{\rho\plbr{1}A}
    - % \frac{q\plbr{0}^2}{\rho\plbr{0}A}
    \frac{\plbr{q_1+q_2}^2}{4\rho\plbr{0}A}
    } \hspace{60mm} \\
    \lefteqn{
    \mbox{} + \frac{A}{2}\plbr{
        p_2 - p_1
    } \ = \ \frac{L}{2}\intg{0}{1}{f_v}{d\xi} ,
    } \hspace{40mm}
\end{eqnarray*}
where $\phi_1$ and $\phi_2$ are the contributions of the two portions of
pipe to the respective nodal flux balance equations.
The integral of the time derivative of the density is numerically computed.
The integral of the viscous forces per unit length is numerically performed
as well, accounting for the flow regime in the pipe as function of the
{\em Reynolds}\ number.
In fact, for the forces per unit length, the dependency on the flux is
considered linear for $0<Re<2000$, and quadratic for $Re>4000$, while a
polynomial fitting of the transition behavior, accounting also for the rate
of the {\em Reynolds}\ number, is modeled for $2000<Re<4000$.

\subsubsection{Equations}
\begin{eqnarray*}
	0 & = & \frac{1}{2}\plbr{q_1 + q_2}
		+ A L \frac{\partial\rho}{\partial{p}}_1 
		\plbr{\frac{3}{8} \dot{P}_1 + \frac{1}{8} \dot{P}_2} \\
	0 & = & -\frac{1}{2}\plbr{q_1 + q_2}
		+ A L \frac{\partial\rho}{\partial{p}}_2 
		\plbr{\frac{1}{8} \dot{P}_1 + \frac{3}{8} \dot{P}_2} \\
	0 & = & - L \plbr{\frac{3}{8} \dot{q}_1 + \frac{1}{8} \dot{q}_2}
		- \plbr{\frac{1}{2}\plbr{q_1 + q_2}}^2 \frac{1}{\rho_m A}
		+ q_1^2 \frac{1}{\rho_1 A}
		- \frac{A}{2}\plbr{p_2 - p_1}
		- f_1 \\
	0 & = & - L \plbr{\frac{1}{8} \dot{q}_1 + \frac{3}{8} \dot{q}_2}
		- q_2^2 \frac{1}{\rho_2 A}
		+ \plbr{\frac{1}{2}\plbr{q_1 + q_2}}^2 \frac{1}{\rho_m A}
		- \frac{A}{2}\plbr{p_2 - p_1}
		- f_2 \\
	p_1 & = & P_1 \\
	p_2 & = & P_2
\end{eqnarray*}



\bibliographystyle{unsrt}
\bibliography{mybib}


\pagebreak
\noindent
Pierangelo Masarati \\
Dipartimento di Ingegneria Aerospaziale, Politecnico di Milano \\
via La Masa 34, 20156 Milano, Italy \\
Tel.: ++39 02 2399 8309 \\
Fax: ++39 02 2399 8334 \\
E-mail: \htmladdnormallink{\texttt{masarati@aero.polimi.it}}{mailto:masarati@aero.polimi.it} \\
Web: \htmladdnormallink{\texttt{http://www.aero.polimi.it/\~{}mbdyn/}}{http://www.aero.polimi.it/~mbdyn/} \\
Web: \htmladdnormallink{\texttt{http://www.aero.polimi.it/\~{}masarati/}}{http://www.aero.polimi.it/~masarati/} \\
Web: \htmladdnormallink{\texttt{http://mbdyn.aero.polimi.it/\~{}masarati/MBDyn-input/manual/index.html}}{http://mbdyn.aero.polimi.it/~masarati/MBDyn-input/manual/index.html}

\end{document}
