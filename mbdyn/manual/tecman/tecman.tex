% MBDyn (C) is a multibody analysis code.
% http://www.mbdyn.org
%
% Copyright (C) 1996-2003
%
% Pierangelo Masarati  <masarati@aero.polimi.it>
%
% Dipartimento di Ingegneria Aerospaziale - Politecnico di Milano
% via La Masa, 34 - 20156 Milano, Italy
% http://www.aero.polimi.it
%
% Changing this copyright notice is forbidden.
%
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation (version 2 of the License).
% 
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

\documentclass[10pt,dvips]{report}

%\usepackage[pdftex]{graphicx}
\usepackage[T1]{fontenc}
\usepackage{ae,aecompl}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{html}

\input{stdmacro}
%poor man's bold symbol
\newcommand{\T}[1]{\boldsymbol{#1}}

\begin{document}

\begin{latexonly}
\title{\bf MBDyn Technical Manual \\
Version
\input{version}
}
\author{Pierangelo Masarati \vspace{5mm}\\
    \sc Dipartimento di Ingegneria Aerospaziale \\
    \sc Politecnico di Milano}
\date{\today}
\maketitle
\end{latexonly}

\begin{htmlonly}
\begin{center}
\textbf{\LARGE MBDyn Technical Manual}

\emph{\large Pierangelo Masarati}

\textsc{Dipartimento di Ingegneria Aerospaziale \\ Politecnico di Milano}

\today
\end{center}
\end{htmlonly}




\tableofcontents
\newpage

\chapter{Introduction}
This document describes details about the formulation MBDyn:
Multi-Body Dynamics relies on.

\chapter{Data Structure}

\chapter{Constraints}

\section{Algebraic Constraints}

\subsection{Distance Joint}

\subsubsection{Distance Joint Without Offsets}
Definitions
\begin{displaymath}
	u = \frac{1}{d}\plbr{x_2 - x_1}
\end{displaymath}
Limitations
\begin{displaymath}
	d > 0
\end{displaymath}
Constraint Equation
\begin{displaymath}
	d \sqrt{u^T u} = d
\end{displaymath}
Forces
\begin{eqnarray*}
	F_1 & = & \alpha u \\
	F_2 & = & -\alpha u
\end{eqnarray*}
Linearization
\begin{displaymath}
	\sqbr{\matr{ccc}{
		\frac{\alpha}{d}I & -\frac{\alpha}{d}I & -u \\
		-\frac{\alpha}{d}I & \frac{\alpha}{d}I & u \\
		-u^T & u^T & 0
	}}\cubr{\cvvect{
		\Delta{x_1} \\
		\Delta{x_2} \\
		\Delta{\alpha}
	}} = \cubr{\cvvect{
		\alpha u \\
		- \alpha u \\
		d\plbr{1 - \sqrt{u^T u}}
	}}
\end{displaymath}
Constraint Equation Derivative
\begin{displaymath}
	d u^T \dot{u} = 0
\end{displaymath}
Force Derivatives
\begin{eqnarray*}
	\dot{F}_1 & = & \alpha \dot{u} + \dot{\alpha} u \\
	\dot{F}_2 & = & -\alpha \dot{u} - \dot{\alpha} u
\end{eqnarray*}
Linearization
\begin{displaymath}
        \sqbr{\matr{cccccc}{
		\frac{\dot{\alpha}}{d}I & \frac{\alpha}{d}I &
			-\frac{\dot{\alpha}}{d}I & -\frac{\alpha}{d}I &
			-\dot{u} & -u \\
		-\frac{\dot{\alpha}}{d}I & -\frac{\alpha}{d}I &
			\frac{\dot{\alpha}}{d}I & \frac{\alpha}{d}I &
			\dot{u} & u \\
		-\dot{u}^T & -u^T & \dot{u}^T & u^T & 0 & 0
	}}\cubr{\cvvect{
		\Delta{x_1} \\
		\Delta{\dot{x}_1} \\
		\Delta{x_2} \\
		\Delta{\dot{x}_2} \\
		\Delta{\alpha} \\
		\Delta{\dot{\alpha}}
	}} = \cubr{\cvvect{
		\alpha \dot{u} + \dot{\alpha} u \\
		-\alpha \dot{u} - \dot{\alpha} u \\
		d u^T \dot{u}
	}}
\end{displaymath}




\subsubsection{Distance Joint With Offsets}
Definitions:
\begin{displaymath}
	u = \frac{1}{d}\plbr{x_2 + f_2 - x_1 - f_1}
\end{displaymath}
Limitations:
\begin{displaymath}
	d > 0
\end{displaymath}
Constraint equation 
\begin{displaymath}
	d \sqrt{u^T u} = d
\end{displaymath}
Forces:
\begin{eqnarray*}
	F_1 & = & \alpha u \\
	M_1 & = & \alpha f_1 \times u \\
	F_2 & = & -\alpha u \\
	M_2 & = & -\alpha f_2 \times u
\end{eqnarray*}
Linearization:
\begin{displaymath}
	\sqbr{\matr{ccccc}{
		\frac{\alpha}{d}I & -\frac{\alpha}{d}f_1\times{} &
			-\frac{\alpha}{d}I & \frac{\alpha}{d}f_2\times{} & -u \\
		\frac{\alpha}{d}f_1\times{} & 
			-\frac{\alpha}{d}\plbr{f_1 + u}\times{f_1\times{}} &
			-\frac{\alpha}{d}f_1\times{} & 
			\frac{\alpha}{d}f_1\times{f_2\times{}} & 
			-f_1\times{u} \\
		-\frac{\alpha}{d}I & \frac{\alpha}{d}f_1\times{} &
			\frac{\alpha}{d}I & -\frac{\alpha}{d}f_2\times{} & u \\
		-\frac{\alpha}{d}f_2\times{} &
			\frac{\alpha}{d}f_2\times{f_1\times{}} &
			\frac{\alpha}{d}f_2\times{} &
			- \frac{\alpha}{d}\plbr{f_2 - u}\times{f_2\times{}} &
			f_2\times{u} \\
		-u^T & - \plbr{f_1\times{u}}^T & 
			u^T & \plbr{f_2\times{u}}^T & 0
	}}\cubr{\cvvect{
		\Delta{x_1} \\
		\Delta{g_1} \\
		\Delta{x_2} \\
		\Delta{g_2} \\
		\Delta{\alpha}
	}}
\end{displaymath}
\begin{displaymath}
	\mbox{\hspace{100mm}} = \cubr{\cvvect{
		\alpha u \\
		\alpha f_1\times{u} \\
		-\alpha u \\
		-\alpha f_2\times{u} \\
		d\plbr{1 - \sqrt{u^T u}}
	}}
\end{displaymath}
Constraint Equation Derivative
\begin{displaymath}
	d u^T\dot{u} = 0
\end{displaymath}
Forces:
\begin{eqnarray*}
	\dot{F}_1 & = &  \alpha \dot{u} + \dot{\alpha} u \\
	\dot{M}_1 & = & \alpha \plbr{\omega_1\times{f_1}} \times u 
		+ \alpha f_1 \times \dot{u}
		+ \dot{\alpha} f_1 \times u \\
	\dot{F}_2 & = & -\alpha \dot{u} - \dot{\alpha} u \\
	\dot{M}_2 & = & -\alpha \plbr{\omega_2 \times{f_2}} \times u
		- \alpha f_2 \times \dot{u}
		- \dot{\alpha} f_2 \times u
\end{eqnarray*}
Linearization:

\subsection{Revolute hinge (PlaneHingeJoint)}
Joint data
\begin{displaymath}
\T d_1, \T d_2, \T R_{h1}, \T R_{h2}
\end{displaymath}
where:\\
$\T d_1$, $\T d_2$: offset of nodes 1,2 in node reference;\\
$\T R_{h1}$, $\T R_{h2}$: joint relative orientation wrt. nodes 1,2 (FIXME).\\

\noindent
Constraint equations (normalized by dCoef)
\begin{eqnarray*}
	(\T x_1+\T R_1\cdot \T d_1) - (\T x_2+\T R_1\cdot \T d_2)& = & 0 \\
	(\T R_1\cdot \T R_{h1})[3]\cdot (\T R_2\cdot \T R_{h2})[2] & = & 0 \\
	(\T R_1\cdot \T R_{h1})[3]\cdot (\T R_2\cdot \T R_{h2})[1] & = & 0 \\
\end{eqnarray*}
where:\\
$\T x_1$, $\T x_2$: positions of nodes 1,2;\\
$\T R_{1}$, $\T R_{2}$: orientation of nodes 1, 2.\\

\noindent
Residual vector:
\begin{eqnarray*}
	\mathrm{node1\ momentum}:\ 1-3& -= & \T F\\
	\mathrm{node1\ angular\ momentum}:\ 4-6& -= & 
		(\T R_1\cdot \T d_1) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2]\\
	\mathrm{node2\ momentum}:\ 7-9& += & \T F\\
	\mathrm{node2\ angular\ momentum}:\ 10-12& += & 
		(\T R_2\cdot \T d_2) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2]\\
	\mathrm{constraint}:\ 13-15& = &  ((\T x_1+\T R_1\cdot \T d_1) - 
			(\T x_2+\T R_1\cdot \T d_2))/dCoef\\
	\mathrm{constraint}:\ 16& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[2])/dCoef\\
	\mathrm{constraint}:\ 17& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[1])/dCoef\\
\end{eqnarray*}
where:\\
$\T F$: constraint reaction force;\\
$\T M$: constraint moment reaction (third component null).\\

\noindent
Friction:
\begin{itemize}
\item add third component of constraint moment $\T M$
\item add a costraint equation; this could be one of the following:
	\begin{itemize}
	\item direct definition of $\T M[3]$ in function of relative velocity,
		friction coeff and $\T F$
	\item impose null relative velocity
	\end{itemize}
\item optionally add internal states dinamic (for friction)
\end{itemize}
\subsubsection{add third component of constraint moment $\T M$}
Residual vector:
\begin{eqnarray*}
	\mathrm{node1\ momentum}:\ 1-3& -= & \T F\\
	\mathrm{node1\ angular\ momentum}:\ 4-6& -= & 
		(\T R_1\cdot \T d_1) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]*\T M[3]\\
	\mathrm{node2\ momentum}:\ 7-9& += & \T F\\
	\mathrm{node2\ angular\ momentum}:\ 10-12& += & 
		(\T R_2\cdot \T d_2) \times \T F + \\
	&&	(\T R_2\cdot \T R_{h2})[2]\times 
		(\T R_1\cdot \T R_{h1})[3]*\T M[1] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]\times
		(\T R_2\cdot \T R_{h2})[1]*\T M[2] +\\
	&&	(\T R_1\cdot \T R_{h1})[3]*\T M[3]\\
	\mathrm{constraint}:\ 13-15& = &  ((\T x_1+\T R_1\cdot \T d_1) - 
			(\T x_2+\T R_1\cdot \T d_2))/dCoef\\
	\mathrm{constraint}:\ 16& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[2])/dCoef\\
	\mathrm{constraint}:\ 17& = &  ((\T R_1\cdot \T R_{h1})[3]\cdot 
			(\T R_2\cdot \T R_{h2})[1])/dCoef\\
	\mathrm{friction:}\ 18& = &  \T M[3] -f(\T F, \mathrm{rel\ velocity}, 
			\mathrm{friction\ coef})\\
		& = &  (\mathrm{rel\ velocity})[3]
\end{eqnarray*}
The relative velocity
$v = r * (\T \omega_{1}-\T \omega_{2})\cdot(\T R_1\cdot \T R_{h1})[3]$.
The constraint is based on positions. This means that during integration 
$(\T \omega_{1}-\T \omega_{2})$ will NOT have exactly the
direction $(\T R_1\cdot \T R_{h1})[3]$. We choose to disregard this error.
The friction moment should be along $(\T R_1\cdot \T R_{h1})[3]$.\\
$r$ is the joint radius.\\
CHECK THIS!!!\\
Partial derivative of the term $f(\T F, \mathrm{rel\ velocity})$:
$\T M[3] = \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v)) * (\T R_1\cdot \T R_{h1})[3] * 
	\sqrt{\T F \cdot \T F} * f_{\mathrm{c}}(v)$,
with $\T R_{h1}$ constant.
\begin{eqnarray*}
\delta M[3] &=& \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v)) * \sqrt{\T F \cdot \T F} *
	f_{\mathrm{c}}(d, \T \omega_{1}, \T \omega_{2}, \T R_1, \T R_{h1}) *
		(\T R_{\delta 1} \times \T R_1)[3]+\\
	&& \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v)) *(\T R_1\cdot \T R_{h1})[3] * 
		\frac{\displaystyle\T F}{\displaystyle\sqrt{\T F \cdot \T F}} 
		\cdot \delta \T F+\\
	&& \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v)) * (\T R_1\cdot \T R_{h1})[3] * 
		\sqrt{\T F \cdot \T F} *
		\frac{\displaystyle \partial f_{\mathrm{c}}}
			{\displaystyle \partial v} * \delta v+\\
	&&	(\T R_1\cdot \T R_{h1})[3] * 
			\sqrt{\T F \cdot \T F} * f_{\mathrm{c}}(v) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v))}
			{\displaystyle \partial \T F} \cdot \delta \T F+\\
	&&	(\T R_1\cdot \T R_{h1})[3] * 
			\sqrt{\T F \cdot \T F} * f_{\mathrm{c}}(v) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v))}
			{\displaystyle \partial f_{\mathrm{c}}(v)} *
			\frac{\displaystyle \partial f_{\mathrm{c}}}
				{\displaystyle \partial v} * \delta v\\
	&=& \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v)) * \sqrt{\T F \cdot \T F} *
		f_{\mathrm{c}}(d, \T \omega_{1}, \T \omega_{2}, \T R_1, \T R_{h1}) *
		\T R_1^T \cdot (\T R_{\delta 1} \times )[3]+\\
	&& \left (\begin{array}{l}
		\mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v)) *(\T R_1\cdot \T R_{h1})[3] * 
		\frac{\displaystyle\T F}{\displaystyle\sqrt{\T F \cdot \T F}}\\
		(\T R_1\cdot \T R_{h1})[3] * 
			\sqrt{\T F \cdot \T F} * f_{\mathrm{c}}(v) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v))}
			{\displaystyle \partial \T F}
		\end{array} 
		\right )\cdot \delta \T F+\\
	&& \left ( \begin{array}{l}
		\mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v)) * (\T R_1\cdot \T R_{h1})[3] * 
		\sqrt{\T F \cdot \T F}\\
		(\T R_1\cdot \T R_{h1})[3] * 
			\sqrt{\T F \cdot \T F} * f_{\mathrm{c}}(v) *
			\frac{\displaystyle \partial \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v))}
			{\displaystyle \partial f_{\mathrm{c}}(v)}
		\end{array} \right ) *
		\frac{\displaystyle \partial f_{\mathrm{c}}}
			{\displaystyle \partial v} * \delta v
\end{eqnarray*}
dove 
\begin{itemize}
\item
$v=r * (\T \omega_{1}-\T \omega_{2})\cdot(\T R_1\cdot \T R_{h1})[3]$
e quindi
\begin{eqnarray*}
\delta v &=& d * (\T R_1\cdot \T R_{h1})[3] \cdot (\delta \T \omega_{1}- \delta \T \omega_{2}) +\\
	&& d * (\T \omega_{1}-\T \omega_{2})\cdot (\T R_{\delta 1} \times \T R_1 \cdot \T R_{h1})[3]\\
	&=& d * (\T R_1\cdot \T R_{h1})[3] \cdot (\delta \T \omega_{1}- \delta \T \omega_{2}) +\\
	&& d * (\T \omega_{1}-\T \omega_{2})\cdot \T R_{h1}^T \cdot \T R_1^T \cdot (\T R_{\delta 1} \times )[3]
\end{eqnarray*}
\item
$
\mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v))=
r * 
C_\alpha(
	\alpha(\mathrm{costants},
		f_{\mathrm{c}}(v),
		\sqrt{\T F \cdot \T F},
		\mathrm{f_{\mathrm{c}}(v)}
	)
) 
\frac{\displaystyle 1}{\displaystyle \sqrt{1+f_{\mathrm{c}}^2(v)}}
$
\item
$
\alpha(\mathrm{costants},
	f_{\mathrm{c}}(v),
	\sqrt{\T F \cdot \T F},
	\mathrm{f_{\mathrm{c}}(v)}
) =
\sin^{-1}\left(
	\sqrt{
		\frac{\displaystyle 2*31*\sqrt{\T F \cdot \T F}}
			{\displaystyle E*b*\sqrt{1+f_{\mathrm{c}}^2(v)}}
		\frac{\displaystyle r'/r}
			{\displaystyle r'-r}
	}
\right)
$
\item for very low joint loads (angle of contact $\alpha< 20^{\mathrm{o}}$,
i.e. about less that 1\% of the joint allowable load)
we can safely assume $C_\alpha\approx 1$
so that\\ 
$
\mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v))\approx
r * 
\frac{\displaystyle 1}{\displaystyle \sqrt{1+f_{\mathrm{c}}^2(v)}}
$,\\

$
\frac{\displaystyle\partial \mathrm{sh\_c}(\T F, f_{\mathrm{c}}(v))}
	{\displaystyle\partial \T F} = \T 0
$\\
and
$
\frac{\displaystyle\partial \mathrm{sh\_c}
	{\displaystyle\partial \mathrm{f_{\mathrm{c}}(v)} =
	-(1+f_{\mathrm{c}}^2(v))^{-3/2}*f_{\mathrm{c}}(v)
$
\end{itemize}

\section{Deformable Constraints}

\subsection{Deformable Hinge}



\bibliographystyle{unsrt}
\bibliography{mybib}


\pagebreak
\noindent
Pierangelo Masarati \\
Dipartimento di Ingegneria Aerospaziale, Politecnico di Milano \\
via La Masa 34, 20156 Milano, Italy \\
Tel.: ++39 02 2399 8309 \\
Fax: ++39 02 2399 8334 \\
E-mail: \htmladdnormallink{\texttt{masarati@aero.polimi.it}}{mailto:masarati@aero.polimi.it} \\
Web: \htmladdnormallink{\texttt{http://www.aero.polimi.it/\~{}mbdyn/}}{http://www.aero.polimi.it/~mbdyn/} \\
Web: \htmladdnormallink{\texttt{http://www.aero.polimi.it/\~{}masarati/}}{http://www.aero.polimi.it/~masarati/} \\
Web: \htmladdnormallink{\texttt{http://mbdyn.aero.polimi.it/\~{}masarati/MBDyn-input/manual/index.html}}{http://mbdyn.aero.polimi.it/~masarati/MBDyn-input/manual/index.html}

\end{document}
