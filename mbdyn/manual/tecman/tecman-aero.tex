% MBDyn (C) is a multibody analysis code.
% http://www.mbdyn.org
%
% Copyright (C) 1996-2009
%
% Pierangelo Masarati  <masarati@aero.polimi.it>
%
% Dipartimento di Ingegneria Aerospaziale - Politecnico di Milano
% via La Masa, 34 - 20156 Milano, Italy
% http://www.aero.polimi.it
%
% Changing this copyright notice is forbidden.
%
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation (version 2 of the License).
% 
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
%
% Alessandro Fumagalli <fumagalli@aero.polimi.it> is the author of this document

Aerodynamic elements apply aerodynamic forces to structural nodes.

This section is not intended 
to give details about the aerodynamic models adopted but mainly 
discuss the computation of the contributions to the Jacobian 
matrix of the aerodynamic elements.

\paragraph{Files.} \
It is implemented in files\\
\begin{tabular}{l}
\texttt{mbdyn/aero/aeroelem.h} \\
\texttt{mbdyn/aero/aeroelem.cc} 
\end{tabular}

\paragraph{Aerodynamic body}
%\section{Aerodynamic Body}

The \texttt{aerodynamic body} element applies aerodynamic forces
to the structural node it is connected to,
based on the relative velocity between an aerodynamic surface attached 
to the node and the airstrem.

The aerodynamic forces and moments acting on the attached node are:
\begin{subequations}
\begin{align}
	\T{f} &= \TT{R}_{\text{loc}} \T{f}_a\\ 
	\T{c} &= \TT{R}_{\text{loc}} \T{c}_a + \T{x}_r\times\T{f} 
\end{align}
\end{subequations}
where $\TT{R}_{\text{loc}} = \TT{R}_n\TT{R}_a\TT{R}_t$ is the orientation 
matrix from the local frame of the aerodynamics to the global, 
while $\T{f}_a$ and $\T{c}_a$ are the aerodynamic force and moment 
respectively in the reference frame of the aerodynamics. $\TT{R}_n$
is the orientation matrix of the node, $\TT{R}_a$ is the
relative orientation matrix of the aerodynamics frame with respect 
to the node frame while $\TT{R}_t$ is a rotation matrix 
related to the twist of the aerodynamic surface.
Both $\TT{R}_a$ and $\TT{R}_t$ do not depend on the unknowns
olf the problem, and thus their perturbation is zero.
The vector $\T{x}_r = \TT{R}_n\T{b}$ is the offset of the aerodynamic
surface with respect to the node; $\T{b}$ is constant.

The aerodynamic forces and moments are computed as functions 
of a velocity vector in the reference frame of the aerodynamics:
\begin{equation}\label{eq:fa=g(va)}
	\sqbr{\matr{c}{\T{f_a}\\\T{c_a}}} = \T{g}\plbr{\T{V}_{a}}
\end{equation}
where $\T{V}_{a} = \sqbr{\T{v}_a^T\ \T{\omega}_a^T}^T$ includes both the 
linear and angular velocity in the reference frame of the aerodynamics:
\begin{equation}
	\T{V}_{a} = \sqbr{\matr{c}{
		\TT{R}^T_{\text{loc}} \plbr{\T{v}_n + \T{\omega}_n\times\T{x}_r - \T{v}_{\infty} - \T{v}_{\text{ind}}}\\
		\TT{R}^T_{\text{loc}} \T{\omega}_n
		}}
\end{equation}
The total airstream velocity in the aerodynamic frame of reference 
includes also the free stream velocity $\T{v}_{\infty}$ and
the induced velocity $\T{v}_{\text{ind}}$, were the aerodynamic element
connected to any induced velocity model.
These two contributions will not be considered in the following
since they do not depend on the unknowns of the problem\footnote{In general,
induced velocity models depend on the aerodynamic loads,
and thus may indirectly depend on the unknowns of the problem.
This dependence is neglected.
}, and thus do not contribute to the Jacobian matrix of the problem. 

The perturbation of the aerodynamic force in the global reference frame
yields:
\begin{align}
	\delta\T{f}
	& = \T{\theta}_{\delta}\times\TT{R}_{\text{loc}}\T{f}_a
	+ \TT{R}_{\text{loc}}\frac{\partial\T{f}_a}{\partial\T{V}_a}
		\delta\T{V}_a
	\nonumber \\
	&= \T{\theta}_{\delta}\times \T{f}
	+ \TT{R}_{\text{loc}}\frac{\partial\T{f}_a}{\partial\T{V}_a}
		\delta\T{V}_a
\end{align}
The $3\times6$ matrix $\partial\T{f}_a/\partial\T{V}_a$, 
named $\T{J_f}_a$ in the
following, is computed numerically using the finite difference method
described below.

The perturbation of the aerodynamic moment in the global reference frame
yields:
\begin{align}
	\delta\T{c}
	&= \T{\theta}_{\delta}\times\TT{R}_{\text{loc}}\T{c}_a
	+ \TT{R}_{\text{loc}}\frac{\partial\T{c}_a}{\partial\T{V}_a}
		\delta\T{V}_a
	+ \delta\T{x}_r\times\T{f}
	+ \T{x}_r\times\delta\T{f}
	\nonumber \\
	&= \T{\theta}_{\delta}\times\T{c}
	+ \TT{R}_{\text{loc}}\frac{\partial\T{c}_a}{\partial\T{V}_a}
		\delta\T{V}_a
	+ \T{x}_r\times
		\TT{R}_{\text{loc}}\frac{\partial\T{f}_a}{\partial\T{V}_a}
		\delta\T{V}_a
	\nonumber \\
	&= \T{\theta}_{\delta}\times\T{c}
	+ \TT{R}_{\text{loc}}\plbr{
		\frac{\partial\T{c}_a}{\partial\T{V}_a}
		+ \T{b}\times\frac{\partial\T{f}_a}{\partial\T{V}_a}
	} \delta\T{V}_a
\end{align}
The $3\times6$ matrix $\partial\T{c}_a/\partial\T{V}_a$, 
named $\T{J_c}_a$ in the
following, is computed numerically as well, using a finite difference method.

The Jacobian matrix of the aerodynamic forces and moments in the reference 
frame of the aerodynamics is computed computed numerically,
using a forward finite difference method involving a numerical perturbation
of the relative velocity in the reference frame of the aerodynamics.
In detail, each component of the $6\times6$ matrix $\T{J}_a$ is computed as:
\begin{equation}
	{J_a}_{ij} = \frac{g_i(\T{V}_a + \Delta\T{V}_a) 
		- g_i(\T{V}_a)}{\Delta {V_a}_j}
\end{equation}
The perturbation of the velocity, $\Delta\T{V}_a$ in this case, plays
a crucial role. The procedure here adopted consists in obtaining this
perturbation based on the norm of the linear velocity $\T{v}_a$ for what 
concerns the perturbation of the linear velocity components, based on
the norm of the angular velocity $\T{\omega}_a$ for what concerns 
the angular velocity components. Thus:
\begin{equation}
	\Delta {V_a}_j = \Bigl\{\matr{c}{
		\varepsilon\lvert\T{v}_a\lvert\text{ if $j = 1,2,3$}\\
		\varepsilon\lvert\T{\omega}_a\lvert\text{ if $j = 4,5,6$}
		}
\end{equation}
To summarize the procedure, it can be helpful to report the algorithm
actually implemented:
\begin{verbatim}
F0a = GetForces(V0a);
for(i = 1; i <= 6; i++)	{
    deltaVa = V0a; 
				
    if (i <= 3)	{
        delta = norm(V0a) * epsilon;
    } else		{
        delta = norm(W0a) * epsilon;
    }
    deltaVa(i) = V0a(i) + delta;
					
    Fa = GetForces(deltaVa);
	
    for(j = 1; j <= 6; j++)	{
        Ja(j,i) = (Fa(j) - Fa0(j)) / delta 
    }
}
\end{verbatim}

For ease of notation, in the following the $6\times6$ matrix $\T{J}_a$ is 
divided into four sub-matrices
\begin{equation}\label{eq:JaSub}
	\T{J}_a = \sqbr{\matr{c}{\T{J_f}_a\\\T{J_c}_a}}
	=\sqbr{\matr{cc}{\T{J}_{a11} & \T{J}_{a12}\\ \T{J}_{a21} & \T{J}_{a22}}}
\end{equation}

To correctly espress the Jacobian matrix contributions, the perturbation 
$\delta\T{V}_a$ and $\delta \T{x}_r$ must be expressed in terms of 
the node coordinates and velocities, namely:
\begin{align}
	\delta\T{V}_a &= \delta\sqbr{\matr{c}{
		\TT{R}^T_{\text{loc}}
			% \plbr{\T{v}_n + \T{\omega}_n\times\T{x}_r - \T{v}_{\infty} - \T{v}_{\text{ind}}}
			\T{v}_{\text{rel}}
		\\
		\TT{R}^T_{\text{loc}} \T{\omega}_n
		}}
	\nonumber \\
	&= \sqbr{\matr{c}{
	\TT{R}^T_{\text{loc}} \plbr{
		\T{v}_{\text{rel}} \times \T{\theta}_\delta
		+ \delta\T{v}_n
		+ \delta\T{\omega}_n\times\T{x}_r
		- \T{\omega}_n\times\T{x}_r\times\T{\theta}_{\delta}}
	\\
	\TT{R}^T_{\text{loc}}\plbr{
		\T{\omega}_n \times\T{\theta}_\delta
		+ \delta\T{\omega}_n
	}
	}}
\end{align}
with $\T{v}_{\text{rel}}=\T{v}_n + \T{\omega}_n\times\T{x}_r - \T{v}_{\infty} - \T{v}_{\text{ind}}$
and exploiting $\delta\T{x}_r = \T{\theta}_\delta\times\T{x}_r$.

After some manipulation, the perturbation of the aerodynamic forces  
in the global reference frame reads:
\begin{align}
	\delta\T{f} &= 
	-\TT{R}_{\text{loc}}\T{f}_a\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}}\T{v}_{\text{rel}}\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}}\delta\T{v}_n
	\nonumber \\
	&\hphantom{= }- \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}}
		\T{x}_r\times\delta\T{\omega}_n
	\nonumber \\
	&\hphantom{= }- \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}}
		\T{\omega}_n\times\T{x}_r\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a12}\TT{R}^T_{\text{loc}}\T{\omega}_n
		\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a12}\TT{R}^T_{\text{loc}}\delta\T{\omega}_n
	\nonumber \\
	&=
	\plbr{
		- \T{f}\times{}
		+ \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}}\plbr{
			\T{v}_{\text{rel}}\times{}
			- \T{\omega}_n\times\T{x}_r\times{}
		}
		+ \TT{R}_{\text{loc}}\T{J}_{a12}\TT{R}^T_{\text{loc}}\T{\omega}_n\times{}
	} \T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}}\delta\T{v}_n
	\nonumber \\
	&\hphantom{= }+ \plbr{
		- \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}} \T{x}_r\times{}
		+ \TT{R}_{\text{loc}}\T{J}_{a12}\TT{R}^T_{\text{loc}}
	} \delta\T{\omega}_n
	\label{eq:deltaF}
\end{align}
while the perturbation of the aerodynamic moments yields:

\begin{align}
	\delta\T{c} &= 
	- \TT{R}_{\text{loc}}\T{c}_a\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a21}\TT{R}^T_{\text{loc}}\T{v}_{\text{rel}}\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a21}\TT{R}^T_{\text{loc}}\delta\T{v}_n
	\nonumber \\
	&\hphantom{= }- \TT{R}_{\text{loc}}\T{J}_{a21}\TT{R}^T_{\text{loc}}
		\T{x}_r\times\delta\T{\omega}_n
	\nonumber \\
	&\hphantom{= }- \TT{R}_{\text{loc}}\T{J}_{a21}\TT{R}^T_{\text{loc}}
		\T{\omega}_n\times\T{x}_r\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a22}\TT{R}^T_{\text{loc}}\T{\omega}_n
		\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \TT{R}_{\text{loc}}\T{J}_{a22}\TT{R}^T_{\text{loc}}\delta\T{\omega}_n
	\nonumber \\
	&\hphantom{= }+ \T{f}\times\T{x}_r\times\T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \T{x}_r \times \delta\T{f}
	\nonumber \\
	&=
	\lplbr{
		- \T{c}\times{}
		+ \TT{R}_{\text{loc}}\T{J}_{a21}\TT{R}^T_{\text{loc}} \plbr{
			\T{v}_{\text{rel}}\times{}
			- \T{\omega}_n\times\T{x}_r\times{}
		}
		+ \TT{R}_{\text{loc}}\T{J}_{a22}\TT{R}^T_{\text{loc}}\T{\omega}_n\times{}
	}
	\nonumber \\
	&\hphantom{= }\rplbr{\mbox{\hspace{3mm}} + \T{x}_r \times 
	\plbr{
		\TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}}\plbr{
			\T{v}_{\text{rel}}\times{}
			- \T{\omega}_n\times\T{x}_r\times{}
		}
		+ \TT{R}_{\text{loc}}\T{J}_{a12}\TT{R}^T_{\text{loc}}\T{\omega}_n\times{}
	}} \T{\theta}_\delta
	\nonumber \\
	&\hphantom{= }+ \plbr{
		\TT{R}_{\text{loc}}\T{J}_{a21}\TT{R}^T_{\text{loc}}
		+ \T{x}_r \times \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}}
	} \delta\T{v}_n
	\nonumber \\
	&\hphantom{= }+ \lplbr{
		- \TT{R}_{\text{loc}}\T{J}_{a21}\TT{R}^T_{\text{loc}}\T{x}_r\times{}
		+ \TT{R}_{\text{loc}}\T{J}_{a22}\TT{R}^T_{\text{loc}}
	}
	\nonumber \\
	&\hphantom{= } \rplbr{
		\mbox{\hspace{5mm}} + \T{x}_r \times \plbr{
		- \TT{R}_{\text{loc}}\T{J}_{a11}\TT{R}^T_{\text{loc}} \T{x}_r\times{}
		+ \TT{R}_{\text{loc}}\T{J}_{a12}\TT{R}^T_{\text{loc}}
	}} \delta\T{\omega}_n
\end{align}
where the last term, which involves $\delta\T{f}$, is the same of
Eq.~(\ref{eq:deltaF}).

\paragraph{Aerodynamic beam}
%\section{Aerodynamic Body}

The \texttt{aerodynamic beam} element applies aerodynamic forces
to the nodes of a structural beam element. 
The aerodynamic forces/moments acting on a single node 
are computed based on a relative 
velocity between an aerodynamic surface attached 
to the node and the airstrem. By itself, the relative velocity 
used on each node, as well as the position of the aerodynamic 
surface, is computed based on a weighted mean of the velocities
of the (three) beam nodes. 

\newcommand{\Rloc}{{\TT{R}_{\text{loc}}}}
\newcommand{\Rtilde}[1]{\tilde{\TT{R}}_{#1}}
\newcommand{\Cay}[1]{\text{Cay}\plbr{#1}}
\newcommand{\Rot}[1]{\text{Rot}\plbr{#1}}
The aerodynamic forces and moments acting on the $i$-th node of the
beam are:
\begin{subequations}\label{eq:fici}
\begin{align}
	\T{f}_i &= \Rloc_i {\T{f}_a}_i\\ 
	\T{c}_i &= \Rloc_i {\T{c}_a}_i 
		+ \plbr{{\T{x}_r}_i - \T{x}_i}\times{\T{f}}_i 
\end{align}
\end{subequations}
where $\Rloc_i$ is the orientation 
matrix from the local frame of the aerodynamics
to the global, while ${\T{f}_a}_i$ and ${\T{c}_a}_i$ are the 
aerodynamic force and moment 
respectively in the reference frame of the aerodynamics, $\T{x}_r$
is the offset. 
By defining $\T{g}_{2\leftarrow{1}} = \Cay{\Rtilde{2}^T\Rtilde{1}}$ 
and $\T{g}_{2\leftarrow{3}} = \Cay{\Rtilde{2}^T\Rtilde{3}}$ (where, respectively,
$\Rtilde{i} = \TT{R}_i\TT{R}_{ai}$ is the orientation matrix from the 
local frame of the aerodynamics on the $i$-th node to the global),
matrix $\Rloc$ writes:
\begin{equation}
	\Rloc = \Rtilde{2} \Rot{N_1\T{g}_{2\leftarrow{1}} + N_3\T{g}_{2\leftarrow{3}}}
\end{equation}
where $N_1$ and $N_3$ are weight coefficients which depend on
the node the computation is referred to\footnote{Since the 
weight coefficients $N_i$ depends on the node for which the
forces are computed, also $\Rloc$ differs from node to node
even if it is not explicitely indicated in the formulas. }.

The relative velocity of the aerodynamic surface in the global
frame is computed as:
\begin{align}
	\T{v}_r &= \sum_{i=1}^3 N_i \plbr{\T{v}_i 
		+ \T{\omega}_i\times\T{R}_i\T{b}_i}\\
	\T{\omega}_r &= \sum_{i=1}^3 N_i \T{\omega}_i 
\end{align}
which is an interpolation of the velocities of the three nodes
of the beam.  
The total airstream velocity in the aerodynamic frame of reference 
includes also the free stream velocity $\T{v}_{\infty}$ and
the induced velocity $\T{v}_{\text{ind}}$, were the aerodynamic element
connected to any induced velocity model.
These two contributions will not be considered in the following
since they do not depend on the unknowns of the problem.  
In the same fashion, the offset of the reference 
aerodynamic surface is computed as:
\begin{equation}
	\T{x}_r = \sum_{i=1}^3 N_i \plbr{\T{x}_i 
		+ \T{R}_i\T{b}_i}
\end{equation}
The aerodynamic forces and moments $\T{f}_a$ and $\T{c}_a$
are computed using the same algorithm of Eq.~(\ref{eq:fa=g(va)}), 
and its differentiation is computed numerically using the same 
algorithm described in the previous section and its Jacobian matrix
($\T{J}_{a}$) is still divided into fout sub-matrices, as in 
Eq.~(\ref{eq:JaSub}).

Differentiating Eq.~(\ref{eq:fici}), one obtains:
\begin{align}
	\delta\T{f}_i &= \delta\Rloc \T{f}_a 
		+ \Rloc \sqbr{\T{J}_{a11}\ \T{J}_{a12}}
		\sqbr{\matr{c}{
		\delta\Rloc^T\T{v}_r + \Rloc^T\delta\T{v}_r\\
		\delta\Rloc^T\T{\omega}_r + \Rloc^T\delta\T{\omega}_r}}\\
\nonumber\delta\T{c}_i &= \delta\Rloc \T{c}_a 
		+ \Rloc \sqbr{\T{J}_{a21}\ \T{J}_{a22}}
		\sqbr{\matr{c}{
		\delta\Rloc^T\T{v}_r + \Rloc^T\delta\T{v}_r\\
		\delta\Rloc^T\T{\omega}_r + \Rloc^T\delta\T{\omega}_r}}\\
	&+ \plbr{\delta\T{x}_r - \delta\T{x}_i}\times\T{f}_i 
		+ \plbr{\T{x}_r - \T{x}_i}\times\delta\T{f}_i
\end{align}
These equations are composed by many terms and, in order to keep the
notation light, each contributions is written separately.
First of all, the most recursive terms are the product between 
$\delta\Rloc$ and a vector, and the product between $\delta\Rloc^T$
and a vector. These, defining $\overline{\T{g}}=N_1\T{g}_{2\leftarrow{1}} 
+ N_3\T{g}_{2\leftarrow{3}}$, 
result, respectively, in:
\newcommand{\vv}{\T{\overline{v}}}
\begin{align}
\nonumber	\plbr{\delta\Rloc}\vv &= 
		-\sqbr{\Rloc\vv}\times\T{\theta_{\delta 2}}\\ 
\nonumber	&+\sqbr{\Rot{\overline{\T{g}}}\vv}\times
		N_1\Rtilde{2}\T{\Gamma}\plbr{\overline{\T{g}}}
		\T{\Gamma}^{-1}\plbr{\T{g}_{2\leftarrow{1}}}\Rtilde{2}^T
		\plbr{\T{\theta_{\delta 2}}-\T{\theta_{\delta 1}}}\\ 
\nonumber	&-\sqbr{\Rot{\overline{\T{g}}}\vv}\times
		N_3\Rtilde{2}\T{\Gamma}\plbr{\overline{\T{g}}}
		\T{\Gamma}^{-1}\plbr{\T{g}_{2\leftarrow{3}}}\Rtilde{2}^T
		\plbr{\T{\theta_{\delta 2}}-\T{\theta_{\delta 3}}}\\ 
		\\
\nonumber	\plbr{\delta\Rloc^T}\vv &= 
		-\Rloc^T\vv\times\T{\theta_{\delta 2}}\\ 
\nonumber	&+N_1\sqbr{\Rot{\overline{\T{g}}}}^T
			\sqbr{\Rtilde{2}^T\vv}\times
		\T{\Gamma}\plbr{\overline{\T{g}}}
		\T{\Gamma}^{-1}\plbr{\T{g}_{2\leftarrow{1}}}\Rtilde{2}^T
		\plbr{\T{\theta_{\delta 1}}-\T{\theta_{\delta 2}}}\\ 
\nonumber	&+N_3\sqbr{\Rot{\overline{\T{g}}}}^T
			\sqbr{\Rtilde{2}^T\vv}\times
		\T{\Gamma}\plbr{\overline{\T{g}}}
		\T{\Gamma}^{-1}\plbr{\T{g}_{2\leftarrow{3}}}\Rtilde{2}^T
		\plbr{\T{\theta_{\delta 3}}-\T{\theta_{\delta 2}}}\\ 
\end{align}
The other components are:
\begin{align}
	\delta\T{v}_r &= \sum_{i=1}^3N_i\plbr{\delta\T{v}_i 
			- \TT{R}_i\T{b}_i\times\delta\T{\omega}_i
			- \T{\omega}_i\times\TT{R}_i\T{b}_i
			\times\T{\theta}_{\delta i}}\\
	\delta\T{\omega}_r &= \sum_{i=1}^3N_i\delta\T{\omega}_i\\ 
	\delta\T{x}_r &= \sum_{i=1}^3N_i\plbr{\delta\T{x}_i 
			- \TT{R}_i\T{b}_i\times\T{\theta}_{\delta i}}\\
	\delta\T{x}_i &= \delta\T{x}_i - \TT{R}_i\T{b}_i
			\times\T{\theta}_{\delta i}
\end{align}


