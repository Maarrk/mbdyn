% MBDyn (C) is a multibody analysis code.
% http://www.mbdyn.org
%
% Copyright (C) 1996-2009
%
% Pierangelo Masarati  <masarati@aero.polimi.it>
%
% Dipartimento di Ingegneria Aerospaziale - Politecnico di Milano
% via La Masa, 34 - 20156 Milano, Italy
% http://www.aero.polimi.it
%
% Changing this copyright notice is forbidden.
%
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation (version 2 of the License).
% 
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
%
% Mattia Mattaboni <mattaboni@aero.polimi.it> is the author of this document

Axis 3 is the rotor's axis.
$\T{v}$ is the composition of the velocity of the aircraft node
and of the airstream speed, if any, projected in the reference frame
of the aircraft, namely
\begin{align}
	\T{v}
	&=
	\TT{R}_\text{craft}^T \plbr{
		- \T{v}_\text{craft}
		+ \T{v}_\infty
	}
	.
\end{align}
Definitions:
\begin{subequations}
\begin{align}
	v_{12}
	&=
	\sqrt{v_1^2 + v_2^2}
	\\
	v
	&=
	\sqrt{v_1^2 + v_2^2 + v_3^2}
	= \sqrt{\T{v}^T \T{v}}
	\\
	\sin\alpha_d
	&=
	-v_3/v
	\\
	\cos\alpha_d
	&=
	v_{12}/v
	\\
	\psi_0
	&=
	\tan^{-1}\plbr{\frac{v_2}{v_1}}
	\\
	v_\text{tip}
	&=
	\Omega R
	\\
	\mu
	&=
	\cos\alpha_d \frac{v}{v_\text{tip}}
\end{align}
\end{subequations}
Note: $v \ge 0$ and $v_{12} \ge 0$ by definition;
as a consequence, $\cos\alpha_d \ge 0$,
while the sign of $\sin\alpha_d$ depends on whether
the flow related to the absolute motion of the rotor
enters the disk from above (> 0) or from below (< 0).
$v_\text{tip} > 0$ by construction
($\Omega = \nrbr{\T{\omega}}$, and no induced velocity
is computed if $\Omega$ is below a threshold).
As a consequence, $\mu \ge 0$.


Ground effect (if defined):
\begin{subequations}
\begin{align}
	u_\text{IGE}
	&=
	k_\text{GE} u_\text{OGE}
	\\
	k
	&=
	1 - \frac{1}{z^2}
	\\
	z
	&= \max\plbr{\frac{h}{R}, \frac{1}{4}}
\end{align}
\end{subequations}
where $h$ is the distance of the aircraft node from the ground node
(along axis 3 of the ground node).

The reference induced velocity $u$ is computed by solving the implicit problem
\begin{align}
	f
	&=
	% \frac{u}{v_\text{tip}}
	\lambda_u
	- \frac{C_t}{2\sqrt{\mu^2 + \lambda^2}}
	=
	0
	,
\end{align}
with
\begin{subequations}
\begin{align}
	\lambda_u
	&=
	\frac{u}{v_\text{tip}}
	\\
	\lambda
	&=
	\frac{v \sin\alpha_d + u}{v_\text{tip}}
	=
	\mu \tan\alpha_d
	+ \lambda_u
	.
\end{align}
\end{subequations}
The value of $\lambda_u$ is initialized using the reference induced velocity
$u$ at the previous step/iteration.
Only when $u=0$ and $C_t\neq 0$, $u$ is initialized using its nominal value
in hover,
\begin{align}
	u
	&=
	\text{sign}\plbr{T} \sqrt{\frac{\nrbr{T}}{2 \rho A}}
	.
\end{align}

The problem is solved by means of a local Newton iteration.
The Jacobian of the problem is
\begin{align}
	\frac{\partial f}{\partial \lambda_u}
	&=
	1 + \frac{C_t}{2 \plbr{\mu^2 + \lambda^2}^{3/2}} \lambda
	.
\end{align}
The solution,
\begin{align}
	\Delta\lambda_u
	&=
	- \plbr{\frac{\partial f}{\partial \lambda_u}}^{-1} f
	,
\end{align}
is added to $\lambda_u$ as
$\lambda_u = \lambda_u + \eta \Delta\lambda_u$,
where $0 < \eta \le 1$ is an optional relaxation factor.

Corrections:
the reference induced velocity is corrected by separately correcting
the inflow and advance parameters, namely
\begin{subequations}
\begin{align}
	\lambda^*
	&=
	\frac{\lambda}{k_\text{H}^2}
	\\
	\mu^*
	&=
	\frac{\mu}{k_\text{FF}}
	.
\end{align}
\end{subequations}
The reference induced velocity is then recomputed as
\begin{align}
	u^*
	&=
	\plbr{1 - \rho} k_\text{GE} v_\text{tip}
		\frac{C_t}{2 \sqrt{\mu^{*^2} + \lambda^{*^2}}}
	+ \rho u^*_\text{prev}
	,
\end{align}
where $0 \le \rho < 1$ is a memory factor.

Note: in principle, multiple solutions for $\lambda_u$ are possible.
However, only one solution is physical.
Currently, no strategy is put in place to ensure that only the physical
solution is considered.


\subsection{Glauert model}

In forward flight (when $\mu > 0.15$) the inflow over the rotor disk can 
be approximated by:
\begin{align}
\lambda_i &= \lambda_0 \left( 1 + k_x \frac{x}{R} + k_y \frac{y}{R} \right)
\\
&= \lambda_0 \left( 1 + k_x r \cos{\psi} + k_y r \sin{\psi} \right),
\end{align}
where the mean induced velocity $\lambda_0$ is computed as shown in the
previous section.

In literature a lot of expressions for the $k_x$ and $k_y$ coefficients have
been proposed by different authors. In MBDyn the following expressions are
used:
\begin{align}
k_x &=  \frac{4}{3} \left( 1 - 1.8 \mu^2 \right) \tan{\frac{\chi}{2}}
\\
k_y &= 0,
\end{align}
FIXME: Ã¨ diversa dalle espressioni riportate sul Leishman


where $\chi$ is the wake skew angle:
\begin{equation}
\chi = \tan^{-1}\left( \frac{\mu}{\lambda} \right).
\end{equation}
CHECK: dovrebbe essere equivalente all'espressione di Leishman ma
sarebbe meglio verificare!!!

Note: the Glauert inflow model exactly matches the uniform inflow model
when the advance ratio is null, i.e in hover, because:
\begin{equation}
\mu = 0, 
\end{equation}
therefore:
\begin{equation}
\chi = k_x = 0,
\end{equation}
that means that the induced velocity is uniform over the rotor disk and
equal to $\lambda_0$.

\subsection{Mangler-Squire model}

The Mangler-Squire model is developed under the high speed assumption
and it should be used only for advance ratio grater than 0.1.

In the original formulation the induced velocity is computed as:
\begin{equation}
\lambda_i = \left( \frac{ 2 C_T}{\mu} \right) \left[ 
\frac{c_0}{2} - \sum_{n=1}^{\infty} c_n(r,\alpha) \cos{n \psi} \right],
\end{equation}
since the advance ratio $\mu$ appears in the denominator this expression is
not valid in hover. Bramwell proposed a different expression for the induced 
velocity:
\begin{equation}
\lambda_i = 4 \lambda_0 \left[ 
\frac{c_0}{2} - \sum_{n=1}^{\infty} c_n(r,\alpha) \cos{n \psi} \right],
\end{equation}
where $\lambda_0$ is the mean inflow computed as shown before. In this way
the Mangler-Squire inflow model makes sense also in hover. MBDyn uses the latter
version.

Regarding the $c_n$ coefficients, their expression depends on the form of the 
rotor disk loading. Mangler and Squire developed the theory for two fundamental
forms: Type I (elliptical loading) and Type III (a loading that vanishes at the 
edges and at the center of the disk). The total loading is finally obtained by
a linear combination of Type I and Type III loadings (see \cite{LEISHMAN-2006}).

MBDyn uses just a Type III loading, and the resulting expressions for the
$c_n$ coefficients are:
\begin{equation}
c_0 = \frac{15}{8} \eta \left( 1-\eta^2 \right),
\end{equation}
where $\eta = \sqrt{ 1 - r^2}$.
\begin{equation}
c_1 = -\frac{ 15 \pi}{256} 
\left( 5 - 9 \eta^2 \right)
\left[ 
\left(1-\eta^2\right)
\left( \frac{1 - \sin{\alpha}}{1 + \sin{\alpha}} \right)
\right]^{\frac{1}{2}},
\end{equation}
\begin{equation}
c_3 = \frac{ 45 \pi}{256} 
\left[ 
\left(1-\eta^2\right)
\left( \frac{1 - \sin{\alpha}}{1 + \sin{\alpha}} \right)
\right]^{\frac{3}{2}},
\end{equation}
and $c_n = 0$ for odd values of $n \ge 0$.

For even values:
\begin{equation}
c_n = (-1)^{\frac{n-2}{2}} 
\frac{15}{8}
\left[ 
{\frac{\eta + n}{n^2 -1}} \dot {\frac{9 \eta^2 + n^2 -6}{n^2 -9}} + 
{\frac{ 3 \eta}{n^2 -9}} 
\right]
\left[ 
\left( \frac{1 - \eta}{1 + \eta} \right)
\left( \frac{1 - \sin{\alpha}}{1 + \sin{\alpha}} \right)
\right]^{\frac{n}{2}},
\end{equation}

Note: the Bramwell version makes sense also in hover but gives different
results with respect to the uniform inflow and the Glauert inflow models.
Let assume $\alpha = \frac{\pi}{2}$, it follows that $c_n = 0$ for $n \ge 1$.
Therefore the induced velocity does not depend on the azimuthal position 
$\psi$ but only on the radial position $r$, so the inflow is not uniform, 
but the mean inflow is still $\lambda_0$.
