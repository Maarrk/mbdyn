# This file is a template, and might need editing before it works on your project.
# This is a sample GitLab CI/CD configuration file that should run without any modifications.
# It demonstrates a basic 3 stage CI/CD pipeline. Instead of real tests or scripts,
# it uses echo commands to simulate the pipeline execution.
#
# A pipeline is composed of independent jobs that run scripts, grouped into stages.
# Stages run in sequential order, but jobs within stages run in parallel.
#
# For more information, see: https://docs.gitlab.com/ee/ci/yaml/index.html#stages
#
# You can copy and paste this template into a new `.gitlab-ci.yml` file.
# You should not add this template to an existing `.gitlab-ci.yml` file by using the `include:` keyword.
#
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Getting-Started.gitlab-ci.yml

variables:
  MBD_INSTALL_PREFIX: "/home/gitlab-runner/local/mbdyn-test-install/" ## Local installation directory for MBDyn
  MBD_MERGE_BRANCH: "fix-netcdf-eig"
  GMSH_INSTALL_PREFIX: "/home/gitlab-runner/local/gmsh-test-install/" ## Local installation directory for Gmsh
  MBOCT_INSTALL_PREFIX: "/home/gitlab-runner/local/mboct-test-install/" ## Local installation directory for Gmsh
  MKL_INSTALL_PREFIX: "/home/gitlab-runner/local/mkl-test-install/" ## Local installation directory for MKL
  NC_INSTALL_PREFIX: "/home/gitlab-runner/local/netcdf-test-install/" ## Local installation directory for NetCDF
  NL_INSTALL_PREFIX: "/home/gitlab-runner/local/nlopt-test-install/" ## Local installation directory for nlopt
  MBD_BUILD_DIR: "/home/gitlab-runner/install/mbdyn-test-build/" ## Local build directory
  MBD_NUM_BUILD_JOBS: "12" # Run make -j$MBD_NUM_BUILD_JOBS
  MBD_CLEAN_ALL: "no" ## Should be set to "yes" as soon as the testsuite is finished
  MBD_CLEAN_BUILD: "no" ## Clean up the build directory
  MBD_COMPILER_FLAGS: "-Ofast -Wall -march=native -mtune=native" ## Compiler flags for MBDyn and mboct-*-pkg
  OCT_PKG_LIST: "nurbs netcdf mboct-octave-pkg mboct-numerical-pkg mboct-mbdyn-pkg mboct-fem-pkg"
  OCT_PKG_REBUILD: "nurbs:no netcdf:no mboct-octave-pkg:no mboct-numerical-pkg:no mboct-mbdyn-pkg:no mboct-fem-pkg:no"
  OCT_PKG_BRANCH: "nurbs:master netcdf:master mboct-octave-pkg:master mboct-numerical-pkg:master mboct-mbdyn-pkg:master mboct-fem-pkg:master"
  OCT_PKG_TESTS: "nurbs:no netcdf:no mboct-octave-pkg:yes mboct-numerical-pkg:no mboct-mbdyn-pkg:yes mboct-fem-pkg:no"
  OCT_PKG_TIMEOUT: "nurbs:-1 netcdf:-1 mboct-octave-pkg:-1 mboct-numerical-pkg:-1 mboct-mbdyn-pkg:-1 mboct-fem-pkg:-1"
  OCTAVE_EXEC: "octave"
  MKL_URL: "https://registrationcenter-download.intel.com/akdlm/IRC_NAS/86d6a4c1-c998-4c6b-9fff-ca004e9f7455/"
  MKL_PACKAGE: "l_onemkl_p_2024.0.0.49673.sh"
  MKL_PKG_CONFIG: "mkl-dynamic-lp64-gomp" ## MKL pkg-config file without extension (e.g. use "${MKL_PKG_CONFIG}.pc")

stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - deploy

mkl-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
      - echo "MKL installation job"
      - |
          if test -d "${MKL_INSTALL_PREFIX}"; then
              echo "Find all pkg-config files in ${MKL_INSTALL_PREFIX} ..."
              find "${MKL_INSTALL_PREFIX}" '(' -name pkgconfig -or -name '*.pc' ')'
              echo "Search for ${MKL_PKG_CONFIG}.pc ..."
              MKL_PKG_CONFIG_FILE=`find "${MKL_INSTALL_PREFIX}" '(' -type f -and -name "${MKL_PKG_CONFIG}.pc" ')'`
              if test -f "${MKL_PKG_CONFIG_FILE}"; then
                  MKL_PKG_CONFIG_PATH=`dirname "${MKL_PKG_CONFIG_FILE}"`
              else
                  echo "File ${MKL_PKG_CONFIG}.pc not found"
              fi
          fi
      - |
        if test -d "${MKL_PKG_CONFIG_PATH}" -a "${MBD_CLEAN_ALL}" = "no"; then
          echo "MKL was already installed in ${MKL_PKG_CONFIG_PATH}"
          exit 0
        fi
      - |
          rm -rf "${MKL_INSTALL_PREFIX}"
          if test -z "${MKL_URL}"; then
            echo "MKL_URL was not defined"
            exit 0
          fi
          if test -z "${MKL_PACKAGE}"; then
            echo "MKL_PACKAGE was not defined"
            exit 0
          fi
          if test -f "./${MKL_PACKAGE}"; then
            rm -f "./${MKL_PACKAGE}"
          fi
          if ! wget "${MKL_URL}${MKL_PACKAGE}"; then
            echo "Failed to download ${MKL_URL}${MKL_PACKAGE}"
            exit 1
          fi
          if ! test -f "./${MKL_PACKAGE}"; then
            echo "File not found ${MKL_PACKAGE}"
            exit 1
          fi
      - chmod u+x "./${MKL_PACKAGE}"
      - MKL_STATUS="failed"
      - |
          # FIXME: Need to remove MKL before we are able to install it again
          if ! sh "./${MKL_PACKAGE}" -r yes -a -s --eula accept --ignore-errors --action remove --install-dir "${MKL_INSTALL_PREFIX}"; then
              echo "Failed to remove MKL ..."
          fi
      - echo "removing ${MKL_INSTALL_PREFIX} ..."
      - rm -rf ${MKL_INSTALL_PREFIX}
      - |
          if sh "./${MKL_PACKAGE}" -r yes -a -s --eula accept --ignore-errors --action install --install-dir "${MKL_INSTALL_PREFIX}"; then
              MKL_STATUS="succeeded"
          fi
      - rm -f "./${MKL_PACKAGE}"
      - |
          if test "${MKL_STATUS}" != "succeeded"; then
              echo "Failed to install MKL"
              exit 1
          fi

netcdf-c-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
      - echo "netcdf-c installation job"
      - |
        if "${NC_INSTALL_PREFIX}/bin/nc-config" --version >& /dev/null && test "${MBD_CLEAN_ALL}" = "no"; then
          echo "netcdf-c was already installed"
          exit 0
        fi
      - rm -rf netcdf-c
      - git clone -b main https://github.com/Unidata/netcdf-c.git
      - cd netcdf-c
      - mkdir build_dir
      - cd build_dir
      - cmake .. -DENABLE_NETCDF_4=ON -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX="${NC_INSTALL_PREFIX}"
      - make -j${MBD_NUM_BUILD_JOBS}
      - if test -d "${NC_INSTALL_PREFIX}"; then rm -rf "${NC_INSTALL_PREFIX}"; fi
      - make install

netcdf-cxx4-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
      - echo "netcdf-cxx4 installation job"
      - |
        if "${NC_INSTALL_PREFIX}/bin/ncxx4-config" --version >& /dev/null && test "${MBD_CLEAN_ALL}" = "no"; then
          echo "netcdf-cxx4 was already installed"
          exit 0
        fi
      - rm -rf netcdf-cxx4
      - git clone -b master https://github.com/Unidata/netcdf-cxx4.git
      - cd netcdf-cxx4
      - mkdir build_dir
      - cd build_dir
      - cmake .. -DENABLE_NETCDF_4=ON -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX="${NC_INSTALL_PREFIX}" -DnetCDF_DIR="${NC_INSTALL_PREFIX}/lib/cmake/netCDF"
      - make -j${MBD_NUM_BUILD_JOBS}
      - make install

nlopt-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
      - |
        if test -d "${NL_INSTALL_PREFIX}"; then
          NL_PKG_CONFIG=`find ${NL_INSTALL_PREFIX} '(' -type d -and -name pkgconfig ')'`
        fi
        if ! test -z "${NL_PKG_CONFIG}" && test -f "${NL_PKG_CONFIG}/nlopt.pc" && test "${MBD_CLEAN_ALL}" = "no"; then
          echo "nlopt was already installed"
          exit 0
        fi
      - rm -rf nlopt
      - git clone -b master https://github.com/stevengj/nlopt.git
      - cd nlopt
      - mkdir build
      - cd build
      - cmake .. -DCMAKE_INSTALL_PREFIX="${NL_INSTALL_PREFIX}" -DBUILD_SHARED_LIBS=ON -DNLOPT_OCTAVE=OFF -DNLOPT_PYTHON=OFF
      - make -j${MBD_NUM_BUILD_JOBS}
      - make install

mbdyn-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    #- echo "Cleanup some garbage ..."
    #- |
    #  for dirent in autom4te.cache build contrib CVS etc include libraries manual mbdyn modules packaging tests utils var; do
     #   if test -d ${HOME}/${dirent}; then
          #find ${HOME}/${dirent} -type f
          #rm -rf ${HOME}/${dirent}
      #  fi
    #  done
    - printf "checkout branch \"%s\"\n" "$CI_COMMIT_BRANCH"
    - git checkout $CI_COMMIT_BRANCH --force
    - printf "pulling\n"
    - git pull --force
    - |
        if ! test -z "${MBD_MERGE_BRANCH}"; then
            if git fetch origin "${MBD_MERGE_BRANCH}:${MBD_MERGE_BRANCH}"; then
                if git merge --no-commit "origin/${MBD_MERGE_BRANCH}"; then
                    echo "branch ${MBD_MERGE_BRANCH} was merged"
                else
                    echo "branch ${MBD_MERGE_BRANCH} could not be merged"
                    git merge --abort
                fi
            else
                echo "branch ${MBD_MERGE_BRANCH} does not exist"
            fi
        else
            echo "there is no branch to merge"
        fi
    ## Let's try to speed up the build process a bit
    ## Execute bootstrap.sh and configure only if needed
    ## This conditional execution may be removed as soon as the testsuite is finished
    - |
      if ! test -x ./configure ; then
        chmod u+x ./bootstrap.sh
        ./bootstrap.sh
      fi
      test -x ./configure
    - MBD_SOURCE_DIR=`pwd`
    - echo "Create build directory ..."
    - |
      if test ${MBD_CLEAN_BUILD} = "yes" -o ${MBD_CLEAN_ALL} = "yes"; then
        echo "cleanup build directory ..."
        rm -rf ${MBD_BUILD_DIR}
      fi
    - echo "create build directory ..."
    - if ! test -d ${MBD_BUILD_DIR}; then mkdir -p ${MBD_BUILD_DIR}; fi
    - test -d ${MBD_BUILD_DIR}
    - if ! test -d ${MBD_INSTALL_PREFIX}; then mkdir -p ${MBD_INSTALL_PREFIX}; fi
    - test -d ${MBD_INSTALL_PREFIX}
    - cd ${MBD_BUILD_DIR}
    - echo "Build directory"
    - pwd
    - ls -lhF .
    - export PATH="${NC_INSTALL_PREFIX}/bin:${PATH}"
    - LDFLAGS=""
    - CPPFLAGS="-I/usr/include/suitesparse -I/usr/include/trilinos -I/usr/lib64/python3.11/site-packages/numpy/core/include -I/usr/include/python3.11/ -I/usr/include/octave-8.4.0"
    - echo "Detecting NetCDF ..."
    - |
      if ncxx4-config --help >& /dev/null; then
        NC_INCDIR=`ncxx4-config --includedir`
        NC_LIBDIR=`ncxx4-config --libdir`
        CPPFLAGS="${CPPFLAGS} -I${NC_INCDIR}"
        LDFLAGS="${LDFLAGS} -L${NC_LIBDIR} -Wl,-rpath=${NC_LIBDIR}"
      fi
    - echo "Detecting MKL ..."
    - |
          if test -d "${MKL_INSTALL_PREFIX}"; then
              echo "Find all pkg-config files in ${MKL_INSTALL_PREFIX} ..."
              find "${MKL_INSTALL_PREFIX}" '(' -name pkgconfig -or -name '*.pc' ')'
              echo "Search for ${MKL_PKG_CONFIG}.pc ..."
              MKL_PKG_CONFIG_FILE=`find "${MKL_INSTALL_PREFIX}" '(' -type f -and -name "${MKL_PKG_CONFIG}.pc" ')'`
              if test -f "${MKL_PKG_CONFIG_FILE}"; then
                  MKL_PKG_CONFIG_PATH=`dirname "${MKL_PKG_CONFIG_FILE}"`
                  echo "MKL_PKG_CONFIG_PATH=${MKL_PKG_CONFIG_PATH}"
              else
                  echo "File ${MKL_PKG_CONFIG}.pc not found"
              fi
          fi
    - PARDISO_FLAGS="--without-pardiso"
    - |
        if test -d "${MKL_PKG_CONFIG_PATH}"; then
            export PKG_CONFIG_PATH="${MKL_PKG_CONFIG_PATH}:${PKG_CONFIG_PATH}"
            if pkg-config --validate "${MKL_PKG_CONFIG}"; then
                PARDISO_FLAGS="--with-pardiso"
                CPPFLAGS="${CPPFLAGS} `pkg-config --cflags-only-I ${MKL_PKG_CONFIG}`"
                LDFLAGS="${LDFLAGS} `pkg-config --libs-only-L ${MKL_PKG_CONFIG}`"
                LDFLAGS="${LDFLAGS} `pkg-config --libs-only-L ${MKL_PKG_CONFIG} | sed  's/^-L\//-Wl,-rpath=\//g'`"
            else
                echo "pkg-config ${MKL_PKG_CONFIG} is not valid"
            fi
        else
            echo "Warning: MKL_PKG_CONFIG_PATH could not be detected"
        fi
    - printf "configure ...\n"
    - |
      if ! test -f Makefile; then
        if ! ${MBD_SOURCE_DIR}/configure \
                    PYTHON_VERSION=3 \
                    CPPFLAGS="${CPPFLAGS}" \
                    LDFLAGS="${LDFLAGS}" \
                    CXXFLAGS="${MBD_COMPILER_FLAGS}" \
                    CFLAGS="${MBD_COMPILER_FLAGS}" \
                    FFLAGS="${MBD_COMPILER_FLAGS}" \
                    FCFLAGS="${MBD_COMPILER_FLAGS}" \
                    --enable-python \
                    --enable-octave \
                    --enable-install_test_progs \
                    --enable-netcdf \
                    --prefix="${MBD_INSTALL_PREFIX}" \
                    --with-umfpack \
                    --with-klu \
                    ${PARDISO_FLAGS} \
                    --with-suitesparseqr \
                    --with-static-modules \
                    --disable-Werror \
                    --with-trilinos ; then
                    ## FIXME: We should not use --disable-Werror, but need to fix a few warnings caused by Octave's headers instead
          echo "Failed to run configure"
          exit 1
        fi
      fi
      test -f Makefile
    - printf "Compiling the code using %s jobs ...\n" ${MBD_NUM_BUILD_JOBS}
    - make -j${MBD_NUM_BUILD_JOBS}
    - echo "Clean up local installation directory"
    - rm -rf ${MBD_INSTALL_PREFIX}
    - printf "Install the code in \"%s\"\n" "${MBD_INSTALL_PREFIX}"
    - make install
    - echo "MBDyn version:"
    - ${MBD_INSTALL_PREFIX}/bin/mbdyn --version
    - echo "Run built-in unit tests"
    - make test

octave-pkg-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
        - echo "octave packages installation job"
        - echo "Detecting MKL ..."
        - |
          if test -d "${MKL_INSTALL_PREFIX}"; then
              echo "Find all pkg-config files in ${MKL_INSTALL_PREFIX} ..."
              find "${MKL_INSTALL_PREFIX}" '(' -name pkgconfig -or -name '*.pc' ')'
              echo "Search for ${MKL_PKG_CONFIG}.pc ..."
              MKL_PKG_CONFIG_FILE=`find "${MKL_INSTALL_PREFIX}" '(' -type f -and -name "${MKL_PKG_CONFIG}.pc" ')'`
              if test -f "${MKL_PKG_CONFIG_FILE}"; then
                  MKL_PKG_CONFIG_PATH=`dirname "${MKL_PKG_CONFIG_FILE}"`
                  echo "MKL_PKG_CONFIG_PATH=${MKL_PKG_CONFIG_PATH}"
              else
                  echo "File ${MKL_PKG_CONFIG}.pc not found"
              fi
          fi
        - |
            if test -d "${MKL_PKG_CONFIG_PATH}"; then
                export PKG_CONFIG_PATH="${MKL_PKG_CONFIG_PATH}:${PKG_CONFIG_PATH}"
                if pkg-config --validate "${MKL_PKG_CONFIG}"; then
                  export PARDISO_INC=`pkg-config --cflags ${MKL_PKG_CONFIG}`
                  export PARDISO_LIBS=`pkg-config --libs ${MKL_PKG_CONFIG}`
                  export PARDISO_LIBS="${PARDISO_LIBS} `pkg-config --libs-only-L ${MKL_PKG_CONFIG} | sed  's/^-L\//-Wl,-rpath=\//g'`"
                else
                  echo "Warning: MKL pkg-config ${MKL_PKG_CONFIG} is not valid"
                fi
            else
                echo "Warning: MKL_PKG_CONFIG_PATH does not exist"
            fi
        - |
          NL_PKG_CONFIG_PATH=`find ${NL_INSTALL_PREFIX} '(' -type d -and -name pkgconfig ')'`
          if ! test -z "${NL_PKG_CONFIG_PATH}"; then
            export PKG_CONFIG_PATH="${NL_PKG_CONFIG_PATH}:${PKG_CONFIG_PATH}"
            export NLOPT_LIBS=`pkg-config --libs nlopt`
            export NLOPT_INC=`pkg-config --cflags nlopt`
            NL_LIBDIR=`pkg-config --variable=libdir nlopt`
            if ! test -z "${NL_LIBDIR}"; then
                NLOPT_LIBS="${NLOPT_LIBS} -Wl,-rpath=${NL_LIBDIR}"
            fi
          fi
        - |
          if "${NC_INSTALL_PREFIX}/bin/nc-config" --version >& /dev/null; then
            NC_PKG_CONFIG_PATH=`find ${NC_INSTALL_PREFIX} '(' -type d -and -name pkgconfig ')'`
            if ! test -z "${NC_PKG_CONFIG_PATH}"; then
              export PKG_CONFIG_PATH="${NC_PKG_CONFIG_PATH}:${PKG_CONFIG_PATH}"
            fi
            export PATH="${NC_INSTALL_PREFIX}/bin:${PATH}"
          fi
        - echo PKG_CONFIG_PATH="${PKG_CONFIG_PATH}"
        - echo NLOPT_LIBS="${NLOPT_LIBS}"
        - echo NLOPT_INC="${NLOPT_INC}"
        - |
          for pkgname in ${OCT_PKG_LIST}; do
              printf "build package \"%s\"\n" "${pkgname}"

              pkg_rebuild_flag=$(echo ${OCT_PKG_REBUILD} | awk -v RS=" " -F ":" "/^${pkgname}\>/{print \$2}")

              case "${pkg_rebuild_flag}" in
                  yes|no)
                      ;;
                  *)
                      pkg_rebuild_flag="no"
                      ;;
              esac

              pkg_branch=$(echo ${OCT_PKG_BRANCH} | awk -v RS=" " -F ":" "/^${pkgname}\>/{print \$2}")

              if test -z "${pkg_branch}"; then
                  pkg_branch="master"
              fi

              if test "${pkg_rebuild_flag}" = "no" -a "${MBD_CLEAN_ALL}" = "no"; then
                  if ${OCTAVE_EXEC} -qfH --eval "pkg load ${pkgname}"; then
                      printf "installation of \"%s\" will be skipped, because the package is already installed\n" "${pkgname}"
                      continue
                  fi
              fi

              case "${pkgname}" in
                  mboct-*-pkg)
                      if test -d "${pkgname}"; then
                          rm -rf "${pkgname}"
                      fi
                      if ! git clone -b "${pkg_branch}" "https://github.com/octave-user/${pkgname}.git"; then
                          printf "failed to clone package \"%s\" from github.com\n" "${pkgname}"
                          exit 1
                      fi
                      if ! make CXXFLAGS="${MBD_COMPILER_FLAGS}" -C "${pkgname}" install_local; then
                          printf "failed to build package \"%s\"\n" "${pkgname}"
                      fi
                      case "${pkgname}" in
                      mboct-fem-pkg)
                          ## FIXME: Need install fem_pre_mesh_size since octave's package manager does not run "make install"
                          mkdir -p "${MBOCT_INSTALL_PREFIX}/bin"
                          pushd "${pkgname}/src"
                          chmod u+x bootstrap
                          ./bootstrap
                          ./configure CXXFLAGS="${MBD_COMPILER_FLAGS}" --prefix="${MBOCT_INSTALL_PREFIX}"
                          make
                          make install
                          popd
                          ;;
                      esac
                      ;;
                  *)
                      # Assume that the package is hosted at octave-forge
                      if ! ${OCTAVE_EXEC} -qfH --eval "pkg install -verbose -local -forge ${pkgname}"; then
                          printf "failed to install package \"%s\" from octave-forge\n" "${pkgname}"
                          exit 1
                      fi
                      ;;
              esac

              if ${OCTAVE_EXEC} -qfH --eval "pkg load ${pkgname}"; then
                  printf "package \"%s\" was loaded successfully\n" "${pkgname}"
              else
                  printf "failed to load package \"%s\"\n" "${pkgname}"
                  exit 1
              fi
          done

gmsh-build-job:       # This job runs in the build stage, which runs first.
   stage: build
   script:
       - echo "gmsh build"
       - |
         export PATH=${GMSH_INSTALL_PREFIX}/bin:${PATH}
         if gmsh --version >& /dev/null && test "${MBD_GMSH_REINSTALL}" = "no" && test "${MBD_CLEAN_ALL}" = "no" ; then
           echo "Gmsh was already installed ..."
           exit 0
         fi
       - wget http://www.gmsh.info/bin/Linux/gmsh-stable-Linux64.tgz
       - tar -zxvf gmsh-stable-Linux64.tgz
       - mkdir -p "${GMSH_INSTALL_PREFIX}/bin"
       - install gmsh-*.*.*-Linux64/bin/gmsh "${GMSH_INSTALL_PREFIX}/bin"
       - ${GMSH_INSTALL_PREFIX}/bin/gmsh --version

octave-pkg-test-job:   # This job runs in the test stage.
  stage: test    # It only starts when the job in the build stage completes successfully.
  script:
      - echo "octave packages test job"
      - export PATH=${MBD_INSTALL_PREFIX}/bin:${GMSH_INSTALL_PREFIX}/bin:${MBOCT_INSTALL_PREFIX}/bin:${PATH}
      - export AWKPATH=${MBD_INSTALL_PREFIX}/share/awk:${AWKPATH}
      - which mbdyn
      - mbdyn --version
      - which mbdyn2easyanim.sh
      - which gmsh
      - gmsh --version
      - which octave
      - ${OCTAVE_EXEC} -qfH --version
      - |
        test_status="passed"
        failed_packages=""

        for pkgname in ${OCT_PKG_LIST}; do
            pkg_test_flag=$(echo ${OCT_PKG_TESTS} | awk -v RS=" " -F ":" "/^${pkgname}\>/{print \$2}")

            case "${pkg_test_flag}" in
                yes)
                    printf "test package \"%s\"\n" "${pkgname}"
                    ;;
                *)
                    printf "tests of package \"%s\" skipped\n" "${pkgname}"
                    continue
                    ;;
            esac

            rm -f fntests.out fntests.log

            curr_test_status="failed"

            OCTAVE_CODE="pkg(\"load\",\"${pkgname}\");p=pkg(\"list\",\"${pkgname}\");__run_test_suite__({p{1}.dir},{});"

            pkg_test_timeout=$(echo ${OCT_PKG_TIMEOUT} | awk -v RS=" " -F ":" "/^${pkgname}\>/{print \$2}")

            case "${pkg_test_timeout}" in
            -1)
              echo "Timeout: not applied"
              ulimit -S -t unlimited                
              ;;
            *)
              echo "Timeout: ${pkg_test_timeout}s"
              ulimit -S -t "${pkg_test_timeout}"
              ;;
            esac

            echo ${OCTAVE_EXEC} -qfH --eval "${OCTAVE_CODE}"

            if ${OCTAVE_EXEC} -qfH --eval "${OCTAVE_CODE}" >& fntests.out && awk -f parse_test_suite_status.awk fntests.out; then
                curr_test_status="passed"
            fi

            ulimit -S -t unlimited

            case "${curr_test_status}" in
                passed)
                    printf "octave testsuite for package \"%s\" passed\n" "${pkgname}"
                    ;;
                *)
                    printf "octave testsuite for package \"%s\" failed\n" "${pkgname}"
                    if test -f fntests.log; then
                        cat fntests.log;
                    else
                        echo "fntests.log not found";
                    fi
                    test_status="failed"
                    failed_packages="${failed_packages} ${pkgname}"
                    ;;
            esac
        done

        rm -f fntests.out fntests.log

        case "${test_status}" in
            passed)
                echo "all tests passed"
                ;;
            *)
                echo "the following packages did not pass:"
                for pkgname in ${failed_packages}; do
                    printf "%s\n" "${pkgname}"
                done
                exit 1
                ;;
        esac

deploy-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
