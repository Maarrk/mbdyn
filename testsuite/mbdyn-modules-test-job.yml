mbdyn-modules-test-job:   # This job runs in the test stage.
  stage: test    # It only starts when the job in the build stage completes successfully.
  needs:
      - job: mkl-build-job
      - job: netcdf-c-build-job
        artifacts: true
      - job: netcdf-cxx4-build-job
        artifacts: true
      - job: nlopt-build-job
        artifacts: true
      - job: mbdyn-build-job
        artifacts: true
      - job: gmsh-build-job ## module-triangular_contact is using Gmsh
        artifacts: true
      - job: octave-pkg-build-job ## module-triangular_contact is using Octave
        artifacts: true
  script:
      - MBD_INSTALL_PREFIX=${CI_PROJECT_DIR}/${MBD_INSTALL_PREFIX}
      - OCT_PKG_INSTALL_PREFIX=${CI_PROJECT_DIR}/${OCT_PKG_INSTALL_PREFIX}
      - GMSH_INSTALL_PREFIX=${CI_PROJECT_DIR}/${GMSH_INSTALL_PREFIX}
      - MBD_MODULE_TEST_OUTPUT_DIR=${CI_PROJECT_DIR}/${MBD_MODULE_TEST_OUTPUT_DIR}
      - echo "MBDyn modules test job"
      - export PATH=${MBD_INSTALL_PREFIX}/bin:${GMSH_INSTALL_PREFIX}/bin:${OCT_PKG_INSTALL_PREFIX}/bin:${PATH}
      - export AWKPATH=${MBD_INSTALL_PREFIX}/share/awk:${AWKPATH}
      - MBD_MODULE_TEST_INPUT_DIR=${CI_PROJECT_DIR}/modules
      - export LD_LIBRARY_PATH=${MBD_INSTALL_PREFIX}/libexec:${LD_LIBRARY_PATH}
      - ls -lhF ${MBD_INSTALL_PREFIX}/libexec
      - test -d "${MBD_MODULE_TEST_INPUT_DIR}"
      - mkdir -p "${MBD_MODULE_TEST_OUTPUT_DIR}" ## needed for realpath
      - chmod +x testsuite/simple_testsuite.sh
      - testsuite/simple_testsuite.sh --exit-status-mask "${MBD_MODULE_TEST_EXIT_STATUS_MASK}" --timeout "${MBD_MODULE_TEST_TIMEOUT}" --prefix-output "${MBD_MODULE_TEST_OUTPUT_DIR}" --prefix-input "${MBD_MODULE_TEST_INPUT_DIR}" ${MBD_SIMPLE_TESTSUITE_FLAGS} 2>&1 | tee "${MBD_MODULE_TEST_OUTPUT_DIR}/mbdyn-module-tests-job.log"
  artifacts:
     expire_in: 2 days
     name: mbdyn-modules-test-job
     paths:
       - $MBD_MODULE_TEST_OUTPUT_DIR/mbdyn-module-tests-job.log
   on-cancel: mbdyn-cleanup-job
