octave-pkg-test-job:   # This job runs in the test stage.
  stage: test    # It only starts when the job in the build stage completes successfully.
  needs:
      - job: mkl-build-job
      - job: netcdf-c-build-job
        artifacts: true
      - job: netcdf-cxx4-build-job
        artifacts: true
      - job: nlopt-build-job
        artifacts: true
      - job: mbdyn-build-job
        artifacts: true
      - job: gmsh-build-job
        artifacts: true
      - job: octave-pkg-build-job
        artifacts: true
  script:
      - MKL_INSTALL_PREFIX=${HOME}/${MKL_INSTALL_PREFIX}
      - MBD_INSTALL_PREFIX=${CI_PROJECT_DIR}/${MBD_INSTALL_PREFIX}
      - OCT_PKG_INSTALL_PREFIX=${CI_PROJECT_DIR}/${OCT_PKG_INSTALL_PREFIX}
      - GMSH_INSTALL_PREFIX=${CI_PROJECT_DIR}/${GMSH_INSTALL_PREFIX}
      - OCT_PKG_TEST_OUTPUT_DIR=${CI_PROJECT_DIR}/${OCT_PKG_TEST_OUTPUT_DIR}
      - echo "octave packages test job"
      - export PATH=${MBD_INSTALL_PREFIX}/bin:${GMSH_INSTALL_PREFIX}/bin:${OCT_PKG_INSTALL_PREFIX}/bin:${PATH}
      - export AWKPATH=${MBD_INSTALL_PREFIX}/share/awk:${AWKPATH}
      - which mbdyn
      - mbdyn --version
      - which mbdyn2easyanim.sh
      - which gmsh
      - gmsh --version
      - which octave
      - ${OCTAVE_EXEC} -qfH --version
      - chmod +x testsuite/octave_pkg_testsuite.sh
      ## FIXME: It seems that everything must be on one long line
      - testsuite/octave_pkg_testsuite.sh --print-resources time+profile --verbose yes --octave-pkg-list "${OCT_PKG_LIST}" --octave-exec "${OCTAVE_EXEC}" --octave-pkg-tests "${OCT_PKG_TESTS}" --timeout "${OCT_PKG_TIMEOUT}" --octave-pkg-test-dir "${OCT_PKG_TEST_OUTPUT_DIR}" --octave-pkg-test-mode "${OCT_PKG_TEST_MODE}" --octave-pkg-prefix "${OCT_PKG_INSTALL_PREFIX}" 2>&1 | tee "${OCT_PKG_TEST_OUTPUT_DIR}/octave-pkg-test-job.log"
  on_cancel: mbdyn-cleanup-job
  artifacts:
    name: octave-pkg-test-output-dir
    expire_in: 2 days
    paths:
      - $OCT_PKG_TEST_OUTPUT_DIR/octave-pkg-test-job.log
