netcdf-c-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
      - echo "netcdf-c installation job"
      - NC_INSTALL_PREFIX=${CI_PROJECT_DIR}/${NC_INSTALL_PREFIX}
      - NC_C_BUILD_DIR=${CI_PROJECT_DIR}/${NC_C_BUILD_DIR}
      - |
        if "${NC_INSTALL_PREFIX}/bin/nc-config" --version >& /dev/null && test "${MBD_CLEAN_ALL}" = "no"; then
          echo "netcdf-c was already installed"
          exit 0
        fi
      - |
        if ! test -d ${NC_C_BUILD_DIR}; then
          git clone -b main https://github.com/Unidata/netcdf-c.git ${NC_C_BUILD_DIR}
        fi
      - cd ${NC_C_BUILD_DIR}
      - git pull --force
      - |
        if ! test -d build_dir; then
          mkdir build_dir
        fi
      - cd build_dir
      - |
        if ! test -f Makefile; then
          cmake .. -DENABLE_NETCDF_4=ON -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX="${NC_INSTALL_PREFIX}"
        fi
      - make -j${MBD_NUM_BUILD_JOBS}
      - rm -rf "${NC_INSTALL_PREFIX}"
      - make install
  artifacts:
    name: netcdf-binaries
    expire_in: 2 weeks
    paths:
      - $NC_INSTALL_PREFIX
  cache:
   key: libraries-build-job
   paths:
    - $NC_C_BUILD_DIR

netcdf-cxx4-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  needs:
    - job: netcdf-c-build-job
      artifacts: true
  script:
      - echo "netcdf-cxx4 installation job"
      - NC_INSTALL_PREFIX=${CI_PROJECT_DIR}/${NC_INSTALL_PREFIX}
      - NC_CXX4_INSTALL_PREFIX=${CI_PROJECT_DIR}/${NC_CXX4_INSTALL_PREFIX}
      - NC_CXX4_BUILD_DIR=${CI_PROJECT_DIR}/${NC_CXX4_BUILD_DIR}
      - |
        if "${NC_CXX4_INSTALL_PREFIX}/bin/ncxx4-config" --version >& /dev/null && test "${MBD_CLEAN_ALL}" = "no"; then
          echo "netcdf-cxx4 was already installed"
          exit 0
        fi
      - |
        if ! test -d ${NC_CXX4_BUILD_DIR}; then
          git clone -b master https://github.com/Unidata/netcdf-cxx4.git ${NC_CXX4_BUILD_DIR}
        fi
      - cd ${NC_CXX4_BUILD_DIR}
      - git pull --force
      - |
        if ! test -d build_dir; then
          mkdir build_dir
        fi
      - cd build_dir
      - |
        if ! test -f Makefile; then
          cmake .. -DENABLE_NETCDF_4=ON -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX="${NC_CXX4_INSTALL_PREFIX}" -DnetCDF_DIR="${NC_INSTALL_PREFIX}/lib/cmake/netCDF"
        fi
      - make -j${MBD_NUM_BUILD_JOBS}
      - rm -rf "${NC_CXX4_INSTALL_PREFIX}"
      - make install
  artifacts:
    name: netcdf-cxx4-binaries
    expire_in: 1 hour    
    paths:
      - $NC_CXX4_INSTALL_PREFIX
  cache:
   key: libraries-build-job
   paths:
    - $NC_CXX4_BUILD_DIR
