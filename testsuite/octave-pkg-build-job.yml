# MBDyn (C) is a multibody analysis code.
# http://www.mbdyn.org
#
# Copyright (C) 1996-2023
#
# Pierangelo Masarati	<pierangelo.masarati@polimi.it>
# Paolo Mantegazza	<paolo.mantegazza@polimi.it>
#
# Dipartimento di Ingegneria Aerospaziale - Politecnico di Milano
# via La Masa, 34 - 20156 Milano, Italy
# http://www.aero.polimi.it
#
# Changing this copyright notice is forbidden.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation (version 2 of the License).
#
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

# AUTHOR: Reinhard Resch <mbdyn-user@a1.net>
# Copyright (C) 2023(-2023) all rights reserved.

# The copyright of this code is transferred
# to Pierangelo Masarati and Paolo Mantegazza
# for use in the software MBDyn as described
# in the GNU Public License version 2.1

octave-pkg-build-job:       # This job runs in the build stage, which runs first.
  stage: build
  needs:
      - job: mkl-build-job
      - job: netcdf-c-build-job
        artifacts: true
      - job: netcdf-cxx4-build-job
        artifacts: true
      - job: nlopt-build-job
        artifacts: true
      - job: mbdyn-build-job
        artifacts: true
  script:
        - MKL_INSTALL_PREFIX=${HOME}/${MKL_INSTALL_PREFIX}
        - NL_INSTALL_PREFIX=${CI_PROJECT_DIR}/${NL_INSTALL_PREFIX}
        - NC_INSTALL_PREFIX=${CI_PROJECT_DIR}/${NC_INSTALL_PREFIX}
        - OCT_PKG_BUILD_DIR=${CI_PROJECT_DIR}/${OCT_PKG_BUILD_DIR}
        - OCT_PKG_INSTALL_PREFIX=${CI_PROJECT_DIR}/${OCT_PKG_INSTALL_PREFIX}
        - mkdir -p "${OCT_PKG_INSTALL_PREFIX}"
        - mkdir -p "${OCT_PKG_BUILD_DIR}"
        - OCT_PKG_BINARY_DIR="${OCT_PKG_BUILD_DIR}/binary-packages"
        - mkdir -p "${OCT_PKG_BINARY_DIR}"
        - echo "octave packages installation job"
        - echo "Detecting MKL ..."
        - |
          if test -d "${MKL_INSTALL_PREFIX}"; then
              echo "Search for ${MKL_PKG_CONFIG}.pc ..."
              MKL_PKG_CONFIG_FILE=`find "${MKL_INSTALL_PREFIX}" '(' -type f -and -name "${MKL_PKG_CONFIG}.pc" ')'`
              if test -f "${MKL_PKG_CONFIG_FILE}"; then
                  MKL_PKG_CONFIG_PATH=`dirname "${MKL_PKG_CONFIG_FILE}"`
                  echo "MKL_PKG_CONFIG_PATH=${MKL_PKG_CONFIG_PATH}"
              else
                  echo "File ${MKL_PKG_CONFIG}.pc not found"
              fi
          fi
        - |
            if test -d "${MKL_PKG_CONFIG_PATH}"; then
                export PKG_CONFIG_PATH="${MKL_PKG_CONFIG_PATH}:${PKG_CONFIG_PATH}"
                if pkg-config --validate "${MKL_PKG_CONFIG}"; then
                  export PARDISO_INC=`pkg-config --cflags ${MKL_PKG_CONFIG}`
                  export PARDISO_LIBS=`pkg-config --libs ${MKL_PKG_CONFIG}`
                  export PARDISO_LIBS="${PARDISO_LIBS} `pkg-config --libs-only-L ${MKL_PKG_CONFIG} | sed  's/^-L\//-Wl,-rpath=\//g'`"
                else
                  echo "Warning: MKL pkg-config ${MKL_PKG_CONFIG} is not valid"
                fi
            else
                echo "Warning: MKL_PKG_CONFIG_PATH does not exist"
            fi
        - |
          NL_PKG_CONFIG_PATH=`find ${NL_INSTALL_PREFIX} '(' -type d -and -name pkgconfig ')'`
          if ! test -z "${NL_PKG_CONFIG_PATH}"; then
            export PKG_CONFIG_PATH="${NL_PKG_CONFIG_PATH}:${PKG_CONFIG_PATH}"
            export NLOPT_LIBS=`pkg-config --libs nlopt`
            export NLOPT_INC=`pkg-config --cflags nlopt`
            NL_LIBDIR=`pkg-config --variable=libdir nlopt`
            if ! test -z "${NL_LIBDIR}"; then
                NLOPT_LIBS="${NLOPT_LIBS} -Wl,-rpath=${NL_LIBDIR}"
            fi
          fi
        - |
          if "${NC_INSTALL_PREFIX}/bin/nc-config" --version >& /dev/null; then
            NC_PKG_CONFIG_PATH=`find ${NC_INSTALL_PREFIX} '(' -type d -and -name pkgconfig ')'`
            if ! test -z "${NC_PKG_CONFIG_PATH}"; then
              export PKG_CONFIG_PATH="${NC_PKG_CONFIG_PATH}:${PKG_CONFIG_PATH}"
            fi
            export PATH="${NC_INSTALL_PREFIX}/bin:${PATH}"
          fi
        - echo PKG_CONFIG_PATH="${PKG_CONFIG_PATH}"
        - echo NLOPT_LIBS="${NLOPT_LIBS}"
        - echo NLOPT_INC="${NLOPT_INC}"
        - echo PARDISO_LIBS="${PARDISO_LIBS}"
        - echo PARDISO_INC="${PARDISO_INC}"
        - cd "${OCT_PKG_BUILD_DIR}"
        - |
          for pkgname_and_flags in ${OCT_PKG_LIST}; do
              pkgname=$(echo ${pkgname_and_flags} | awk -F ":" "{print \$1}")
              pkg_rebuild_flag=$(echo ${pkgname_and_flags} | awk -F ":" "{print \$2}")
              pkg_branch=$(echo ${pkgname_and_flags} | awk -F ":" "{print \$3}")
              printf "build package \"%s\" branch \"%s\"\n" "${pkgname}" "${pkg_branch}"

              case "${pkg_rebuild_flag}" in
                  yes|no)
                      ;;
                  *)
                      pkg_rebuild_flag="no"
                      ;;
              esac


              if test -z "${pkg_branch}"; then
                  pkg_branch="master"
              fi

              OCTAVE_CMD=$(printf 'pkg("local_list","%s");pkg("load","%s");' "${OCT_PKG_INSTALL_PREFIX}/octave_packages" "${pkgname}")

              if test "${pkg_rebuild_flag}" = "no" -a "${MBD_CLEAN_ALL}" = "no"; then
                  echo ${OCTAVE_EXEC} -qfH --eval ${OCTAVE_CMD}
                  if ${OCTAVE_EXEC} -qfH --eval "${OCTAVE_CMD}"; then
                      printf "installation of \"%s\" will be skipped, because the package is already installed\n" "${pkgname}"
                      continue
                  else
                      printf "package \"%s\" is not installed\n" "${pkgname}"
                  fi
              fi

              OCTAVE_CMD=$(printf 'pkg("local_list","%s");pkg("uninstall","-nodeps","-local","-verbose","%s");' "${OCT_PKG_INSTALL_PREFIX}/octave_packages" "${pkgname}")

              echo ${OCTAVE_EXEC} -qfH --eval "${OCTAVE_CMD}"

              # Force a new installation
              if ! ${OCTAVE_EXEC} -qfH --eval "${OCTAVE_CMD}"; then
                  printf "Warning: failed to uninstall package \"%s\"\n" "${pkgname}"
              fi

              case "${pkgname}" in
                  mboct-*-pkg)
                      if ! test -d "${pkgname}"; then
                          if ! git clone -b "${pkg_branch}" -- "https://github.com/octave-user/${pkgname}.git" "${pkgname}"; then
                              printf "failed to clone package \"%s\" from github.com\n" "${pkgname}"
                              exit 1
                          fi
                      fi

                      if ! test -d "${pkgname}"; then
                          printf "package \"%s\" not found!\n" "${pkgname}"
                          exit 1
                      fi

                      if ! cd "${pkgname}"; then
                         exit 1
                      fi

                      if ! git checkout "${pkg_branch}" --force; then
                          exit 1
                      fi

                      if ! git pull --force; then
                          exit 1
                      fi

                      if ! cd ..; then
                        exit 1
                      fi

                      pkg_tar_file_binary=$(find "${OCT_PKG_BINARY_DIR}" -name "${pkgname}*.tar.gz" | tail -n1)

                      if ! test -f "${pkg_tar_file_binary}" || test "${pkg_rebuild_flag}" == "yes"; then
                          if ! make -C "${pkgname}" dist; then
                              printf "failed to build package \"%s\"\n" "${pkgname}"
                              exit 1
                          fi

                          if ! test -d "${pkgname}"; then
                              exit 1
                          fi

                          pkg_tar_file=$(find "${pkgname}" '(' -type f -and -path "*/target/${pkgname}*.tar.gz" ')')

                          if ! test -f "${pkg_tar_file}"; then
                              printf "failed to create the package file \"%s\"\n" "${pkgname}"
                              exit 1
                          fi

                          OCTAVE_CMD=$(printf 'pkg("prefix","%s","%s");pkg("local_list","%s");pkg("build","-nodeps","-verbose","%s","%s");' "${OCT_PKG_INSTALL_PREFIX}" "${OCT_PKG_INSTALL_PREFIX}" "${OCT_PKG_INSTALL_PREFIX}/octave_packages" "${OCT_PKG_BINARY_DIR}" "${pkg_tar_file}")

                          echo ${OCTAVE_EXEC} --eval "${OCTAVE_CMD}"

                          CXXFLAGS="${MBD_COMPILER_FLAGS}" ${OCTAVE_EXEC} --eval "${OCTAVE_CMD}"

                          if test $? != 0; then
                              printf "failed to build binary package \"%s\"\n" "${pkgname}"
                              exit 1
                          fi

                          pkg_tar_file_binary=$(find "${OCT_PKG_BINARY_DIR}" -name "${pkgname}*.tar.gz" | tail -n1)

                          if ! test -f "${pkg_tar_file_binary}"; then
                              printf "binary package \"%s\" not found\n" "${pkgname}"
                              exit 1
                          fi
                      fi

                      OCTAVE_CMD=$(printf 'pkg("prefix","%s","%s");pkg("local_list","%s");pkg("install","-local","-verbose","%s");' "${OCT_PKG_INSTALL_PREFIX}" "${OCT_PKG_INSTALL_PREFIX}" "${OCT_PKG_INSTALL_PREFIX}/octave_packages" "${pkg_tar_file_binary}")

                      echo "Installing binary package ..."
                      echo ${OCTAVE_EXEC} --eval "${OCTAVE_CMD}"

                      if ! ${OCTAVE_EXEC} --eval "${OCTAVE_CMD}"; then
                          printf "failed to install binary package \"%s\"\n" "${pkg_tar_file_binary}"
                          exit 1
                      fi

                      case "${pkgname}" in
                      mboct-fem-pkg)
                          ## FIXME: Need to install fem_pre_mesh_size since octave's package manager does not run "make install"

                          mkdir -p "${OCT_PKG_INSTALL_PREFIX}/bin"
                          if ! cd "${pkgname}/src"; then
                              echo "Directory src not found"
                              exit 1
                          fi
                          if ! test -x configure; then
                            chmod u+x bootstrap
                            ./bootstrap
                          fi
                          if ! test -f Makefile; then
                            if ! ./configure CXXFLAGS="${MBD_COMPILER_FLAGS}" --prefix="${OCT_PKG_INSTALL_PREFIX}"; then
                              echo "configure failed"
                              exit 1
                            fi
                          fi

                          ## No need to recompile the whole package!
                          if ! make fem_pre_mesh_size; then
                              echo "Failed to build fem_pre_mesh_size"
                              exit 1
                          fi

                          if ! install fem_pre_mesh_size "${OCT_PKG_INSTALL_PREFIX}/bin"; then
                              echo "Failed to install fem_pre_mesh_size"
                              exit 1
                          fi
                          if ! cd ..; then
                              echo "Directory is not valid"
                              exit 1
                          fi
                          ;;
                      esac
                      ;;
                  *)
                      SAVE_LDFLAGS=""

                      case "${pkgname}" in
                          netcdf)
                              SAVE_LDFLAGS="${LDFLAGS}"
                              export LDFLAGS="-Wl,-rpath=`${NC_INSTALL_PREFIX}/bin/nc-config --libdir`"
                              ;;
                      esac

                      # Assume that the package is hosted at octave-forge
                      OCTAVE_CMD=$(printf 'pkg("prefix","%s","%s");pkg("local_list","%s");pkg("install","-local","-verbose","-forge","%s");' "${OCT_PKG_INSTALL_PREFIX}" "${OCT_PKG_INSTALL_PREFIX}" "${OCT_PKG_INSTALL_PREFIX}/octave_packages" "${pkgname}")

                      echo ${OCTAVE_EXEC} --eval "${OCTAVE_CMD}"
                      if ! ${OCTAVE_EXEC} -qfH --eval "${OCTAVE_CMD}"; then
                          printf "failed to install package \"%s\" from octave-forge\n" "${pkgname}"
                          exit 1
                      fi

                      export LDFLAGS="${SAVE_LDFLAGS}"
                      ;;
              esac

              OCTAVE_CMD=$(printf 'pkg("local_list","%s");pkg("list");pkg("load","%s");' "${OCT_PKG_INSTALL_PREFIX}/octave_packages" "${pkgname}")

              echo ${OCTAVE_EXEC} -qfH --eval "${OCTAVE_CMD}"

              if ${OCTAVE_EXEC} -qfH --eval "${OCTAVE_CMD}"; then
                  printf "package \"%s\" was loaded successfully\n" "${pkgname}"
              else
                  printf "failed to load package \"%s\"\n" "${pkgname}"
                  exit 1
              fi
          done
  artifacts:
   name: octave-pkg-install-prefix
   expire_in: 24h
   paths:
     - $OCT_PKG_INSTALL_PREFIX
  cache:
    key: octave-pkg-build-job
    paths:
     - $OCT_PKG_BUILD_DIR
