mbdyn-tests-private-test-job:   # This job runs in the test stage.
  variables:
     ## Error codes which should not cause the pipeline to fail:
     ## - timeout                    (0x2)
     ## - module not found           (0x4)
     ## - loadable element not found (0x8)
     ## - test failed with status 1  (0x10)
     MBD_TESTS_PRIVATE_EXIT_STATUS_MASK: "0x1E" ## FIXME: We need to check how many failed tests we have, and which tests actually failed.
     ## Timeout per model (by default in minutes, "s" for seconds, "m" for minutes "h" for hours)
     ## Timeout value should not be "unlimited" if we are testing models which are using sockets, because this might block our pipeline forever!
     ## Actually the overall timeout of 12 hours per job must be considered.
     MBD_TESTS_PRIVATE_TIMEOUT: "30s"
  stage: test    # It only starts when the job in the build stage completes successfully.
  needs:
     - job: mkl-build-job
       artifacts: true
     - job: netcdf-c-build-job
       artifacts: true
     - job: netcdf-cxx4-build-job
       artifacts: true
     - job: mbdyn-build-job
       artifacts: true
  script:
      - MBD_INSTALL_PREFIX=${CI_PROJECT_DIR}/${MBD_INSTALL_PREFIX}
      - OCT_PKG_INSTALL_PREFIX=${CI_PROJECT_DIR}/${OCT_PKG_INSTALL_PREFIX}
      - GMSH_INSTALL_PREFIX=${CI_PROJECT_DIR}/${GMSH_INSTALL_PREFIX}
      - MBD_TESTS_PRIVATE_OUTPUT_DIR=${CI_PROJECT_DIR}/${MBD_TESTS_PRIVATE_OUTPUT_DIR}
      - MBD_TESTS_PRIVATE_INPUT_DIR=${CI_PROJECT_DIR}/${MBD_TESTS_PRIVATE_INPUT_DIR}
      - echo "mbdyn-tests-private test job"
      - export PATH=${MBD_INSTALL_PREFIX}/bin:${GMSH_INSTALL_PREFIX}/bin:${OCT_PKG_INSTALL_PREFIX}/bin:${PATH}
      - export AWKPATH=${MBD_INSTALL_PREFIX}/share/awk:${AWKPATH}
      - mkdir -p "${MBD_TESTS_PRIVATE_OUTPUT_DIR}" ## needed for realpath
      - log_file="${MBD_TESTS_PRIVATE_OUTPUT_DIR}/mbdyn-tests-private-test-job.log"
      - |
        if test -z "${MBD_TESTS_PRIVATE_GITLAB}"; then
          echo "Because MBD_TESTS_PRIVATE_GITLAB was not defined in gitlab, no tests will be executed!" | tee "${log_file}"
          exit 0
        fi
      - |
        if ! test -d ${MBD_TESTS_PRIVATE_INPUT_DIR}; then
          if ! git clone ${MBD_TESTS_PRIVATE_GITLAB} ${MBD_TESTS_PRIVATE_INPUT_DIR}; then
            echo "${MBD_TESTS_PRIVATE_GITLAB} is not accessible" | tee "${log_file}"
            exit 1
          fi
        fi
      - test -d ${MBD_TESTS_PRIVATE_INPUT_DIR}
      - curr_dir=$(pwd)
      - cd ${MBD_TESTS_PRIVATE_INPUT_DIR}
      - git pull --force
      - cd ${curr_dir}
      - chmod +x testsuite/simple_testsuite.sh
        ## FIXME: It seems that everything must be on one long line ...
      - testsuite/simple_testsuite.sh --exit-status-mask "${MBD_TESTS_PRIVATE_EXIT_STATUS_MASK}" --timeout "${MBD_TESTS_PRIVATE_TIMEOUT}" --prefix-output "${MBD_TESTS_PRIVATE_OUTPUT_DIR}" --prefix-input "${MBD_TESTS_PRIVATE_INPUT_DIR}" ${MBD_SIMPLE_TESTSUITE_FLAGS} 2>&1 | tee "${log_file}"
  artifacts:
    name: mbdyn-tests-private-test-job
    expire_in: 2 days
    paths:
      - $MBD_TESTS_PRIVATE_OUTPUT_DIR/mbdyn-tests-private-test-job.log
      - $MBD_TESTS_PRIVATE_OUTPUT_DIR/*_mbdyn_output.stdout
